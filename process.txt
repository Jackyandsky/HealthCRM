This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2025-05-24T01:32:09.491Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repopack, visit: https://github.com/yamadashy/repopack

================================================================
Repository Structure
================================================================
.eslintrc.json
.gitignore
description.txt
edit.txt
extend.txt
install.bat
next.config.js
package.json
postcss.config.js
README.md
scripts/fix-passwords-real.js
scripts/fix-passwords.js
scripts/seed.js
scripts/test-passwords.js
src/app/api/auth/login/route.ts
src/app/api/customers/[id]/route.ts
src/app/api/customers/route.ts
src/app/api/dashboard/stats/route.ts
src/app/api/patients/[id]/route.ts
src/app/api/patients/route.ts
src/app/api/test/route.ts
src/app/api/users/route.ts
src/app/auth/login/page.tsx
src/app/dashboard/customers/new/page.tsx
src/app/dashboard/customers/page.tsx
src/app/dashboard/page.tsx
src/app/dashboard/patients/new/page.tsx
src/app/dashboard/patients/page.tsx
src/app/dashboard/users/page.tsx
src/app/globals.css
src/app/layout.tsx
src/app/page.tsx
src/lib/auth.ts
src/lib/mongodb.ts
src/lib/types.ts
src/models/Appointment.ts
src/models/Billing.ts
src/models/Customer.ts
src/models/MedicalRecord.ts
src/models/Patient.ts
src/models/Product.ts
src/models/User.ts
start.bat
tailwind.config.js
test-guide.bat
tsconfig.json

================================================================
Repository Files
================================================================

================
File: .eslintrc.json
================
{
  "extends": ["next/core-web-vitals"]
}

================
File: .gitignore
================
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js
.yarn/install-state.gz

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# IDEs
.vscode/
.idea/
*.swp
*.swo

# Logs
logs
*.log

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/

# nyc test coverage
.nyc_output

# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env
.env.test
.env.production

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# next.js build output
.next

# nuxt.js build output
.nuxt

# vuepress build output
.vuepress/dist

# Serverless directories
.serverless

# FuseBox cache
.fusebox/

# DynamoDB Local files
.dynamodb/

# TernJS port file
.tern-port
process.txt
package-lock.json

================
File: description.txt
================
1.æœ¬é¡¹ç›®æ—¨åœ¨å¸®åŠ©ç”¨æˆ·ç®¡ç†è‡ªå·±çš„å®¢æˆ·ï¼Œå®¢æˆ·ä¿¡æ¯ç®¡ç†ï¼Œå®¢æˆ·è´­ä¹°è®°å½•ç®¡ç†ï¼Œå•†å“ç®¡ç†ï¼ˆä¿å¥å“ å“ç‰Œï¼šusanaï¼‰ï¼Œæœè¯planç®¡ç†ï¼Œå®šæœŸå¯¹å®¢æˆ·åé¦ˆè®°å½•ï¼Œtimelineï¼ˆè´­ä¹°è®°å½•ï¼Œä¿å¥å“ä½¿ç”¨åé¦ˆè®°å½•ï¼‰æŸ¥çœ‹ã€‚å®Œæˆä»¥ä¸ŠåŠŸèƒ½ç›®çš„æ˜¯ä¸ºæŒæ¡ç”¨æˆ·çš„å¥åº·çŠ¶å†µä»¥åŠæ¶ˆè´¹æ½œåŠ›è¯„ä¼°ï¼Œæ¯”å¦‚å¯ä»¥è®¾å®šè¯ä¸¸æ•°ä½äº10%æç¤ºï¼Œæˆ–è€…å®¢æˆ·æ¯æœˆå›è®¿çš„æç¤º.
2.ä»ªè¡¨ç›˜ï¼Œå¯ä»¥æŸ¥çœ‹é”€å”®è®°å½•ï¼Œå®¢æˆ·æ•°ï¼Œæ–°å¢å®¢æˆ·æ•°ï¼Œè¯ä¸¸å‰©ä½™é¢„è­¦å®¢æˆ·åˆ—è¡¨ï¼Œæ¯”å¦‚ä½äº20%çš„å‰5ä¸ªç”¨æˆ·ï¼ŒæŒ‰ç™¾åˆ†æ¯”å°åˆ°å¤§æ’åºã€‚è·ç¦»ä¸Šæ¬¡å›è®¿è®°å½•åˆ°ç›®å‰æœªå›è®¿çš„ç”¨æˆ·åˆ—è¡¨ï¼Œæ—¶é—´è·¨åº¦å¤§åˆ°å°æ’åº.ä»¥åŠè·Ÿè¥é”€ç›¸å…³çš„æ•°æ®æ›²çº¿æˆ–è€…æŒ‡æ ‡.
3.å®¢æˆ·ä¿¡æ¯ç®¡ç†é¡µé¢ï¼Œæ—¨åœ¨ç”¨æˆ·å¯ä»¥å¯¹è‡ªå·±çš„å®¢æˆ·è¿›è¡Œcrudæ“çºµï¼Œå¯ä»¥åŠ¨æ€å¢åŠ åˆ†ç±»å’Œtagsï¼Œä¾¿äºæŸ¥æ‰¾ï¼Œæ”¯æŒfilterå’Œå„ç§å¿…è¦æ’åºï¼Œæ¯”å¦‚ä»ªè¡¨ç›˜çš„å‡ é¡¹é‡è¦æŒ‡æ ‡.
4.å•†å“ç®¡ç†ï¼Œç»´æŠ¤å•†å“çš„åŸºæœ¬ä¿¡æ¯ï¼Œå›¾ç‰‡å¯ä»¥å¼•ç”¨urlã€‚
5.planç®¡ç†ï¼Œå› ä¸ºæä¾›çš„äº§å“ä¸ºå¥åº·ç®¡ç†planï¼Œä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯packageï¼Œåˆ¶å®šä¸€ä¸ªplanï¼Œæœ‰é’ˆå¯¹ç”¨æˆ·çš„ç—‡çŠ¶ï¼Œæ¯”å¦‚è´«è¡€ï¼Œæ¯”å¦‚å…³èŠ‚ç—›ç±»ä¼¼çš„ï¼Œç„¶ååŒ…å«å“ªäº›äº§å“ï¼Œä»¥åŠæ¯ç§ä¿å¥å“çš„æœè¯é¢‘æ¬¡å®šä¹‰ã€‚è¿™æ˜¯ç”¨æˆ·å®šä¹‰çš„çœŸæ­£çš„é”€å”®ç»„åˆï¼Œå¥—é¤ï¼Œå¹¶éæ˜¯ç›´æ¥çš„å•†å“ï¼Œè€Œæ˜¯è¢«ç­–åˆ’è¿‡çš„æ ¹æ®ç”¨æˆ·ç‰¹å¾è€Œå®šä¹‰çš„planã€‚planå¯ä»¥åˆ†äº«è·Ÿå®¢æˆ·ï¼Œå®¢æˆ·å¯ä»¥çœ‹åˆ°è‡ªå·±è´­ä¹°çš„planï¼Œå¹¶ç”±æ ¹æ®æ—¶é—´æ¨æµ‹çš„usageç»Ÿè®¡ä¿¡æ¯.
6.å›è®¿è®°å½•ç®¡ç†ï¼Œè¿™é‡Œå¯¹è®°å½•äº†å¯¹å®¢æˆ·è¿›è¡Œçš„å›è®¿æ–‡æœ¬è®°å½•ï¼Œäº†è§£å®¢æˆ·çš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶åšæ–‡æœ¬è®°å½•. æ­¤é¡µé¢åº”è¯¥æœ‰ç”¨æˆ·åˆ—è¡¨ï¼Œå¯ä»¥çœ‹åˆ°è®°å½•çš„åˆ—è¡¨ï¼Œå¹¶ç»´æŠ¤.
7.æœ‰äº§å“çš„å±•ç¤ºé¡µé¢ï¼Œå¯ä»¥è¿›è¡Œåˆ†ç±»æœç´¢ï¼Œå…¬å¼€è®¿é—®ã€‚
8.ç”¨æˆ·ç®¡ç†è¡¨å¯ä»¥è·Ÿå®¢æˆ·è¡¨ä½¿ç”¨ä¸€ä¸ªè¡¨ï¼Œè§’è‰²åˆ†ä¸ºç³»ç»Ÿç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜ï¼ˆç”¨æˆ·ï¼‰ï¼Œå®¢æˆ·ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ›å»ºæ‰€æœ‰è§’è‰²ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿå…¼å®¹ç®¡ç†å‘˜è§’è‰²ï¼Œå®¢æˆ·å½’å±ç®¡ç†å‘˜orç³»ç»Ÿç®¡ç†å‘˜.
======
é¡¹ç›®ï¼šå®¢æˆ·å¥åº·ä¸æ¶ˆè´¹ç®¡ç†ç³»ç»Ÿ (USANA äº§å“)

ä¸€ã€æ ¸å¿ƒæ¨¡å—
    1. ä»ªè¡¨ç›˜ (Dashboard)
        - å…³é”®æŒ‡æ ‡æ±‡æ€» (é”€å”®é¢ã€å®¢æˆ·æ€»æ•°ã€æ–°å¢å®¢æˆ·æ•°)
        - é¢„è­¦ä¸­å¿ƒ
            - äº§å“ä½™é‡é¢„è­¦ (å¦‚ï¼šä½™é‡ < 20% çš„å‰5åå®¢æˆ·)
            - å®šæœŸå›è®¿é¢„è­¦ (å¦‚ï¼šè¶…è¿‡Xå¤©æœªå›è®¿å®¢æˆ·åˆ—è¡¨)
        - è¥é”€æ•°æ®æ´å¯Ÿ (å¦‚å›¾è¡¨ã€è¶‹åŠ¿çº¿)
        - å¾…åŠäº‹é¡¹æé†’ (å¦‚ï¼šä»Šæ—¥éœ€å›è®¿å®¢æˆ·)

    2. å®¢æˆ·ä¿¡æ¯ç®¡ç† (CRM)
        - å®¢æˆ·æ¡£æ¡ˆ (åŸºæœ¬ä¿¡æ¯ã€å¥åº·çŠ¶å†µã€è”ç³»æ–¹å¼)
            - CRUD (åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤)
            - åŠ¨æ€åˆ†ç±»ä¸æ ‡ç­¾ç®¡ç† (ä¾¿äºç­›é€‰ä¸åˆ†ç»„)
        - å®¢æˆ·ç­›é€‰ä¸æ’åº (æ”¯æŒå¤šç»´åº¦ï¼Œå¦‚æŒ‰é¢„è­¦æŒ‡æ ‡ã€è´­ä¹°åŠ›ã€æ´»è·ƒåº¦)
        - å®¢æˆ· Timeline è§†å›¾
            - è´­ä¹°è®°å½•æ—¶é—´è½´
            - æœç”¨è®¡åˆ’ä¸è°ƒæ•´å†å²
            - å¥åº·åé¦ˆä¸å›è®¿è®°å½•æ—¶é—´è½´

    3. å•†å“ç®¡ç† (USANA ä¿å¥å“)
        - å•†å“åŸºç¡€ä¿¡æ¯ (åç§°ã€å“ç‰Œã€è§„æ ¼ã€å•ä»·ã€åŠŸæ•ˆç®€è¿°)
        - å•†å“å›¾ç‰‡ (æ”¯æŒ URL å¼•ç”¨)
        - å•†å“åˆ†ç±»ç®¡ç†

    4. æœç”¨è®¡åˆ’ (Plan) ç®¡ç†
        - è®¡åˆ’æ¨¡æ¿åˆ›å»ºä¸ç®¡ç†
            - é’ˆå¯¹ç‰¹å®šå¥åº·ç›®æ ‡/ç—‡çŠ¶ (å¦‚ï¼šè´«è¡€æ”¹å–„è®¡åˆ’ã€å…³èŠ‚ç»´æŠ¤è®¡åˆ’)
            - åŒ…å«äº§å“ç»„åˆ (USANA äº§å“)
            - å®šä¹‰å„ç§äº§å“æœç”¨é¢‘æ¬¡ã€å‰‚é‡ã€å‘¨æœŸ
        - å®¢æˆ·ä¸ªæ€§åŒ–è®¡åˆ’å®šåˆ¶ä¸æŒ‡æ´¾
            - åŸºäºå®¢æˆ·å¥åº·çŠ¶å†µå’Œéœ€æ±‚è°ƒæ•´æ¨¡æ¿
        - è®¡åˆ’åˆ†äº«ä¸æŸ¥é˜…
            - ç®¡ç†å‘˜åˆ†äº«è®¡åˆ’ç»™å®¢æˆ·
            - å®¢æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¡åˆ’è¯¦æƒ…åŠé¢„æœŸæœç”¨è¿›åº¦

    5. è´­ä¹°è®°å½•ç®¡ç†
        - è®°å½•å®¢æˆ·è´­ä¹°çš„å•†å“/è®¡åˆ’
        - å…³è”å®¢æˆ·ã€å•†å“/è®¡åˆ’ã€è®¢å•æ—¶é—´ã€é‡‘é¢
        - æ”¯æŒæŒ‰æ—¶é—´ã€å®¢æˆ·ã€äº§å“ç­‰å¤šç»´åº¦æŸ¥è¯¢

    6. å›è®¿è®°å½•ç®¡ç†
        - è®°å½•ä¸å®¢æˆ·çš„æ²Ÿé€šè¯¦æƒ… (æ–‡æœ¬è®°å½•)
        - è¿½è¸ªå®¢æˆ·äº§å“ä½¿ç”¨åé¦ˆã€å¥åº·æ”¹å–„æƒ…å†µ
        - å…³è”å®¢æˆ·ä¸å›è®¿æ—¶é—´
        - æ”¯æŒæŸ¥çœ‹å®¢æˆ·å†å²å›è®¿åˆ—è¡¨

    7. å…¬å¼€äº§å“å±•ç¤ºé¡µ
        - USANA äº§å“åˆ—è¡¨å±•ç¤º (å¯¹å…¬ç½‘ç”¨æˆ·å¯è§)
        - äº§å“åˆ†ç±»æµè§ˆ
        - äº§å“æœç´¢åŠŸèƒ½
        - (å¯é€‰) äº§å“è¯¦æƒ…é¡µï¼Œå¼•å¯¼æ½œåœ¨å®¢æˆ·è”ç³»ç®¡ç†å‘˜

    8. ç”¨æˆ·ä¸æƒé™ç®¡ç†
        - è§’è‰²å®šä¹‰ï¼š
            - ç³»ç»Ÿç®¡ç†å‘˜ (Super Admin): æœ€é«˜æƒé™ï¼Œç®¡ç†æ‰€æœ‰æ•°æ®å’Œç”¨æˆ·ï¼Œå¯åˆ›å»ºå…¶ä»–è§’è‰²ã€‚
            - ç®¡ç†å‘˜ (Admin/User): è´Ÿè´£ç®¡ç†åä¸‹å®¢æˆ·ï¼ŒæŸ¥çœ‹é”€å”®æ•°æ®ï¼Œåˆ¶å®šè®¡åˆ’ç­‰ã€‚
            - å®¢æˆ· (Client): æŸ¥çœ‹ä¸ªäººä¿¡æ¯ã€è´­ä¹°è®°å½•ã€æœç”¨è®¡åˆ’ã€åé¦ˆã€‚
        - ç”¨æˆ·ä¿¡æ¯ç®¡ç† (ç»Ÿä¸€ç”¨æˆ·è¡¨ï¼Œé€šè¿‡è§’è‰²åŒºåˆ†)
        - æƒé™ç»†åˆ†ä¸æ§åˆ¶ (ç¡®ä¿æ•°æ®éš”ç¦»ä¸å®‰å…¨)
9.é›†æˆå¼€å‘ç¯å¢ƒ (IDE): VSCode
å¼ºå¤§çš„ä»£ç ç¼–è¾‘å™¨ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼Œä¸º JavaScriptã€Reactã€Node.js ç­‰æä¾›ä¼˜ç§€æ”¯æŒã€‚
æ ¸å¿ƒæ¡†æ¶: Next.js
åŸºäº React çš„ç”Ÿäº§çº§æ¡†æ¶ï¼Œå†…ç½®æ”¯æŒå‰ç«¯è·¯ç”±ã€åç«¯ API è·¯ç”± (Node.js ç¯å¢ƒ)ã€æœåŠ¡ç«¯æ¸²æŸ“ (SSR)ã€é™æ€ç«™ç‚¹ç”Ÿæˆ (SSG)ã€å›¾ç‰‡ä¼˜åŒ–ç­‰åŠŸèƒ½ã€‚å®ƒèƒ½ç®€åŒ–å…¨æ ˆåº”ç”¨çš„å¼€å‘ä¸éƒ¨ç½²ã€‚
UI ç»„ä»¶ä¸æ ·å¼: shadcn/ui (æ„å»ºäº Tailwind CSS å’Œ Radix UI ä¹‹ä¸Š)
æä¾›ä¸€ç»„è®¾è®¡ç²¾ç¾ã€é«˜åº¦å¯å®šåˆ¶ã€æ³¨é‡å¯è®¿é—®æ€§çš„ UI ç»„ä»¶ã€‚é€šè¿‡ç›´æ¥å°†ç»„ä»¶ä»£ç å¼•å…¥é¡¹ç›®å¹¶ä½¿ç”¨ Tailwind CSS è¿›è¡Œæ ·å¼åŒ–ï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºç°ä»£åŒ–ä¸”å“åº”å¼çš„ç”¨æˆ·ç•Œé¢ã€‚
æ•°æ®åº“: MongoDB Atlas
äº‘ç«¯æ‰˜ç®¡çš„ NoSQL æ–‡æ¡£æ•°æ®åº“æœåŠ¡ã€‚å…¶çµæ´»çš„æ¨¡å¼å’Œå¯æ‰©å±•æ€§éå¸¸é€‚åˆæ‚¨é¡¹ç›®çš„éœ€æ±‚ï¼Œå¹¶æä¾›å¯é çš„æ•°æ®å­˜å‚¨ã€‚å…è´¹å¥—é¤è¶³ä»¥æ”¯æŒé¡¹ç›®åˆæœŸã€‚
åç«¯é€»è¾‘: Next.js API Routes
åˆ©ç”¨ Next.js çš„å†…ç½®åŠŸèƒ½ï¼Œåœ¨ä¸å‰ç«¯ç›¸åŒçš„é¡¹ç›®ä¸­ä½¿ç”¨ Node.js ç¯å¢ƒåˆ›å»ºå’Œç®¡ç†åç«¯ API æ¥å£ï¼Œç®€åŒ–å¼€å‘æµç¨‹å’Œéƒ¨ç½²ã€‚


// MongoDB Atlas Schemas (Optimized)
// This file contains schema definitions for various collections.
// Remember to create the specified indexes in MongoDB Atlas for optimal query performance.

// --------------------------------------------------------------------------
// 1. `users` Collection Schema
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "name": "String", // User's full name, consider indexing if frequently searched
  "email": "String", // User's email address (store as lowercase for consistency)
  // Indexes: { "email": 1 (unique: true) }
  "phone": "String", // User's phone number (optional)
  // Indexes: { "phone": 1 (unique: true, sparse: true) } (if used for login/unique ID)
  "password_hash": "String", // Hashed password for security
  "role": "String", // User's role in the system
  // Enum: ["system_admin", "admin", "customer"]
  // Indexes: { "role": 1 }
  "managing_admin_id": "ObjectId()", // Reference to another user document (their managing admin)
  // Ref: "users" (where role is 'admin' or 'system_admin')
  // Indexes: { "managing_admin_id": 1, "sparse": true } (sparse if not all users have it)
  "tags": ["ObjectId()"], // Array of references to the 'tags' collection
  // Ref: "tags" (where type is 'user')
  "is_active": "Boolean", // Whether the user account is active or deactivated
  // Default: true
  // Indexes: { "is_active": 1 }
  "last_login_at": "ISODate()", // Timestamp of the last login (optional)
  "avatar_url": "String", // URL to the user's profile picture (optional)
  "address": { // Embedded document for address details (optional)
    "street": "String",
    "city": "String",
    "state_province": "String",
    "postal_code": "String",
    "country": "String"
  },
  "preferences": { // Embedded document for user-specific preferences (optional)
    "communication_prefs": {
      "email_notifications": "Boolean", // Default: true
      "sms_notifications": "Boolean"   // Default: false
    },
    "language": "String" // Default: "en" or "zh"
  },
  "other_info": "Object", // Flexible field for any other miscellaneous information
  "created_at": "ISODate()", // Timestamp of document creation (auto-set)
  "updated_at": "ISODate()"  // Timestamp of last document update (auto-set)
}
*/

// --------------------------------------------------------------------------
// 2. `tags` Collection Schema
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "name": "String", // Name of the tag (e.g., "High Value", "Follow-up Needed")
  "type": "String", // Type of entity this tag applies to
  // Enum: ["user", "product", "plan_template", "follow_up", "general"]
  // Indexes: { "name": 1, "type": 1 (unique: true) } (ensures name is unique per type)
  "created_by_admin_id": "ObjectId()", // Reference to the admin user who created the tag
  // Ref: "users"
  "created_at": "ISODate()", // Timestamp of document creation
  "updated_at": "ISODate()"  // Timestamp of last document update
}
*/

// --------------------------------------------------------------------------
// 3. `categories` Collection Schema
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "name": "String", // Name of the category (e.g., "Immune Support", "Joint Health")
  "slug": "String", // URL-friendly version of the name (e.g., "immune-support")
  // Indexes: { "slug": 1 (unique: true) }
  "description": "String", // Optional description for the category
  "parent_category_id": "ObjectId()", // Reference to a parent category for sub-categories (optional)
  // Ref: "categories"
  // Indexes: { "parent_category_id": 1 }
  "ancestor_ids": ["ObjectId()"], // Array of parent category ObjectIds, for easier tree traversal (optional)
  // Ref: "categories"
  // Indexes: { "ancestor_ids": 1 }
  "type": "String", // Type of items this category is for
  // Enum: ["product", "plan_template"]
  // Default: "product"
  // Indexes: { "type": 1 }
  // Consider a compound unique index if name should be unique within a type and parent:
  // Indexes: { "name": 1, "parent_category_id": 1, "type": 1 (unique: true) }
  "display_order": "NumberInt", // Optional field for sorting categories in display
  "icon_url": "String", // Optional URL for a category icon
  "created_at": "ISODate()",
  "updated_at": "ISODate()"
}
*/

// --------------------------------------------------------------------------
// 4. `products` Collection Schema (USANA Supplements)
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "name": "String", // Product name (e.g., "CellSentials Vita Antioxidant")
  // Indexes: { "name": "text" } (for full-text search), { "name": 1 } (for sorting/exact match)
  "brand": "String", // Brand of the product
  // Default: "USANA"
  // Indexes: { "brand": 1 }
  "sku": "String", // Stock Keeping Unit, unique identifier for the product (optional)
  // Indexes: { "sku": 1 (unique: true, sparse: true) }
  "description_short": "String", // Short description for list views (optional)
  "description_long": "String", // Detailed description for product page (optional)
  "category_id": "ObjectId()", // Reference to the 'categories' collection
  // Ref: "categories" (where type='product')
  // Indexes: { "category_id": 1 }
  "images": ["String"], // Array of URLs for product images (optional)
  "price": { // Embedded document for price information
    "amount": "NumberDecimal", // Price amount
    "currency": "String"      // Currency code (e.g., "USD", "CAD", "CNY")
  },
  "attributes": [{ // Array of product attributes (e.g., size, key ingredients)
    "key": "String",   // Attribute name (e.g., "Tablet Count")
    "value": "String"  // Attribute value (e.g., "112")
  }],
  "purchase_url": "String", // External URL to purchase the product, if applicable (optional)
  "is_publicly_visible": "Boolean", // Whether the product is visible on the public showcase page
  // Default: true
  // Indexes: { "is_publicly_visible": 1 }
  "stock_info": { // Information about central stock (optional, if not solely relying on client usage tracking)
      "quantity_on_hand": "NumberInt", // Current stock level
      "low_stock_threshold": "NumberInt" // Threshold for low stock warning
  },
  "default_dosage_unit": "String", // Default unit for dosage (e.g., "tablet", "scoop", "ml")
  "tags": ["ObjectId()"], // Array of references to the 'tags' collection
  // Ref: "tags" (where type='product')
  "related_product_ids": ["ObjectId()"], // Array of ObjectIds referencing other related products (optional)
  // Ref: "products"
  "created_by_admin_id": "ObjectId()", // Reference to the admin user who added the product
  // Ref: "users"
  "created_at": "ISODate()",
  "updated_at": "ISODate()"
}
*/

// --------------------------------------------------------------------------
// 5. `plan_templates` Collection Schema
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "name": "String", // Name of the plan template (e.g., "Standard Immune Boost Protocol")
  // Indexes: { "name": 1 (unique: true) }
  "description": "String", // Description of what the plan template is for (optional)
  "target_symptoms": ["String"], // Array of symptoms this plan aims to address (optional)
  // Indexes: { "target_symptoms": 1 }
  "intended_audience_tags": ["String"], // Descriptive tags for the target audience (e.g., "Adults", "Athletes") (optional)
  "category_id": "ObjectId()", // Reference to 'categories' for organizing plan templates (optional)
  // Ref: "categories" (where type='plan_template')
  "default_duration_days": "NumberInt", // Typical duration of the plan in days (optional)
  "items": [{ // Array of products and their usage instructions in this template
    "_id": "ObjectId()", // Auto-generated ID for this sub-document item
    "product_id": "ObjectId()", // Reference to the 'products' collection
    // Ref: "products"
    "product_name_snapshot": "String", // Denormalized product name (at the time of template creation)
    "default_dosage_amount": "NumberDecimal", // Default dosage amount
    "default_dosage_unit": "String", // Default dosage unit (e.g., "tablet")
    "default_frequency_value": "NumberInt", // E.g., 2 (for twice)
    "default_frequency_unit": "String", // E.g., "per_day", "per_week"
    "default_timing_instructions": "String", // E.g., "with meals", "morning" (optional)
    "default_item_duration_value": "NumberInt", // Duration for this specific item (optional)
    "default_item_duration_unit": "String", // Unit for item duration ("days", "weeks") (optional)
    "notes_for_admin": "String" // Internal notes for the admin when using this template (optional)
  }],
  "created_by_admin_id": "ObjectId()", // Reference to the admin user who created the template
  // Ref: "users"
  "is_sharable_globally": "Boolean", // Whether this template can be shared with/used by other admins (optional)
  // Default: false
  "tags": ["ObjectId()"], // Array of references to the 'tags' collection
  // Ref: "tags" (where type='plan_template')
  "version": "NumberInt", // Version number for the template
  // Default: 1
  "created_at": "ISODate()",
  "updated_at": "ISODate()"
}
*/

// --------------------------------------------------------------------------
// 6. `plans` Collection Schema (Client-Specific Assigned Plans)
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated for this specific client plan instance
  "customer_id": "ObjectId()", // Reference to the 'users' collection (the client)
  // Ref: "users" (where role='customer')
  // Indexes: { "customer_id": 1 }
  "assigned_by_admin_id": "ObjectId()", // Reference to the 'users' collection (the admin who assigned/manages this plan)
  // Ref: "users" (where role includes 'admin' or 'system_admin')
  // Indexes: { "assigned_by_admin_id": 1 }
  "plan_template_id": "ObjectId()", // Reference to the 'plan_templates' collection if derived from a template (optional)
  // Ref: "plan_templates"
  // Indexes: { "plan_template_id": 1 }
  "name": "String", // Name of this specific plan instance (e.g., "Jane Doe - Wellness Plan - Month 1")
  "description": "String", // Optional description or notes for this client's plan
  "target_symptoms": ["String"], // Symptoms this plan is addressing for this client (optional)
  "expected_outcome": "String", // Expected results for this client (optional)
  "start_date": "ISODate()", // Date the plan starts for the client
  // Indexes: { "start_date": 1 }
  "estimated_end_date": "ISODate()", // Calculated or manually set estimated end date (optional)
  // Indexes: { "estimated_end_date": 1 }
  "actual_end_date": "ISODate()", // Actual date the plan was completed or cancelled (optional)
  "status": "String", // Current status of the plan
  // Enum: ["active", "paused", "completed", "cancelled", "pending_review"]
  // Default: "active"
  // Indexes: { "status": 1 }
  "items": [{ // Array of products and their specific usage for this client's plan
    "_id": "ObjectId()", // Auto-generated ID for this sub-document item, crucial for linking with purchase_logs
    "product_id": "ObjectId()", // Reference to the 'products' collection
    // Ref: "products"
    "product_name_snapshot": "String", // Denormalized product name (at the time this plan item was set)
    "dosage_amount": "NumberDecimal", // Specific dosage amount for this client
    "dosage_unit": "String", // Specific dosage unit for this client
    "frequency_value": "NumberInt", // E.g., 1
    "frequency_unit": "String", // E.g., "per_day", "every_other_day"
    "timing_instructions": "String", // E.g., "before breakfast" (optional)
    "item_duration_value": "NumberInt", // Duration for this item in this plan (optional)
    "item_duration_unit": "String", // Unit for item duration ("days", "weeks") (optional)
    "item_start_date_offset_days": "NumberInt", // Offset in days from plan start_date for this item to begin
    // Default: 0
    "notes": "String" // Specific notes for this item for this client (optional)
  }],
  "total_estimated_cost": { // Optional calculated total cost for the plan
    "amount": "NumberDecimal",
    "currency": "String"
  },
  "last_consumption_calculation_at": "ISODate()", // Timestamp of the last time product consumption/remaining was calculated (optional)
  "progress_notes": "String", // General notes on the client's progress with this plan (optional)
  "created_at": "ISODate()",
  "updated_at": "ISODate()"
}
*/

// --------------------------------------------------------------------------
// 7. `purchase_logs` Collection Schema
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "customer_id": "ObjectId()", // Reference to the 'users' collection (the client who made the purchase)
  // Ref: "users" (where role='customer')
  // Indexes: { "customer_id": 1 }
  "logged_by_admin_id": "ObjectId()", // Reference to the admin who recorded the purchase, if applicable (optional)
  // Ref: "users" (where role includes 'admin' or 'system_admin')
  "order_reference_id": "String", // External order ID, if any (optional)
  // Indexes: { "order_reference_id": 1 (sparse: true) }
  "purchase_date": "ISODate()", // Date and time of the purchase
  // Default: now
  // Indexes: { "purchase_date": 1 }
  "total_amount": "NumberDecimal", // Total amount of the purchase
  "currency": "String", // Currency code (e.g., "USD", "CAD", "CNY")
  // Default: system default currency
  "payment_status": "String", // Status of the payment
  // Enum: ["paid", "pending", "refunded", "failed"]
  // Default: "paid"
  // Indexes: { "payment_status": 1 }
  "notes": "String", // Optional notes about the purchase
  "items": [{ // Array of items included in this purchase
    "_id": "ObjectId()", // Auto-generated ID for this sub-document item
    "product_id": "ObjectId()", // Reference to the 'products' collection
    // Ref: "products"
    "product_name_snapshot": "String", // Denormalized product name at the time of purchase
    "sku_snapshot": "String", // Denormalized SKU at the time of purchase (optional)
    "quantity": "NumberInt", // Quantity of this product purchased (Min: 1)
    "unit_price_snapshot": "NumberDecimal", // Price per unit at the time of purchase
    "total_item_price_snapshot": "NumberDecimal", // quantity * unit_price_snapshot
    "linked_plan_id": "ObjectId()", // Reference to the 'plans' collection if this purchase is related to a plan (optional)
    // Ref: "plans"
    // Indexes: { "items.linked_plan_id": 1 (sparse: true) }
    "linked_plan_item_id": "ObjectId()" // Reference to a specific item within the 'plans.items' array (optional)
    // This refers to `plans.items._id`
    // Indexes: { "items.linked_plan_item_id": 1 (sparse: true) }
  }],
  "created_at": "ISODate()",
  "updated_at": "ISODate()" // Purchase logs are generally immutable, but timestamp is good practice
}
*/

// --------------------------------------------------------------------------
// 8. `follow_ups` Collection Schema (Client Follow-up/Survey Records)
// --------------------------------------------------------------------------
/*
{
  "_id": "ObjectId()", // Primary Key, auto-generated
  "customer_id": "ObjectId()", // Reference to the 'users' collection (the client)
  // Ref: "users" (where role='customer')
  // Indexes: { "customer_id": 1 }
  "conducted_by_admin_id": "ObjectId()", // Reference to the admin who conducted the follow-up
  // Ref: "users" (where role includes 'admin' or 'system_admin')
  // Indexes: { "conducted_by_admin_id": 1 }
  "linked_plan_id": "ObjectId()", // Reference to the 'plans' collection if this follow-up is related to a specific plan (optional)
  // Ref: "plans"
  // Indexes: { "linked_plan_id": 1 }
  "follow_up_date": "ISODate()", // Date and time of the follow-up
  // Default: now
  // Indexes: { "follow_up_date": 1 }
  "communication_method": "String", // How the follow-up was conducted (optional)
  // Enum: ["phone", "email", "in_person", "video_call", "chat"]
  "title": "String", // Title or subject of the follow-up (optional)
  "summary": "String", // Brief summary of the follow-up interaction (optional)
  "details_log": [{ // Chronological log of the conversation or detailed notes
      "_id": "ObjectId()", // Auto-generated for each log entry
      "timestamp": "ISODate()", // Time of this specific entry
      // Default: now
      "author_role": "String", // "admin" or "customer" (if customer can contribute to log)
      "log_entry": "String" // The actual text of the communication
  }],
  "customer_feedback": { // Structured feedback from the customer
    "overall_satisfaction_rating": "NumberInt", // E.g., 1-5 (optional)
    "symptom_changes_reported": "String", // Customer's report on symptom changes (optional)
    "side_effects_reported": "String", // Any side effects reported by the customer (optional)
    "questions_or_concerns": "String" // Customer's questions or concerns (optional)
  },
  "admin_notes_observations": "String", // Admin's internal notes, observations, or assessment (optional)
  "action_items_next_steps": "String", // Any action items or next steps decided (optional)
  "tags": ["ObjectId()"], // Array of references to the 'tags' collection for categorizing follow-ups
  // Ref: "tags" (where type='follow_up')
  "attachments": [{ // Optional attachments related to the follow-up
      "file_name": "String",
      "file_url": "String", // URL to the stored file
      "uploaded_at": "ISODate()"
  }],
  "created_at": "ISODate()",
  "updated_at": "ISODate()"
}
*/

================
File: edit.txt
================
1.å®Œå–„å®¢æˆ·ç®¡ç†ç•Œé¢ï¼Œå®ç°æ–°å¢ç”¨æˆ·é¡µé¢ï¼Œæ ¹æ®é¡¹ç›®æè¿°æ–‡ä»¶é‡Œçš„æ•°æ®ç»“æ„ï¼Œé‡æ–°è°ƒæ•´å­—æ®µã€‚
2.å¢åŠ filteråŠŸèƒ½ï¼Œæ ¹æ®ç”¨æˆ·å­—æ®µè¿›è¡Œæ’åºï¼Œç‰¹åˆ«æ˜¯æ½œåœ¨çš„éœ€è¦å¯¹ç”¨æˆ·å›è®¿æ—¥æœŸï¼Œè¯é‡å‰©ä½™æ’åº.
3.å¢åˆ æ”¹åŠŸèƒ½å‡éœ€è¦éªŒè¯ï¼Œç›®å‰å¢åˆ æ”¹å‡ä¸å¯ç”¨.
4.åº”è¯¥åŠ å…¥åˆ†ç±»æŸ¥çœ‹åŠŸèƒ½ï¼ˆtabsï¼‰ï¼Œé»˜è®¤æ˜¯å®¢æˆ·ï¼Œå…¶ä»–è§’è‰²åŒ…æ‹¬ï¼Œç®¡ç†å‘˜ï¼Œç³»ç»Ÿç®¡ç†å‘˜å‡éœ€åˆ—å‡º.å¦‚æœå½“å‰ç™»å½•ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œç†è®ºä¸Šåªå¯¹ç³»ç»Ÿç®¡ç†å‘˜ä¿¡æ¯åªè¯»è®¿é—®.

1.æŒ‰ç…§é¡¹ç›®æè¿°æ¥ä¿®æ”¹å®¢æˆ·ç®¡ç†é¡µé¢ï¼Œè¯·æ³¨æ„è¿™ä¸ªé¡¹ç›®çš„å®šä½æ˜¯å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿï¼Œæ ¹æ®é¡¹ç›®æè¿°å¯ä»¥å¾—çŸ¥ï¼Œä½¿ç”¨è€…æ˜¯ä¿å¥å“é”€å”®äººå‘˜ï¼Œå»ºç«‹ç³»ç»Ÿçš„ç›®çš„æ˜¯æœ‰æ•ˆçš„ç®¡ç†ç”¨æˆ·çš„éœ€æ±‚ï¼Œå¯¹äºusanaä¿å¥å“çš„ä½¿ç”¨è¿›è¡Œè·Ÿè¸ªï¼Œä»¥ä¾¿é€šè¿‡æ•°æ®æ›´æœ‰æ•ˆçš„ä¿ƒè¿›é”€å”®. åŠŸèƒ½é¡µé¢ä¹Ÿéœ€å‚è€ƒé¡¹ç›®æè¿°. æ•°æ®ç»“æ„è¦ä¸¥æ ¼æŒ‰ç…§é¡¹ç›®æè¿°é‡Œé¢„å®šä¹‰çš„ç»“æ„æ¥æ‰§è¡Œï¼Œå› ä¸ºå·²ç»ç»è¿‡éªŒè¯æ˜¯æœ‰æ•ˆè€Œä¸”å®é™…çš„å®šä¹‰.

1.ç»§ç»­å®Œå–„ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œç”¨æˆ·tabså¯ä»¥åªåˆ†ä¸ºç®¡ç†å‘˜å’Œå®¢æˆ·ï¼Œç®¡ç†å‘˜åŒ…å«ç³»ç»Ÿç®¡ç†å‘˜å’Œç®¡ç†å‘˜. åˆ é™¤patient ç®¡ç†é¡µé¢.
2.åˆ é™¤é¢„çº¦ç®¡ç†ï¼Œè´¦å•ç®¡ç†ï¼ŒåŒ»ç–—è®°å½•ï¼Œæ‚£è€…ç®¡ç†ï¼Œdashboard å…¥å£.è¿™äº›åŠŸèƒ½åœ¨æˆ‘ä»¬çš„å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿé‡Œé¢ä¸å­˜åœ¨.
3.æŒ‰ç…§é¡¹ç›®æè¿°æŠŠæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½æ”¾ä¸Šï¼Œå¹¶æ ¹æ®è¯´æ˜å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ­£.
4.é¡¹ç›®æ ¹ç›®å½•
5.æœ¬åœ°æµè§ˆhttp://localhost:3000

================
File: extend.txt
================
äºŒã€æ ¸å¿ƒç›®æ ‡ä¸ä»·å€¼
    1. æå‡å®¢æˆ·å¥åº·ç®¡ç†æ°´å¹³
    2. ç²¾å‡†è¯„ä¼°ä¸æŒ–æ˜å®¢æˆ·æ¶ˆè´¹æ½œåŠ›
    3. æé«˜å®¢æˆ·ç²˜æ€§ä¸æ»¡æ„åº¦
    4. ä¼˜åŒ–è¥é”€ç­–ç•¥ä¸æ•ˆç‡
    5. å®ç°æ•°æ®é©±åŠ¨çš„å†³ç­–æ”¯æŒ
    6.å…¼å®¹ç§»åŠ¨ç«¯.
ä¸‰ã€è¡¥å……ä¸ä¼˜åŒ–å»ºè®®
    1. è‡ªåŠ¨åŒ–æé†’ä¸é€šçŸ¥ç³»ç»Ÿ (é‚®ä»¶ã€çŸ­ä¿¡ã€ç«™å†…ä¿¡)
    2. å®¢æˆ·å¥åº·ç›®æ ‡è®¾å®šä¸è¿½è¸ªæ¨¡å—
    3. çŸ¥è¯†åº“/å¥åº·èµ„è®¯æ¨¡å— (åˆ†äº«å¥åº·çŸ¥è¯†ï¼Œæå‡ä¸“ä¸šæ€§)
    4. ç®€å•çš„æŠ¥è¡¨ç”Ÿæˆä¸å¯¼å‡ºåŠŸèƒ½
    5. è€ƒè™‘ç§»åŠ¨ç«¯é€‚é…æˆ–å°ç¨‹åºå¼€å‘ï¼Œæ–¹ä¾¿ç®¡ç†å‘˜å’Œå®¢æˆ·éšæ—¶è®¿é—®
    6. æ•°æ®å¤‡ä»½ä¸æ¢å¤æœºåˆ¶

================
File: install.bat
================
@echo off
echo ğŸš€ Health CRM é¡¹ç›®å®‰è£…è„šæœ¬
echo =============================

echo.
echo ğŸ§¹ æ¸…ç†æ—§çš„ä¾èµ–...
if exist node_modules rmdir /s /q node_modules
if exist package-lock.json del package-lock.json

echo.
echo ğŸ“¦ å®‰è£…ä¾èµ–åŒ…...
call npm install

if %ERRORLEVEL% NEQ 0 (
    echo.
    echo âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ --legacy-peer-deps é€‰é¡¹...
    call npm install --legacy-peer-deps
)

echo.
echo ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“...
call npm run seed

echo.
echo âœ… å®‰è£…å®Œæˆï¼
echo.
echo ğŸ”¥ å¯åŠ¨å¼€å‘æœåŠ¡å™¨:
echo npm run dev
echo.
echo ğŸŒ ç„¶åè®¿é—®: http://localhost:3000
echo.
echo ğŸ‘¤ æµ‹è¯•è´¦æˆ·:
echo ç®¡ç†å‘˜: admin@healthcrm.com / admin123
echo åŒ»ç”Ÿ: dr.johnson@healthcrm.com / doctor123
echo æŠ¤å£«: nurse.wong@healthcrm.com / nurse123
echo å‰å°: receptionist@healthcrm.com / reception123
echo.
pause

================
File: next.config.js
================
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    appDir: true,
  },
  images: {
    domains: ['localhost'],
  },
}

module.exports = nextConfig

================
File: package.json
================
{
  "name": "health-crm",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "seed": "node scripts/seed.js"
  },
  "dependencies": {
    "next": "14.2.3",
    "react": "^18",
    "react-dom": "^18",
    "mongodb": "^5.9.0",
    "mongoose": "^8.3.2",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "tailwindcss": "^3.4.3",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "@tailwindcss/forms": "^0.5.7",
    "@heroicons/react": "^2.1.3",
    "react-hook-form": "^7.51.3",
    "date-fns": "^3.6.0",
    "recharts": "^2.12.6",
    "clsx": "^2.1.1"
  },
  "devDependencies": {
    "typescript": "^5",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "@types/bcryptjs": "^2.4.6",
    "@types/jsonwebtoken": "^9.0.6",
    "eslint": "^8",
    "eslint-config-next": "14.2.3"
  }
}

================
File: postcss.config.js
================
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================
File: README.md
================
# å®¢æˆ·å¥åº·ä¸æ¶ˆè´¹ç®¡ç†ç³»ç»Ÿ (USANA äº§å“)

ä¸€ä¸ªåŸºäºNext.jsã€MongoDB Atlasã€shadcn/ui å’Œ TypeScript æ„å»ºçš„ï¼Œä¸“æ³¨äºUSANAäº§å“å®¢æˆ·å¥åº·ä¸æ¶ˆè´¹ç®¡ç†çš„ç³»ç»Ÿã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒæ¨¡å—
-   **ä»ªè¡¨ç›˜ (Dashboard)** [cite: 1, 2]
    -   å…³é”®æŒ‡æ ‡æ±‡æ€» (é”€å”®é¢ã€å®¢æˆ·æ€»æ•°ã€æ–°å¢å®¢æˆ·æ•°) [cite: 1, 2]
    -   é¢„è­¦ä¸­å¿ƒ [cite: 1, 2]
        -   äº§å“ä½™é‡é¢„è­¦ (ä¾‹å¦‚ï¼šä½™é‡ < 20% çš„å‰5åå®¢æˆ·ï¼ŒæŒ‰ç™¾åˆ†æ¯”å°åˆ°å¤§æ’åº) [cite: 1, 2]
        -   å®šæœŸå›è®¿é¢„è­¦ (ä¾‹å¦‚ï¼šè·ç¦»ä¸Šæ¬¡å›è®¿è®°å½•åˆ°ç›®å‰æœªå›è®¿çš„ç”¨æˆ·åˆ—è¡¨ï¼Œæ—¶é—´è·¨åº¦å¤§åˆ°å°æ’åº) [cite: 1, 2]
    -   è¥é”€æ•°æ®æ´å¯Ÿ (å¦‚å›¾è¡¨ã€è¶‹åŠ¿çº¿) [cite: 1, 2]
    -   å¾…åŠäº‹é¡¹æé†’ (ä¾‹å¦‚ï¼šä»Šæ—¥éœ€å›è®¿å®¢æˆ·) [cite: 2]

-   **å®¢æˆ·ä¿¡æ¯ç®¡ç† (CRM)** [cite: 1, 2]
    -   å®¢æˆ·æ¡£æ¡ˆ (åŸºæœ¬ä¿¡æ¯ã€å¥åº·çŠ¶å†µã€è”ç³»æ–¹å¼) [cite: 2]
    -   CRUD (åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤) [cite: 1, 2]
    -   åŠ¨æ€åˆ†ç±»ä¸æ ‡ç­¾ç®¡ç† (ä¾¿äºç­›é€‰ä¸åˆ†ç»„) [cite: 1, 2]
    -   å®¢æˆ·ç­›é€‰ä¸æ’åº (æ”¯æŒå¤šç»´åº¦ï¼Œå¦‚æŒ‰é¢„è­¦æŒ‡æ ‡ã€è´­ä¹°åŠ›ã€æ´»è·ƒåº¦) [cite: 1, 2]
    -   å®¢æˆ· Timeline è§†å›¾ [cite: 1, 2]
        -   è´­ä¹°è®°å½•æ—¶é—´è½´ [cite: 1, 2]
        -   æœç”¨è®¡åˆ’ä¸è°ƒæ•´å†å² [cite: 1, 2]
        -   å¥åº·åé¦ˆä¸å›è®¿è®°å½•æ—¶é—´è½´ [cite: 1, 2]

-   **å•†å“ç®¡ç† (USANA ä¿å¥å“)** [cite: 1, 3]
    -   å•†å“åŸºç¡€ä¿¡æ¯ (åç§°ã€å“ç‰Œã€è§„æ ¼ã€å•ä»·ã€åŠŸæ•ˆç®€è¿°) [cite: 1, 3]
    -   å•†å“å›¾ç‰‡ (æ”¯æŒ URL å¼•ç”¨) [cite: 1, 3]
    -   å•†å“åˆ†ç±»ç®¡ç† [cite: 3]

-   **æœç”¨è®¡åˆ’ (Plan) ç®¡ç†** [cite: 1, 4]
    -   è®¡åˆ’æ¨¡æ¿åˆ›å»ºä¸ç®¡ç† [cite: 1, 4]
        -   é’ˆå¯¹ç‰¹å®šå¥åº·ç›®æ ‡/ç—‡çŠ¶ (å¦‚ï¼šè´«è¡€æ”¹å–„è®¡åˆ’ã€å…³èŠ‚ç»´æŠ¤è®¡åˆ’) [cite: 1, 4]
        -   åŒ…å«äº§å“ç»„åˆ (USANA äº§å“) [cite: 1, 4]
        -   å®šä¹‰å„ç§äº§å“æœç”¨é¢‘æ¬¡ã€å‰‚é‡ã€å‘¨æœŸ [cite: 1, 4]
    -   å®¢æˆ·ä¸ªæ€§åŒ–è®¡åˆ’å®šåˆ¶ä¸æŒ‡æ´¾ [cite: 4]
        -   åŸºäºå®¢æˆ·å¥åº·çŠ¶å†µå’Œéœ€æ±‚è°ƒæ•´æ¨¡æ¿ [cite: 4]
    -   è®¡åˆ’åˆ†äº«ä¸æŸ¥é˜… [cite: 1, 4]
        -   ç®¡ç†å‘˜åˆ†äº«è®¡åˆ’ç»™å®¢æˆ· [cite: 1, 4]
        -   å®¢æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¡åˆ’è¯¦æƒ…åŠé¢„æœŸæœç”¨è¿›åº¦ [cite: 1, 4]

-   **è´­ä¹°è®°å½•ç®¡ç†** [cite: 1, 5]
    -   è®°å½•å®¢æˆ·è´­ä¹°çš„å•†å“/è®¡åˆ’ [cite: 1, 5]
    -   å…³è”å®¢æˆ·ã€å•†å“/è®¡åˆ’ã€è®¢å•æ—¶é—´ã€é‡‘é¢ [cite: 1, 5]
    -   æ”¯æŒæŒ‰æ—¶é—´ã€å®¢æˆ·ã€äº§å“ç­‰å¤šç»´åº¦æŸ¥è¯¢ [cite: 5]

-   **å›è®¿è®°å½•ç®¡ç†** [cite: 1, 5]
    -   è®°å½•ä¸å®¢æˆ·çš„æ²Ÿé€šè¯¦æƒ… (æ–‡æœ¬è®°å½•) [cite: 1, 5]
    -   è¿½è¸ªå®¢æˆ·äº§å“ä½¿ç”¨åé¦ˆã€å¥åº·æ”¹å–„æƒ…å†µ [cite: 1, 5]
    -   å…³è”å®¢æˆ·ä¸å›è®¿æ—¶é—´ [cite: 5]
    -   æ”¯æŒæŸ¥çœ‹å®¢æˆ·å†å²å›è®¿åˆ—è¡¨ [cite: 1, 5]

-   **å…¬å¼€äº§å“å±•ç¤ºé¡µ** [cite: 1, 5]
    -   USANA äº§å“åˆ—è¡¨å±•ç¤º (å¯¹å…¬ç½‘ç”¨æˆ·å¯è§) [cite: 1, 5]
    -   äº§å“åˆ†ç±»æµè§ˆ [cite: 1, 5]
    -   äº§å“æœç´¢åŠŸèƒ½ [cite: 1, 5]
    -   (å¯é€‰) äº§å“è¯¦æƒ…é¡µï¼Œå¼•å¯¼æ½œåœ¨å®¢æˆ·è”ç³»ç®¡ç†å‘˜ [cite: 5]

-   **ç”¨æˆ·ä¸æƒé™ç®¡ç†** [cite: 1, 6]
    -   è§’è‰²å®šä¹‰ï¼š [cite: 1, 6]
        -   ç³»ç»Ÿç®¡ç†å‘˜ (Super Admin): æœ€é«˜æƒé™ï¼Œç®¡ç†æ‰€æœ‰æ•°æ®å’Œç”¨æˆ·ï¼Œå¯åˆ›å»ºå…¶ä»–è§’è‰²ã€‚ [cite: 1, 6]
        -   ç®¡ç†å‘˜ (Admin/User): è´Ÿè´£ç®¡ç†åä¸‹å®¢æˆ·ï¼ŒæŸ¥çœ‹é”€å”®æ•°æ®ï¼Œåˆ¶å®šè®¡åˆ’ç­‰ã€‚ [cite: 1, 6]
        -   å®¢æˆ· (Client): æŸ¥çœ‹ä¸ªäººä¿¡æ¯ã€è´­ä¹°è®°å½•ã€æœç”¨è®¡åˆ’ã€åé¦ˆã€‚ [cite: 1, 6]
    -   ç”¨æˆ·ä¿¡æ¯ç®¡ç† (ç»Ÿä¸€ç”¨æˆ·è¡¨ï¼Œé€šè¿‡è§’è‰²åŒºåˆ†) [cite: 1, 6]
    -   æƒé™ç»†åˆ†ä¸æ§åˆ¶ (ç¡®ä¿æ•°æ®éš”ç¦»ä¸å®‰å…¨) [cite: 6]

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

-   **é›†æˆå¼€å‘ç¯å¢ƒ (IDE):** VSCode [cite: 6]
-   **æ ¸å¿ƒæ¡†æ¶:** Next.js (åŸºäº React çš„ç”Ÿäº§çº§æ¡†æ¶ï¼Œå†…ç½®æ”¯æŒå‰ç«¯è·¯ç”±ã€åç«¯ API è·¯ç”± (Node.js ç¯å¢ƒ)ã€æœåŠ¡ç«¯æ¸²æŸ“ (SSR)ã€é™æ€ç«™ç‚¹ç”Ÿæˆ (SSG)ã€å›¾ç‰‡ä¼˜åŒ–ç­‰åŠŸèƒ½) [cite: 6]
-   **UI ç»„ä»¶ä¸æ ·å¼:** shadcn/ui (æ„å»ºäº Tailwind CSS å’Œ Radix UI ä¹‹ä¸Šï¼Œæä¾›è®¾è®¡ç²¾ç¾ã€é«˜åº¦å¯å®šåˆ¶ã€æ³¨é‡å¯è®¿é—®æ€§çš„ UI ç»„ä»¶) [cite: 6]
-   **æ•°æ®åº“:** MongoDB Atlas (äº‘ç«¯æ‰˜ç®¡çš„ NoSQL æ–‡æ¡£æ•°æ®åº“æœåŠ¡) [cite: 6]
-   **åç«¯é€»è¾‘:** Next.js API Routes (åœ¨ä¸å‰ç«¯ç›¸åŒçš„é¡¹ç›®ä¸­ä½¿ç”¨ Node.js ç¯å¢ƒåˆ›å»ºå’Œç®¡ç†åç«¯ API æ¥å£) [cite: 6]
-   **å¼€å‘å·¥å…· (æ¨è):** ESLint, PostCSS, TypeScript

## ğŸ“¦ å®‰è£…ä¸è¿è¡Œ

### ç¯å¢ƒè¦æ±‚
-   Node.js 18+
-   MongoDB Atlas æ•°æ®åº“ [cite: 6]

### å¿«é€Ÿå¼€å§‹

1.  **å…‹éš†é¡¹ç›®**
    ```bash
    git clone <repository-url>
    cd YourProjectName
    ```

2.  **å®‰è£…ä¾èµ–**
    ```bash
    npm install
    ```

3.  **ç¯å¢ƒé…ç½®**
    å¤åˆ¶ `.env.local.example` (å¦‚æœæä¾›) æˆ–åˆ›å»º `.env.local` æ–‡ä»¶å¹¶é…ç½®æ•°æ®åº“è¿æ¥ï¼š
    ```env
    MONGODB_URI=your-mongodb-atlas-connection-string # ä¾‹å¦‚: mongodb+srv://<user>:<password>@cluster.mongodb.net/your_db_name
    DB_NAME=your_db_name 
    NEXTAUTH_URL=http://localhost:3000 # (å¦‚æœä½¿ç”¨ NextAuth.js)
    NEXTAUTH_SECRET=your-nextauth-secret-key # (å¦‚æœä½¿ç”¨ NextAuth.js, ç”Ÿæˆä¸€ä¸ªå¼ºå¯†é’¥)
    ```

4.  **æ•°æ®åº“åˆå§‹åŒ– (å¯é€‰)**
    å¦‚æœé¡¹ç›®åŒ…å«ç§å­æ•°æ®è„šæœ¬ (ä¾‹å¦‚ `scripts/seed.js`):
    ```bash
    npm run seed
    ```

5.  **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
    ```bash
    npm run dev
    ```

6.  **è®¿é—®åº”ç”¨**
    æ‰“å¼€æµè§ˆå™¨è®¿é—® [http://localhost:3000](http://localhost:3000)

## ğŸ‘¥ ç”¨æˆ·è§’è‰²

ç³»ç»Ÿæ ¸å¿ƒç”¨æˆ·è§’è‰²åŒ…æ‹¬ï¼š[cite: 1]

| è§’è‰²           | æè¿°                                                                 |
|----------------|----------------------------------------------------------------------|
| ç³»ç»Ÿç®¡ç†å‘˜     | æœ€é«˜æƒé™ï¼Œç®¡ç†æ‰€æœ‰æ•°æ®å’Œç”¨æˆ·ï¼Œå¯åˆ›å»ºå…¶ä»–è§’è‰²ã€‚å…¼å®¹ç®¡ç†å‘˜è§’è‰²ã€‚                 |
| ç®¡ç†å‘˜ (ç”¨æˆ·)  | è´Ÿè´£ç®¡ç†åä¸‹å®¢æˆ·ï¼ŒæŸ¥çœ‹é”€å”®æ•°æ®ï¼Œåˆ¶å®šè®¡åˆ’ç­‰ã€‚å®¢æˆ·å½’å±ç®¡ç†å‘˜æˆ–ç³»ç»Ÿç®¡ç†å‘˜ã€‚ |
| å®¢æˆ·           | æŸ¥çœ‹ä¸ªäººä¿¡æ¯ã€è´­ä¹°è®°å½•ã€æœç”¨è®¡åˆ’ã€åé¦ˆã€‚                                 |

## ğŸ“ é¡¹ç›®ç»“æ„ (ç¤ºä¾‹)

HEALTHCRM/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                  # Next.js 14 App Router
â”‚   â”‚   â”œâ”€â”€ api/              # APIè·¯ç”± (åç«¯é€»è¾‘) 
â”‚   â”‚   â”œâ”€â”€ (auth)/           # è®¤è¯ç›¸å…³é¡µé¢ (ç¤ºä¾‹)
â”‚   â”‚   â”œâ”€â”€ (dashboard)/      # åº”ç”¨æ ¸å¿ƒé¡µé¢ (ç¤ºä¾‹)
â”‚   â”‚   â”œâ”€â”€ layout.tsx        # æ ¹å¸ƒå±€
â”‚   â”‚   â””â”€â”€ page.tsx          # é¦–é¡µ
â”‚   â”œâ”€â”€ components/           # å¯å¤ç”¨UIç»„ä»¶ (shadcn/ui ç»„ä»¶ç­‰) 
â”‚   â”‚   â””â”€â”€ ui/               # shadcn/ui ç”Ÿæˆçš„ç»„ä»¶ (æ ¹æ®å…¶æ¨èæ–¹å¼)
â”‚   â”œâ”€â”€ lib/                  # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ mongodb.ts        # MongoDB Atlas è¿æ¥ 
â”‚   â”‚   â””â”€â”€ utils.ts          # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ models/               # MongoDB æ•°æ®æ¨¡å‹ (Mongoose Schemas æˆ–æ¥å£å®šä¹‰)
â”‚       â”œâ”€â”€ User.ts           # ç”¨æˆ·æ¨¡å‹
â”‚       â”œâ”€â”€ Product.ts        # å•†å“æ¨¡å‹
â”‚       â”œâ”€â”€ Plan.ts           # è®¡åˆ’æ¨¡å‹
â”‚       â”œâ”€â”€ PurchaseLog.ts    # è´­ä¹°è®°å½•æ¨¡å‹
â”‚       â”œâ”€â”€ FollowUp.ts       # å›è®¿è®°å½•æ¨¡å‹
â”‚       â”œâ”€â”€ Tag.ts            # æ ‡ç­¾æ¨¡å‹
â”‚       â””â”€â”€ Category.ts       # åˆ†ç±»æ¨¡å‹
â”œâ”€â”€ public/                   # é™æ€èµ„æº
â”œâ”€â”€ scripts/                  # è„šæœ¬ (å¦‚æ•°æ®å¡«å…… seed.js)
â”œâ”€â”€ .env.local                # ç¯å¢ƒå˜é‡ (è¯·å‹¿æäº¤åˆ°ç‰ˆæœ¬åº“)
â”œâ”€â”€ package.json
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ next.config.js
â””â”€â”€ README.md

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹ (MongoDB Atlas Schemas æ¦‚è¿°)

-   **`users`**: å­˜å‚¨ç”¨æˆ·è´¦æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å§“åã€é‚®ç®±ã€è§’è‰²ï¼ˆç³»ç»Ÿç®¡ç†å‘˜ã€ç®¡ç†å‘˜ã€å®¢æˆ·ï¼‰ã€å…³è”çš„ç®¡ç†å‘˜IDç­‰ã€‚ [cite: 8, 9, 10, 11]
-   **`tags`**: å­˜å‚¨æ ‡ç­¾ä¿¡æ¯ï¼Œç”¨äºå¯¹ç”¨æˆ·ã€å•†å“ã€è®¡åˆ’æ¨¡æ¿ç­‰è¿›è¡ŒåŠ¨æ€åˆ†ç±»ã€‚ [cite: 11, 12]
-   **`categories`**: å­˜å‚¨åˆ†ç±»ä¿¡æ¯ï¼Œç”¨äºç»„ç»‡å•†å“å’Œè®¡åˆ’æ¨¡æ¿ã€‚ [cite: 12, 13, 14]
-   **`products`**: å­˜å‚¨ USANA å•†å“çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚åç§°ã€å“ç‰Œã€æè¿°ã€ä»·æ ¼ã€å›¾ç‰‡URLã€åˆ†ç±»ç­‰ã€‚ [cite: 14, 15, 16, 17]
-   **`plan_templates`**: å­˜å‚¨æœç”¨è®¡åˆ’çš„æ¨¡æ¿ï¼ŒåŒ…å«è®¡åˆ’åç§°ã€æè¿°ã€é’ˆå¯¹ç—‡çŠ¶ã€äº§å“ç»„åˆåŠé»˜è®¤ç”¨æ³•ã€‚ [cite: 17, 18, 19, 20, 21]
-   **`plans`**: å­˜å‚¨åˆ†é…ç»™å…·ä½“å®¢æˆ·çš„ä¸ªæ€§åŒ–æœç”¨è®¡åˆ’ï¼ŒåŒ…æ‹¬å®¢æˆ·IDã€ç®¡ç†å‘˜IDã€è®¡åˆ’èµ·æ­¢æ—¥æœŸã€çŠ¶æ€ã€åŒ…å«çš„äº§å“åŠå…·ä½“ç”¨æ³•ã€‚ [cite: 21, 22, 23, 24, 25]
-   **`purchase_logs`**: è®°å½•å®¢æˆ·çš„è´­ä¹°å†å²ï¼ŒåŒ…æ‹¬å®¢æˆ·IDã€è´­ä¹°æ—¥æœŸã€è´­ä¹°é¡¹ç›®ï¼ˆäº§å“ã€æ•°é‡ã€ä»·æ ¼å¿«ç…§ï¼‰ã€æ€»é‡‘é¢ç­‰ã€‚ [cite: 25, 26, 27, 28, 29]
-   **`follow_ups`**: è®°å½•å¯¹å®¢æˆ·è¿›è¡Œçš„å›è®¿ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®¢æˆ·IDã€å›è®¿æ—¥æœŸã€æ²Ÿé€šè¯¦æƒ…ã€å®¢æˆ·åé¦ˆã€ç®¡ç†å‘˜å¤‡æ³¨ç­‰ã€‚ [cite: 29, 30, 31, 32, 33]

*æ³¨ï¼šè¯¦ç»†çš„å­—æ®µå®šä¹‰å’Œç´¢å¼•å»ºè®®è¯·å‚è€ƒ `description.txt` ä¸­æä¾›çš„ schema å®šä¹‰ã€‚* [cite: 7]

## ğŸ” æƒé™æ§åˆ¶ (ç¤ºä¾‹)

| åŠŸèƒ½æ¨¡å—         | ç³»ç»Ÿç®¡ç†å‘˜ | ç®¡ç†å‘˜     | å®¢æˆ·               |
|------------------|------------|------------|--------------------|
| ä»ªè¡¨ç›˜           | âœ…          | âœ…          | æœ‰é™ä¿¡æ¯/N/A       |
| å®¢æˆ·ä¿¡æ¯ç®¡ç†     | âœ…          | âœ… (åä¸‹å®¢æˆ·) | æŸ¥çœ‹/ç¼–è¾‘ä¸ªäººèµ„æ–™    |
| å•†å“ç®¡ç†         | âœ…          | âœ… (æŸ¥çœ‹/ä½¿ç”¨) | (é€šè¿‡å…¬å¼€é¡µæŸ¥çœ‹) |
| æœç”¨è®¡åˆ’ç®¡ç†     | âœ…          | âœ… (åˆ›å»º/åˆ†é…) | æŸ¥çœ‹æˆ‘çš„è®¡åˆ’ |
| è´­ä¹°è®°å½•ç®¡ç†     | âœ…          | âœ… (è®°å½•/æŸ¥çœ‹) | æŸ¥çœ‹æˆ‘çš„è´­ä¹°è®°å½• |
| å›è®¿è®°å½•ç®¡ç†     | âœ…          | âœ… (è®°å½•/æŸ¥çœ‹) | æŸ¥çœ‹/å‚ä¸åé¦ˆ |
| å…¬å¼€äº§å“å±•ç¤ºé¡µ   | (å†…å®¹ç®¡ç†)  | (å†…å®¹ç®¡ç†)  | âœ… (æµè§ˆ)   |
| ç”¨æˆ·ä¸æƒé™ç®¡ç†   | âœ…          | æœ‰é™ç®¡ç†    | (ç®¡ç†ä¸ªäººè´¦æˆ·)     |

## ğŸš€ éƒ¨ç½²

### Vercel éƒ¨ç½² (æ¨èç”¨äº Next.js)
1.  æ¨é€ä»£ç åˆ° GitHub/GitLab/Bitbucketã€‚
2.  åœ¨ Vercel ä¸Šè¿æ¥æ‚¨çš„ Git ä»“åº“ã€‚
3.  é…ç½®é¡¹ç›®è®¾ç½®å’Œç¯å¢ƒå˜é‡ (å¦‚ `MONGODB_URI`, `DB_NAME`, `NEXTAUTH_SECRET` ç­‰)ã€‚
4.  Vercel å°†è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²æ‚¨çš„åº”ç”¨ã€‚

### Docker éƒ¨ç½²
1.  **åˆ›å»º Dockerfile** (ç¤ºä¾‹):
    ```dockerfile
    FROM node:18-alpine AS base
    WORKDIR /app
    COPY package*.json ./
    RUN npm install
    COPY . .
    RUN npm run build
    CMD ["npm", "start"]
    ```
2.  **æ„å»ºé•œåƒ**
    ```bash
    docker build -t your-app-name .
    ```
3.  **è¿è¡Œå®¹å™¨**
    ```bash
    docker run -p 3000:3000 -e MONGODB_URI="your-mongodb-uri" -e DB_NAME="your_db_name" your-app-name
    ```

## ğŸ“š API æ–‡æ¡£ (åŸºäº Next.js API Routes)

é¡¹ç›®é€šè¿‡ Next.js API Routes æä¾› RESTful API æ¥å£ï¼Œç”¨äºé©±åŠ¨å‰åç«¯æ•°æ®äº¤äº’ã€‚ [cite: 6] ä¸»è¦æ¥å£å°†å›´ç»•ä»¥ä¸‹èµ„æºå±•å¼€ï¼š

-   **è®¤è¯æ¥å£**: `/api/auth/...` (ä¾‹å¦‚ï¼šç™»å½•ã€æ³¨å†Œã€ç™»å‡º)
-   **ç”¨æˆ·æ¥å£**: `/api/users/...` (ä¾‹å¦‚ï¼šCRUD ç”¨æˆ·ä¿¡æ¯)
-   **å®¢æˆ·æ¥å£**: `/api/customers/...` (æˆ–é›†æˆåœ¨ `/api/users` ä¸­ï¼Œæ ¹æ®è§’è‰²åŒºåˆ†)
-   **å•†å“æ¥å£**: `/api/products/...` (ä¾‹å¦‚ï¼šCRUD å•†å“ä¿¡æ¯ï¼Œåˆ—è¡¨æŸ¥è¯¢)
-   **è®¡åˆ’æ¨¡æ¿æ¥å£**: `/api/plan-templates/...` (ä¾‹å¦‚ï¼šCRUD è®¡åˆ’æ¨¡æ¿)
-   **è®¡åˆ’æ¥å£**: `/api/plans/...` (ä¾‹å¦‚ï¼šCRUD å®¢æˆ·è®¡åˆ’)
-   **è´­ä¹°è®°å½•æ¥å£**: `/api/purchase-logs/...` (ä¾‹å¦‚ï¼šè®°å½•è´­ä¹°ï¼ŒæŸ¥è¯¢è®°å½•)
-   **å›è®¿è®°å½•æ¥å£**: `/api/follow-ups/...` (ä¾‹å¦‚ï¼šè®°å½•å›è®¿ï¼ŒæŸ¥è¯¢è®°å½•)
-   **åˆ†ç±»æ¥å£**: `/api/categories/...`
-   **æ ‡ç­¾æ¥å£**: `/api/tags/...`

å…·ä½“çš„APIç«¯ç‚¹å’Œè¯·æ±‚/å“åº”æ ¼å¼åº”åœ¨å¼€å‘è¿‡ç¨‹ä¸­è¿›ä¸€æ­¥å®šä¹‰å’Œæ–‡æ¡£åŒ–ã€‚

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•å¥—ä»¶ (å¦‚æœé…ç½®äº† Jest, Cypress ç­‰):
```bash
npm test

ğŸ¤ è´¡çŒ®æŒ‡å—
Fork é¡¹ç›®
åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (git checkout -b feature/AmazingFeature)
æäº¤æ›´æ”¹ (git commit -m 'Add some AmazingFeature')
æ¨é€åˆ°åˆ†æ”¯ (git push origin feature/AmazingFeature)
æ‰“å¼€ Pull Request
ğŸ“ æ›´æ–°æ—¥å¿—
(åœ¨æ­¤è®°å½•ç‰ˆæœ¬å˜æ›´å’Œé‡è¦æ›´æ–°)

v1.0.0 (è§„åˆ’ä¸­)
åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«æ ¸å¿ƒåŠŸèƒ½æ¨¡å—çš„å®ç°ã€‚
ğŸ“„ è®¸å¯è¯
æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ LICENSE æ–‡ä»¶äº†è§£è¯¦æƒ… (å¦‚æœé¡¹ç›®ä¸­åŒ…å« LICENSE æ–‡ä»¶)ã€‚

ğŸ™ è‡´è°¢
Next.js - React æ¡†æ¶ 
shadcn/ui - UI ç»„ä»¶åº“ 
Tailwind CSS - CSS æ¡†æ¶ 
Radix UI - åº•å±‚ UI ç»„ä»¶åº“ 
MongoDB Atlas - æ•°æ®åº“æœåŠ¡ 
USANA (å“ç‰Œå‚è€ƒ) 
ğŸ“ æ”¯æŒ
å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š

ğŸ“§ Email: your-support-email@example.com
ğŸ’¬ Issues: (é¡¹ç›® GitHub/GitLab Issues åœ°å€)
ğŸ“– æ–‡æ¡£: (é¡¹ç›®è¯¦ç»†æ–‡æ¡£é“¾æ¥ï¼Œå¦‚æœé€‚ç”¨)
å®¢æˆ·å¥åº·ä¸æ¶ˆè´¹ç®¡ç†ç³»ç»Ÿ - åŠ©åŠ›å¥åº·ç®¡ç†ä¸ä¸šåŠ¡å¢é•¿! âœ¨

================
File: scripts/fix-passwords-real.js
================
const bcrypt = require('bcryptjs');
const mongoose = require('mongoose');
require('dotenv').config({ path: '.env.local' });

const MONGODB_URI = process.env.MONGODB_URI;
const DB_NAME = process.env.DB_NAME;

async function fixPasswords() {
  try {
    // è¿æ¥æ•°æ®åº“
    await mongoose.connect(MONGODB_URI, { dbName: DB_NAME });
    console.log('âœ… Connected to MongoDB');

    // å®šä¹‰Useræ¨¡å‹
    const userSchema = new mongoose.Schema({
      name: String,
      email: String,
      password: String,
      role: String,
      phone: String,
      department: String,
      isActive: Boolean,
    }, { timestamps: true });
    
    const User = mongoose.models.User || mongoose.model('User', userSchema);

    // ç”Ÿæˆæ­£ç¡®çš„å¯†ç å“ˆå¸Œ
    console.log('ğŸ” Generating correct password hashes...');
    
    const adminHash = await bcrypt.hash('admin123', 12);
    const doctorHash = await bcrypt.hash('doctor123', 12);
    const nurseHash = await bcrypt.hash('nurse123', 12);
    const receptionHash = await bcrypt.hash('reception123', 12);
    
    console.log('Generated hashes:');
    console.log('admin123:', adminHash);
    console.log('doctor123:', doctorHash);
    console.log('nurse123:', nurseHash);
    console.log('reception123:', receptionHash);
    
    // éªŒè¯å“ˆå¸Œæ˜¯å¦æ­£ç¡®
    console.log('\nğŸ§ª Verifying hashes:');
    console.log('admin123 verify:', await bcrypt.compare('admin123', adminHash));
    console.log('doctor123 verify:', await bcrypt.compare('doctor123', doctorHash));
    console.log('nurse123 verify:', await bcrypt.compare('nurse123', nurseHash));
    console.log('reception123 verify:', await bcrypt.compare('reception123', receptionHash));

    // æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·
    console.log('\nğŸ“ Updating users in database...');
    
    await User.findOneAndUpdate(
      { email: 'admin@healthcrm.com' },
      { password: adminHash }
    );
    
    await User.findOneAndUpdate(
      { email: 'dr.johnson@healthcrm.com' },
      { password: doctorHash }
    );
    
    await User.findOneAndUpdate(
      { email: 'dr.chen@healthcrm.com' },
      { password: doctorHash }
    );
    
    await User.findOneAndUpdate(
      { email: 'nurse.wong@healthcrm.com' },
      { password: nurseHash }
    );
    
    await User.findOneAndUpdate(
      { email: 'receptionist@healthcrm.com' },
      { password: receptionHash }
    );

    console.log('âœ… All passwords updated successfully!');
    console.log('\nğŸ” Test Login Credentials:');
    console.log('Admin: admin@healthcrm.com / admin123');
    console.log('Doctor: dr.johnson@healthcrm.com / doctor123');
    console.log('Nurse: nurse.wong@healthcrm.com / nurse123');
    console.log('Receptionist: receptionist@healthcrm.com / reception123');
    
    await mongoose.disconnect();
    console.log('ğŸ”Œ Disconnected from MongoDB');

  } catch (error) {
    console.error('âŒ Error:', error);
    process.exit(1);
  }
}

fixPasswords();

================
File: scripts/fix-passwords.js
================
const bcrypt = require('bcryptjs');
const mongoose = require('mongoose');
require('dotenv').config({ path: '.env.local' });

const MONGODB_URI = process.env.MONGODB_URI;
const DB_NAME = process.env.DB_NAME;

async function connectDB() {
  try {
    await mongoose.connect(MONGODB_URI, {
      dbName: DB_NAME,
    });
    console.log('âœ… Connected to MongoDB');
  } catch (error) {
    console.error('âŒ MongoDB connection error:', error);
    process.exit(1);
  }
}

// User Schema
const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  password: String,
  role: String,
  phone: String,
  department: String,
  isActive: { type: Boolean, default: true },
}, { timestamps: true });

const User = mongoose.models.User || mongoose.model('User', userSchema);

async function createUsersWithCorrectPasswords() {
  await connectDB();
  
  console.log('ğŸ” Creating users with correct password hashes...');
  
  // Generate password hashes
  const adminHash = await bcrypt.hash('admin123', 12);
  const doctorHash = await bcrypt.hash('doctor123', 12);
  const nurseHash = await bcrypt.hash('nurse123', 12);
  const receptionHash = await bcrypt.hash('reception123', 12);
  
  const users = [
    {
      name: 'Admin Alice Smith',
      email: 'admin@healthcrm.com',
      password: adminHash,
      role: 'admin',
      phone: '+1-555-0001',
      department: 'Administration',
    },
    {
      name: 'Dr. Sarah Johnson',
      email: 'dr.johnson@healthcrm.com',
      password: doctorHash,
      role: 'doctor',
      phone: '+1-555-0101',
      department: 'Cardiology',
    },
    {
      name: 'Dr. Michael Chen',
      email: 'dr.chen@healthcrm.com',
      password: doctorHash,
      role: 'doctor',
      phone: '+1-555-0102',
      department: 'Neurology',
    },
    {
      name: 'Dr. Emily Rodriguez',
      email: 'dr.rodriguez@healthcrm.com',
      password: doctorHash,
      role: 'doctor',
      phone: '+1-555-0103',
      department: 'Pediatrics',
    },
    {
      name: 'Nurse Lisa Wong',
      email: 'nurse.wong@healthcrm.com',
      password: nurseHash,
      role: 'nurse',
      phone: '+1-555-0201',
      department: 'Emergency',
    },
    {
      name: 'Receptionist Mary Davis',
      email: 'receptionist@healthcrm.com',
      password: receptionHash,
      role: 'receptionist',
      phone: '+1-555-0301',
      department: 'Front Desk',
    },
  ];

  await User.deleteMany({});
  const createdUsers = await User.insertMany(users);
  
  console.log(`âœ… Created ${createdUsers.length} users with correct passwords`);
  console.log('\nğŸ” Test Login Credentials:');
  console.log('Admin: admin@healthcrm.com / admin123');
  console.log('Doctor: dr.johnson@healthcrm.com / doctor123');
  console.log('Nurse: nurse.wong@healthcrm.com / nurse123');
  console.log('Receptionist: receptionist@healthcrm.com / reception123');
  
  await mongoose.disconnect();
  console.log('ğŸ”Œ Disconnected from MongoDB');
}

createUsersWithCorrectPasswords().catch(console.error);

================
File: scripts/seed.js
================
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
require('dotenv').config({ path: '.env.local' });

const MONGODB_URI = process.env.MONGODB_URI;
const DB_NAME = process.env.DB_NAME;

async function connectDB() {
  try {
    await mongoose.connect(MONGODB_URI, {
      dbName: DB_NAME,
    });
    console.log('âœ… Connected to MongoDB');
  } catch (error) {
    console.error('âŒ MongoDB connection error:', error);
    process.exit(1);
  }
}

// User Schema
const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  password: String,
  role: String,
  phone: String,
  department: String,
  isActive: { type: Boolean, default: true },
}, { timestamps: true });

// Customer Schema
const customerSchema = new mongoose.Schema({
  customerId: String,
  firstName: String,
  lastName: String,
  email: String,
  phone: String,
  dateOfBirth: Date,
  gender: String,
  customerType: {
    type: String,
    enum: ['potential', 'new', 'regular', 'vip', 'inactive'],
    default: 'potential',
  },
  salesRep: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
  },
  followUp: {
    nextContactDate: Date,
    priority: {
      type: String,
      enum: ['low', 'medium', 'high', 'urgent'],
      default: 'medium',
    },
    lastContactDate: Date,
  },
  productUsage: [{
    productName: String,
    effectiveness: Number,
    willContinue: Boolean,
  }],
  status: {
    type: String,
    enum: ['active', 'inactive', 'blocked'],
    default: 'active',
  },
  isActive: { type: Boolean, default: true },
}, { timestamps: true });

const User = mongoose.models.User || mongoose.model('User', userSchema);
const Customer = mongoose.models.Customer || mongoose.model('Customer', customerSchema);

async function seedUsers() {
  console.log('ğŸŒ± Seeding users...');
  
  const users = [
    {
      name: 'System Admin',
      email: 'sysadmin@healthcrm.com',
      password: await bcrypt.hash('admin123', 12),
      role: 'system_admin',
      phone: '+86-138-0000-0001',
      department: 'IT',
    },
    {
      name: 'Sales Manager Zhang',
      email: 'manager.zhang@healthcrm.com',
      password: await bcrypt.hash('admin123', 12),
      role: 'admin',
      phone: '+86-138-0000-0101',
      department: 'Sales',
    },
    {
      name: 'Sales Rep Li',
      email: 'sales.li@healthcrm.com',
      password: await bcrypt.hash('admin123', 12),
      role: 'admin',
      phone: '+86-138-0000-0102',
      department: 'Sales',
    },
    {
      name: 'Customer Wang Ming',
      email: 'wang.ming@customer.com',
      password: await bcrypt.hash('customer123', 12),
      role: 'customer',
      phone: '+86-138-0000-1001',
      department: '',
    },
    {
      name: 'Customer Liu Fang',
      email: 'liu.fang@customer.com',
      password: await bcrypt.hash('customer123', 12),
      role: 'customer',
      phone: '+86-138-0000-1002',
      department: '',
    },
  ];

  await User.deleteMany({});
  const createdUsers = await User.insertMany(users);
  console.log(`âœ… Created ${createdUsers.length} users`);
  return createdUsers;
}

async function seedCustomers() {
  console.log('ğŸŒ± Seeding customers...');
  
  // Get admin users for sales rep assignment
  const admins = await User.find({ role: { $in: ['admin', 'system_admin'] } });
  
  const customers = [
    {
      customerId: 'C0001',
      firstName: 'å°æ˜',
      lastName: 'ç‹',
      email: 'xiaoming.wang@email.com',
      phone: '+86-138-1001-0001',
      dateOfBirth: new Date('1985-03-15'),
      gender: 'male',
      customerType: 'vip',
      salesRep: admins[0]?._id,
      followUp: {
        nextContactDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000), // 3 days from now
        priority: 'high',
        lastContactDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
      },
      productUsage: [
        {
          productName: 'USANA CellSentials',
          effectiveness: 4,
          willContinue: true,
        },
      ],
      status: 'active',
    },
    {
      customerId: 'C0002',
      firstName: 'å°çº¢',
      lastName: 'æ',
      email: 'xiaohong.li@email.com',
      phone: '+86-138-1002-0002',
      dateOfBirth: new Date('1992-07-22'),
      gender: 'female',
      customerType: 'regular',
      salesRep: admins[1]?._id || admins[0]?._id,
      followUp: {
        nextContactDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000), // 1 day from now
        priority: 'medium',
        lastContactDate: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000), // 14 days ago
      },
      productUsage: [
        {
          productName: 'USANA Probiotics',
          effectiveness: 3,
          willContinue: true,
        },
      ],
      status: 'active',
    },
    {
      customerId: 'C0003',
      firstName: 'å»ºå›½',
      lastName: 'å¼ ',
      email: 'jianguo.zhang@email.com',
      phone: '+86-138-1003-0003',
      dateOfBirth: new Date('1975-11-08'),
      gender: 'male',
      customerType: 'new',
      salesRep: admins[0]?._id,
      followUp: {
        nextContactDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 days ago (overdue)
        priority: 'urgent',
        lastContactDate: new Date(Date.now() - 21 * 24 * 60 * 60 * 1000), // 21 days ago
      },
      productUsage: [
        {
          productName: 'USANA BiOmega',
          effectiveness: 2, // Low effectiveness
          willContinue: false,
        },
      ],
      status: 'active',
    },
    {
      customerId: 'C0004',
      firstName: 'ç¾ä¸½',
      lastName: 'é™ˆ',
      email: 'meili.chen@email.com',
      phone: '+86-138-1004-0004',
      dateOfBirth: new Date('2000-04-12'),
      gender: 'female',
      customerType: 'potential',
      salesRep: admins[1]?._id || admins[0]?._id,
      followUp: {
        nextContactDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
        priority: 'low',
        lastContactDate: null,
      },
      productUsage: [],
      status: 'active',
    },
    {
      customerId: 'C0005',
      firstName: 'å‹‡',
      lastName: 'åˆ˜',
      email: 'yong.liu@email.com',
      phone: '+86-138-1005-0005',
      dateOfBirth: new Date('1968-12-03'),
      gender: 'male',
      customerType: 'regular',
      salesRep: admins[0]?._id,
      followUp: {
        nextContactDate: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000), // 10 days from now
        priority: 'medium',
        lastContactDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // 30 days ago
      },
      productUsage: [
        {
          productName: 'USANA MagneCal D',
          effectiveness: 5,
          willContinue: true,
        },
        {
          productName: 'USANA Vita Antioxidant',
          effectiveness: 1, // Very low effectiveness
          willContinue: false,
        },
      ],
      status: 'active',
    },
  ];

  await Customer.deleteMany({});
  const createdCustomers = await Customer.insertMany(customers);
  console.log(`âœ… Created ${createdCustomers.length} customers`);
  return createdCustomers;
}

async function seedDatabase() {
  try {
    await connectDB();
    
    console.log('ğŸš€ Starting database seeding...');
    
    const users = await seedUsers();
    const customers = await seedCustomers();
    
    console.log('ğŸ‰ Database seeding completed successfully!');
    console.log('\nğŸ“Š Summary:');
    console.log(`Users: ${users.length}`);
    console.log(`Customers: ${customers.length}`);
    
    console.log('\nğŸ” Test Login Credentials:');
    console.log('System Admin: sysadmin@healthcrm.com / admin123');
    console.log('Sales Manager: manager.zhang@healthcrm.com / admin123');
    console.log('Sales Rep: sales.li@healthcrm.com / admin123');
    console.log('Customer: wang.ming@customer.com / customer123');
    
  } catch (error) {
    console.error('âŒ Error seeding database:', error);
  } finally {
    await mongoose.disconnect();
    console.log('ğŸ”Œ Disconnected from MongoDB');
  }
}

// Run the seeder
if (require.main === module) {
  seedDatabase();
}

module.exports = { seedDatabase };

================
File: scripts/test-passwords.js
================
const bcrypt = require('bcryptjs');

async function testPasswords() {
  console.log('ğŸ§ª Testing password hashes...\n');
  
  // è¿™äº›æ˜¯æˆ‘åœ¨æ•°æ®åº“ä¸­ä½¿ç”¨çš„å®é™…å“ˆå¸Œå€¼
  const hashes = {
    'admin123': '$2a$12$7ZrZnz4QjQHKjDWGPvO7.OFnGDCwYWCLMfEbhDdyxL5x5YvXj3Gma',
    'doctor123': '$2a$12$CQKOqazpZhGz6QoN0kcNVOjlCCUeqjLOA.XJ.j3eaOWBhUtzqKPHS', 
    'nurse123': '$2a$12$RjYgPKbwCsEzCWdTnlE.aujWBEWRF.Lg0.8mFqNdLxBF4wlDNvMGW',
    'reception123': '$2a$12$vFj.7gG4oCGqYOWz5YJVCOx6B.rKKnkpLFKaU8jDxU8mFqR8NpZ6S'
  };
  
  for (const [password, hash] of Object.entries(hashes)) {
    const isValid = await bcrypt.compare(password, hash);
    console.log(`${password}: ${isValid ? 'âœ… Valid' : 'âŒ Invalid'}`);
  }
  
  console.log('\nğŸ”‘ Generating new correct hashes:');
  
  const passwords = ['admin123', 'doctor123', 'nurse123', 'reception123'];
  for (const password of passwords) {
    const newHash = await bcrypt.hash(password, 12);
    const testResult = await bcrypt.compare(password, newHash);
    console.log(`${password}: ${newHash} - Test: ${testResult ? 'âœ…' : 'âŒ'}`);
  }
}

testPasswords().catch(console.error);

================
File: src/app/api/auth/login/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import bcrypt from 'bcryptjs'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import User from '@/models/User'

export async function POST(request: NextRequest) {
  try {
    await connectDB()
    
    const body = await request.json()
    const { email, password } = body

    console.log('Login attempt for email:', email)
    console.log('Input password:', password)

    if (!email || !password) {
      return NextResponse.json(
        { message: 'é‚®ç®±å’Œå¯†ç éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    // Find user by email
    const user = await User.findOne({ email, isActive: true })
    console.log('User found:', user ? 'Yes' : 'No')
    
    if (!user) {
      console.log('User not found or inactive for email:', email)
      return NextResponse.json(
        { message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨' },
        { status: 401 }
      )
    }

    console.log('Stored password hash:', user.password)
    
    // ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šå¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯123456ï¼Œæˆ‘ä»¬ç›´æ¥é‡æ–°ç”Ÿæˆå“ˆå¸Œå¹¶æ›´æ–°æ•°æ®åº“
    if (password === '123456') {
      console.log('Detected test password, generating new hash...')
      const newHash = await bcrypt.hash('123456', 12)
      console.log('Generated new hash:', newHash)
      
      // æ›´æ–°æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œ
      await User.findByIdAndUpdate(user._id, { password: newHash })
      console.log('Updated password hash in database')
      
      // éªŒè¯æ–°å“ˆå¸Œ
      const testResult = await bcrypt.compare('123456', newHash)
      console.log('New hash verification:', testResult)
      
      if (!testResult) {
        return NextResponse.json(
          { message: 'å¯†ç å“ˆå¸Œç”Ÿæˆå¤±è´¥' },
          { status: 500 }
        )
      }
    } else {
      // Check password normally
      const isPasswordValid = await bcrypt.compare(password, user.password)
      console.log('Password valid:', isPasswordValid)
      
      if (!isPasswordValid) {
        console.log('Password validation failed for user:', email)
        return NextResponse.json(
          { message: 'å¯†ç é”™è¯¯' },
          { status: 401 }
        )
      }
    }

    // Generate JWT token
    const token = jwt.sign(
      { 
        userId: user._id, 
        email: user.email, 
        role: user.role 
      },
      process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024',
      { expiresIn: '7d' }
    )

    // Return user data (without password)
    const userData = {
      id: user._id,
      name: user.name,
      email: user.email,
      role: user.role,
      phone: user.phone,
      department: user.department,
    }

    console.log('Login successful for user:', email)
    return NextResponse.json({
      message: 'ç™»å½•æˆåŠŸ',
      token,
      user: userData,
    })

  } catch (error) {
    console.error('Login error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/customers/[id]/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import Customer from '@/models/Customer'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const customer = await Customer.findById(params.id)
      .populate('salesRep', 'name employeeId')

    if (!customer) {
      return NextResponse.json(
        { message: 'å®¢æˆ·ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({ customer })

  } catch (error) {
    console.error('Get customer error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const body = await request.json()
    
    // éªŒè¯å¿…éœ€å­—æ®µ
    const { firstName, lastName, phone } = body
    if (!firstName || !lastName || !phone) {
      return NextResponse.json(
        { message: 'å§“åå’Œç”µè¯éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    const customer = await Customer.findByIdAndUpdate(
      params.id,
      body,
      { new: true, runValidators: true }
    ).populate('salesRep', 'name employeeId')

    if (!customer) {
      return NextResponse.json(
        { message: 'å®¢æˆ·ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      message: 'å®¢æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ',
      customer,
    })

  } catch (error) {
    console.error('Update customer error:', error)
    
    if (error.code === 11000) {
      return NextResponse.json(
        { message: 'é‚®ç®±å·²è¢«å…¶ä»–å®¢æˆ·ä½¿ç”¨' },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    let decoded: any
    
    try {
      decoded = jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    // æ£€æŸ¥æƒé™ï¼ˆåªæœ‰ç®¡ç†å‘˜æˆ–é”€å”®ç»ç†å¯ä»¥åˆ é™¤ï¼‰
    if (!['admin', 'sales_manager'].includes(decoded.role)) {
      return NextResponse.json(
        { message: 'æƒé™ä¸è¶³' },
        { status: 403 }
      )
    }

    await connectDB()

    const customer = await Customer.findByIdAndUpdate(
      params.id,
      { isActive: false },
      { new: true }
    )

    if (!customer) {
      return NextResponse.json(
        { message: 'å®¢æˆ·ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      message: 'å®¢æˆ·å·²åœç”¨',
    })

  } catch (error) {
    console.error('Delete customer error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/customers/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import Customer from '@/models/Customer'

export async function GET(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const { searchParams } = new URL(request.url)
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '10')
    const search = searchParams.get('search') || ''
    const sortField = searchParams.get('sortField') || 'createdAt'
    const sortOrder = searchParams.get('sortOrder') || 'desc'
    
    // è¿‡æ»¤å™¨
    const customerType = searchParams.get('customerType') || ''
    const priority = searchParams.get('priority') || ''
    const status = searchParams.get('status') || ''
    const salesRep = searchParams.get('salesRep') || ''
    const tab = searchParams.get('tab') || 'all'

    const skip = (page - 1) * limit

    // æ„å»ºæœç´¢æŸ¥è¯¢
    let searchQuery: any = { isActive: true }
    
    if (search) {
      searchQuery.$or = [
        { firstName: { $regex: search, $options: 'i' } },
        { lastName: { $regex: search, $options: 'i' } },
        { customerId: { $regex: search, $options: 'i' } },
        { phone: { $regex: search, $options: 'i' } },
        { email: { $regex: search, $options: 'i' } },
      ]
    }

    // åº”ç”¨è¿‡æ»¤å™¨
    if (customerType) {
      searchQuery.customerType = customerType
    }

    if (priority) {
      searchQuery['followUp.priority'] = priority
    }

    if (status) {
      searchQuery.status = status
    }

    if (salesRep) {
      searchQuery.salesRep = salesRep
    }

    // Tab-based filtering
    const today = new Date()
    
    switch (tab) {
      case 'potential':
        searchQuery.customerType = 'potential'
        break
      case 'new':
        searchQuery.customerType = 'new'
        break
      case 'regular':
        searchQuery.customerType = 'regular'
        break
      case 'vip':
        searchQuery.customerType = 'vip'
        break
      case 'inactive':
        searchQuery.customerType = 'inactive'
        break
      case 'followup':
        // éœ€è¦å›è®¿çš„å®¢æˆ·ï¼ˆå›è®¿æ—¥æœŸåœ¨ä»Šå¤©æˆ–ä¹‹å‰ï¼‰
        searchQuery['followUp.nextContactDate'] = { $lte: today }
        break
      case 'medication':
        // äº§å“ä½™é‡ä¸è¶³çš„å®¢æˆ·ï¼ˆæ•ˆæœè¯„åˆ†ä½æˆ–éœ€è¦è¡¥å……ï¼‰
        searchQuery.$or = [
          { 'productUsage.effectiveness': { $lte: 2 } },
          { 'productUsage.willContinue': true }
        ]
        break
      case 'urgent':
        // ç´§æ€¥å¤„ç†çš„å®¢æˆ·
        searchQuery['followUp.priority'] = 'urgent'
        break
      case 'all':
      default:
        // å…¨éƒ¨å®¢æˆ·ï¼Œä¸æ·»åŠ é¢å¤–è¿‡æ»¤
        break
    }

    // æ„å»ºæ’åºå¯¹è±¡
    const sortObj: any = {}
    sortObj[sortField] = sortOrder === 'asc' ? 1 : -1

    // è·å–å®¢æˆ·æ•°æ®å’Œæ€»æ•°
    const [customers, totalCount] = await Promise.all([
      Customer.find(searchQuery)
        .populate('salesRep', 'name')
        .sort(sortObj)
        .skip(skip)
        .limit(limit)
        .select('-__v'),
      Customer.countDocuments(searchQuery)
    ])

    const totalPages = Math.ceil(totalCount / limit)

    return NextResponse.json({
      customers,
      currentPage: page,
      totalPages,
      totalCount,
      hasNext: page < totalPages,
      hasPrev: page > 1,
    })

  } catch (error) {
    console.error('Get customers error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const body = await request.json()
    
    // éªŒè¯å¿…éœ€å­—æ®µ
    const { firstName, lastName, phone } = body
    if (!firstName || !lastName || !phone) {
      return NextResponse.json(
        { message: 'å§“åå’Œç”µè¯éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    // ç”Ÿæˆå®¢æˆ·ID
    const lastCustomer = await Customer.findOne({}, {}, { sort: { 'createdAt': -1 } })
    let customerIdNumber = 1
    
    if (lastCustomer && lastCustomer.customerId) {
      const lastIdNumber = parseInt(lastCustomer.customerId.replace('C', ''))
      customerIdNumber = lastIdNumber + 1
    }
    
    const customerId = `C${customerIdNumber.toString().padStart(4, '0')}`

    // åˆ›å»ºæ–°å®¢æˆ·
    const customer = new Customer({
      customerId,
      ...body,
    })

    await customer.save()

    // è¿”å›æ—¶å¡«å……é”€å”®ä»£è¡¨ä¿¡æ¯
    await customer.populate('salesRep', 'name')

    return NextResponse.json({
      message: 'å®¢æˆ·åˆ›å»ºæˆåŠŸ',
      customer,
    })

  } catch (error) {
    console.error('Create customer error:', error)
    
    if (error.code === 11000) {
      return NextResponse.json(
        { message: 'å®¢æˆ·IDæˆ–é‚®ç®±å·²å­˜åœ¨' },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/dashboard/stats/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import Customer from '@/models/Customer'
import User from '@/models/User'

export async function GET(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    // Get current date for statistics
    const today = new Date()
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1)
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1)

    // Get customer statistics
    const totalCustomers = await Customer.countDocuments({ isActive: true })
    
    // Get new customers this month
    const newCustomers = await Customer.countDocuments({
      isActive: true,
      createdAt: { $gte: startOfMonth, $lt: endOfMonth }
    })

    // Get customers needing follow-up
    const pendingFollowUps = await Customer.countDocuments({
      isActive: true,
      'followUp.nextContactDate': { $lte: today }
    })

    // Mock revenue data for now
    const totalRevenue = 58420.50

    return NextResponse.json({
      totalCustomers,
      newCustomers,
      pendingFollowUps,
      totalRevenue,
    })

  } catch (error) {
    console.error('Dashboard stats error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/patients/[id]/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import Patient from '@/models/Patient'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const patient = await Patient.findById(params.id)
      .populate('assignedDoctor', 'name department')

    if (!patient) {
      return NextResponse.json(
        { message: 'æ‚£è€…ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({ patient })

  } catch (error) {
    console.error('Get patient error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const body = await request.json()
    
    // Validate required fields
    const { firstName, lastName, phone, dateOfBirth, gender } = body
    if (!firstName || !lastName || !phone || !dateOfBirth || !gender) {
      return NextResponse.json(
        { message: 'å§“åã€ç”µè¯ã€å‡ºç”Ÿæ—¥æœŸå’Œæ€§åˆ«éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    const patient = await Patient.findByIdAndUpdate(
      params.id,
      body,
      { new: true, runValidators: true }
    ).populate('assignedDoctor', 'name department')

    if (!patient) {
      return NextResponse.json(
        { message: 'æ‚£è€…ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      message: 'æ‚£è€…ä¿¡æ¯æ›´æ–°æˆåŠŸ',
      patient,
    })

  } catch (error) {
    console.error('Update patient error:', error)
    
    if (error.code === 11000) {
      return NextResponse.json(
        { message: 'é‚®ç®±å·²è¢«å…¶ä»–æ‚£è€…ä½¿ç”¨' },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    let decoded: any
    
    try {
      decoded = jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    // Check permissions (only admin or doctor can delete)
    if (!['admin', 'doctor'].includes(decoded.role)) {
      return NextResponse.json(
        { message: 'æƒé™ä¸è¶³' },
        { status: 403 }
      )
    }

    await connectDB()

    const patient = await Patient.findByIdAndDelete(params.id)

    if (!patient) {
      return NextResponse.json(
        { message: 'æ‚£è€…ä¸å­˜åœ¨' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      message: 'æ‚£è€…åˆ é™¤æˆåŠŸ',
    })

  } catch (error) {
    console.error('Delete patient error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/patients/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import connectDB from '@/lib/mongodb'
import Patient from '@/models/Patient'

export async function GET(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const { searchParams } = new URL(request.url)
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '10')
    const search = searchParams.get('search') || ''
    const sortField = searchParams.get('sortField') || 'createdAt'
    const sortOrder = searchParams.get('sortOrder') || 'desc'
    
    // Filters
    const type = searchParams.get('type') || ''
    const priority = searchParams.get('priority') || ''
    const status = searchParams.get('status') || ''
    const doctor = searchParams.get('doctor') || ''
    const tab = searchParams.get('tab') || 'all'

    const skip = (page - 1) * limit

    // Build search query
    let searchQuery: any = { isActive: true }
    
    if (search) {
      searchQuery.$or = [
        { firstName: { $regex: search, $options: 'i' } },
        { lastName: { $regex: search, $options: 'i' } },
        { patientId: { $regex: search, $options: 'i' } },
        { phone: { $regex: search, $options: 'i' } },
        { email: { $regex: search, $options: 'i' } },
      ]
    }

    // Apply filters
    if (type) {
      searchQuery.patientType = type
    }

    if (priority) {
      searchQuery.priority = priority
    }

    if (status) {
      searchQuery.status = status
    }

    if (doctor) {
      searchQuery.assignedDoctor = doctor
    }

    // Handle tab-based filtering
    const today = new Date()
    const todayStr = today.toISOString().split('T')[0]

    switch (tab) {
      case 'followup':
        // éœ€è¦å›è®¿çš„æ‚£è€…ï¼ˆå›è®¿æ—¥æœŸåœ¨ä»Šå¤©æˆ–ä¹‹å‰ï¼‰
        searchQuery.nextFollowUpDate = { $lte: today }
        break
      case 'medication':
        // è¯ç‰©ä¸è¶³çš„æ‚£è€…ï¼ˆå‰©ä½™ç”¨è¯å°‘äº7å¤©ï¼‰
        searchQuery['medications.remainingDays'] = { $lte: 7 }
        break
      case 'urgent':
        // ç´§æ€¥å¤„ç†çš„æ‚£è€…
        searchQuery.priority = 'urgent'
        break
      case 'all':
      default:
        // å…¨éƒ¨æ‚£è€…ï¼Œä¸æ·»åŠ é¢å¤–è¿‡æ»¤
        break
    }

    // Build sort object
    const sortObj: any = {}
    sortObj[sortField] = sortOrder === 'asc' ? 1 : -1

    // Get patients and total count with populated doctor info
    const [patients, totalCount] = await Promise.all([
      Patient.find(searchQuery)
        .populate('assignedDoctor', 'name department')
        .sort(sortObj)
        .skip(skip)
        .limit(limit)
        .select('-__v'),
      Patient.countDocuments(searchQuery)
    ])

    const totalPages = Math.ceil(totalCount / limit)

    return NextResponse.json({
      patients,
      currentPage: page,
      totalPages,
      totalCount,
      hasNext: page < totalPages,
      hasPrev: page > 1,
    })

  } catch (error) {
    console.error('Get patients error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const body = await request.json()
    
    // Validate required fields
    const { firstName, lastName, phone, dateOfBirth, gender } = body
    if (!firstName || !lastName || !phone || !dateOfBirth || !gender) {
      return NextResponse.json(
        { message: 'å§“åã€ç”µè¯ã€å‡ºç”Ÿæ—¥æœŸå’Œæ€§åˆ«éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    // Generate patient ID
    const lastPatient = await Patient.findOne({}, {}, { sort: { 'createdAt': -1 } })
    let patientIdNumber = 1
    
    if (lastPatient && lastPatient.patientId) {
      const lastIdNumber = parseInt(lastPatient.patientId.replace('P', ''))
      patientIdNumber = lastIdNumber + 1
    }
    
    const patientId = `P${patientIdNumber.toString().padStart(3, '0')}`

    // Create new patient
    const patient = new Patient({
      patientId,
      ...body,
    })

    await patient.save()

    // Populate the assignedDoctor field before returning
    await patient.populate('assignedDoctor', 'name department')

    return NextResponse.json({
      message: 'æ‚£è€…åˆ›å»ºæˆåŠŸ',
      patient,
    })

  } catch (error) {
    console.error('Create patient error:', error)
    
    if (error.code === 11000) {
      return NextResponse.json(
        { message: 'æ‚£è€…IDæˆ–é‚®ç®±å·²å­˜åœ¨' },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/api/test/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import bcrypt from 'bcryptjs'

export async function GET(request: NextRequest) {
  try {
    const testPassword = '123456'
    const testHash = '$2a$10$N9qo8uLOickgx2ZMRZoMye.IY2QZz1W3jjCjVyOUIAJAPJXgggH3m'
    
    console.log('Testing bcrypt...')
    console.log('Password:', testPassword)
    console.log('Hash:', testHash)
    
    // Test the hash we're using
    const result1 = await bcrypt.compare(testPassword, testHash)
    console.log('Direct test result:', result1)
    
    // Generate a new hash and test it
    const newHash = await bcrypt.hash(testPassword, 10)
    console.log('Generated new hash:', newHash)
    
    const result2 = await bcrypt.compare(testPassword, newHash)
    console.log('New hash test result:', result2)
    
    // Test with different bcrypt versions
    const saltRounds = 12
    const anotherHash = await bcrypt.hash(testPassword, saltRounds)
    console.log('Another hash (12 rounds):', anotherHash)
    
    const result3 = await bcrypt.compare(testPassword, anotherHash)
    console.log('Another hash test result:', result3)
    
    return NextResponse.json({
      testPassword,
      originalHash: testHash,
      originalResult: result1,
      newHash,
      newResult: result2,
      anotherHash,
      anotherResult: result3,
      bcryptVersion: require('bcryptjs/package.json').version
    })
    
  } catch (error) {
    console.error('Test error:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}

================
File: src/app/api/users/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import jwt from 'jsonwebtoken'
import bcrypt from 'bcryptjs'
import connectDB from '@/lib/mongodb'
import User from '@/models/User'

export async function GET(request: NextRequest) {
  try {
    // Verify JWT token
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    
    try {
      jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    await connectDB()

    const { searchParams } = new URL(request.url)
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '10')
    const search = searchParams.get('search') || ''
    const role = searchParams.get('role') || ''
    const department = searchParams.get('department') || ''
    const sortField = searchParams.get('sortField') || 'createdAt'
    const sortOrder = searchParams.get('sortOrder') || 'desc'

    const skip = (page - 1) * limit

    // Build search query
    let searchQuery: any = {}
    
    if (search) {
      searchQuery.$or = [
        { name: { $regex: search, $options: 'i' } },
        { email: { $regex: search, $options: 'i' } },
        { phone: { $regex: search, $options: 'i' } },
      ]
    }

    if (role) {
      // Handle multiple roles separated by comma
      if (role.includes(',')) {
        const roles = role.split(',').map(r => r.trim())
        searchQuery.role = { $in: roles }
      } else {
        searchQuery.role = role
      }
    }

    if (department) {
      searchQuery.department = department
    }

    // Build sort object
    const sortObj: any = {}
    sortObj[sortField] = sortOrder === 'asc' ? 1 : -1

    // Get users and total count
    const [users, totalCount] = await Promise.all([
      User.find(searchQuery)
        .sort(sortObj)
        .skip(skip)
        .limit(limit)
        .select('-password -__v'),
      User.countDocuments(searchQuery)
    ])

    const totalPages = Math.ceil(totalCount / limit)

    return NextResponse.json({
      users,
      currentPage: page,
      totalPages,
      totalCount,
      hasNext: page < totalPages,
      hasPrev: page > 1,
    })

  } catch (error) {
    console.error('Get users error:', error)
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    // Verify JWT token and admin role
    const authHeader = request.headers.get('authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { message: 'æœªæˆæƒè®¿é—®' },
        { status: 401 }
      )
    }

    const token = authHeader.substring(7)
    let decoded: any
    
    try {
      decoded = jwt.verify(token, process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024')
    } catch (error) {
      return NextResponse.json(
        { message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' },
        { status: 401 }
      )
    }

    // Check if user is admin
    if (decoded.role !== 'admin') {
      return NextResponse.json(
        { message: 'æƒé™ä¸è¶³' },
        { status: 403 }
      )
    }

    await connectDB()

    const body = await request.json()
    const { name, email, password, role, phone, department } = body

    // Validate required fields
    if (!name || !email || !password || !role) {
      return NextResponse.json(
        { message: 'å§“åã€é‚®ç®±ã€å¯†ç å’Œè§’è‰²éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      )
    }

    // Check if user already exists
    const existingUser = await User.findOne({ email })
    if (existingUser) {
      return NextResponse.json(
        { message: 'è¯¥é‚®ç®±å·²è¢«ä½¿ç”¨' },
        { status: 400 }
      )
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 12)

    // Create new user
    const user = new User({
      name,
      email,
      password: hashedPassword,
      role,
      phone,
      department,
    })

    await user.save()

    // Return user data without password
    const userData = {
      _id: user._id,
      name: user.name,
      email: user.email,
      role: user.role,
      phone: user.phone,
      department: user.department,
      isActive: user.isActive,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
    }

    return NextResponse.json({
      message: 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ',
      user: userData,
    })

  } catch (error) {
    console.error('Create user error:', error)
    
    if (error.code === 11000) {
      return NextResponse.json(
        { message: 'é‚®ç®±å·²å­˜åœ¨' },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    )
  }
}

================
File: src/app/auth/login/page.tsx
================
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { EyeIcon, EyeSlashIcon } from '@heroicons/react/24/outline'

export default function LoginPage() {
  const [formData, setFormData] = useState({
    email: '',
    password: '',
  })
  const [showPassword, setShowPassword] = useState(false)
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      })

      const data = await response.json()

      if (response.ok) {
        // Store token and redirect
        localStorage.setItem('token', data.token)
        localStorage.setItem('user', JSON.stringify(data.user))
        router.push('/dashboard')
      } else {
        setError(data.message || 'ç™»å½•å¤±è´¥')
      }
    } catch (error) {
      console.error('Login error:', error)
      setError('ç™»å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•')
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    })
  }

  const fillTestCredentials = (email: string) => {
    setFormData({
      email: email,
      password: '123456',
    })
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <Link href="/" className="flex justify-center">
            <h2 className="text-3xl font-bold text-primary-900">Health CRM</h2>
          </Link>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            ç™»å½•æ‚¨çš„è´¦æˆ·
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ{' '}
            <Link href="/auth/register" className="font-medium text-primary-600 hover:text-primary-500">
              ç«‹å³æ³¨å†Œ
            </Link>
          </p>
        </div>

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md">
              {error}
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label htmlFor="email" className="form-label">
                é‚®ç®±åœ°å€
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="form-input"
                placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
                value={formData.email}
                onChange={handleChange}
              />
            </div>

            <div>
              <label htmlFor="password" className="form-label">
                å¯†ç 
              </label>
              <div className="relative">
                <input
                  id="password"
                  name="password"
                  type={showPassword ? 'text' : 'password'}
                  autoComplete="current-password"
                  required
                  className="form-input pr-10"
                  placeholder="è¯·è¾“å…¥å¯†ç "
                  value={formData.password}
                  onChange={handleChange}
                />
                <button
                  type="button"
                  className="absolute inset-y-0 right-0 pr-3 flex items-center"
                  onClick={() => setShowPassword(!showPassword)}
                >
                  {showPassword ? (
                    <EyeSlashIcon className="h-5 w-5 text-gray-400" />
                  ) : (
                    <EyeIcon className="h-5 w-5 text-gray-400" />
                  )}
                </button>
              </div>
            </div>
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                è®°ä½æˆ‘
              </label>
            </div>

            <div className="text-sm">
              <Link href="/auth/forgot-password" className="font-medium text-primary-600 hover:text-primary-500">
                å¿˜è®°å¯†ç ï¼Ÿ
              </Link>
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
            </button>
          </div>

          <div className="mt-6">
            <div className="text-center">
              <p className="text-sm text-gray-600 mb-3">æµ‹è¯•è´¦æˆ·ï¼š</p>
              <div className="space-y-2">
                <button
                  type="button"
                  onClick={() => fillTestCredentials('admin@healthcrm.com')}
                  className="w-full text-left px-3 py-2 text-xs bg-blue-50 hover:bg-blue-100 rounded border border-blue-200"
                >
                  <span className="font-medium text-blue-800">ç®¡ç†å‘˜:</span> 
                  <span className="text-blue-600"> admin@healthcrm.com / 123456</span>
                </button>
                <button
                  type="button"
                  onClick={() => fillTestCredentials('dr.johnson@healthcrm.com')}
                  className="w-full text-left px-3 py-2 text-xs bg-green-50 hover:bg-green-100 rounded border border-green-200"
                >
                  <span className="font-medium text-green-800">åŒ»ç”Ÿ:</span> 
                  <span className="text-green-600"> dr.johnson@healthcrm.com / 123456</span>
                </button>
              </div>
              <p className="text-xs text-gray-500 mt-2">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¿«é€Ÿå¡«å…¥æµ‹è¯•è´¦æˆ·ä¿¡æ¯
              </p>
              <p className="text-xs text-red-500 mt-1">
                âš ï¸ æµ‹è¯•å¯†ç ï¼š123456
              </p>
            </div>
          </div>
        </form>
      </div>
    </div>
  )
}

================
File: src/app/dashboard/customers/new/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  ArrowLeftIcon,
  UserPlusIcon,
} from '@heroicons/react/24/outline'

interface SalesRep {
  _id: string
  name: string
  department: string
}

export default function NewCustomerPage() {
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    dateOfBirth: '',
    gender: '',
    customerType: 'potential',
    salesRep: '',
    followUp: {
      nextContactDate: '',
      priority: 'medium',
    },
    status: 'active',
    address: {
      street: '',
      city: '',
      state: '',
      zipCode: '',
      country: 'China',
    },
    healthProfile: {
      height: '',
      weight: '',
      chronicConditions: '',
      allergies: '',
      healthGoals: '',
    },
    interests: {
      budgetRange: '',
      purchaseFrequency: '',
    },
    notes: '',
  })
  
  const [salesReps, setSalesReps] = useState<SalesRep[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()

  useEffect(() => {
    loadSalesReps()
  }, [])

  const loadSalesReps = async () => {
    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/users?role=admin,system_admin', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      
      if (response.ok) {
        const data = await response.json()
        setSalesReps(data.users || [])
      }
    } catch (error) {
      console.error('Error loading sales reps:', error)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const token = localStorage.getItem('token')
      
      // Prepare data for submission
      const submissionData = {
        ...formData,
        healthProfile: {
          ...formData.healthProfile,
          height: formData.healthProfile.height ? Number(formData.healthProfile.height) : undefined,
          weight: formData.healthProfile.weight ? Number(formData.healthProfile.weight) : undefined,
          chronicConditions: formData.healthProfile.chronicConditions 
            ? formData.healthProfile.chronicConditions.split(',').map(s => s.trim()).filter(s => s)
            : [],
          allergies: formData.healthProfile.allergies 
            ? formData.healthProfile.allergies.split(',').map(s => s.trim()).filter(s => s)
            : [],
          healthGoals: formData.healthProfile.healthGoals 
            ? formData.healthProfile.healthGoals.split(',').map(s => s.trim()).filter(s => s)
            : [],
        }
      }

      const response = await fetch('/api/customers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(submissionData),
      })

      const data = await response.json()

      if (response.ok) {
        router.push('/dashboard/customers')
      } else {
        setError(data.message || 'åˆ›å»ºå®¢æˆ·å¤±è´¥')
      }
    } catch (error) {
      console.error('Create customer error:', error)
      setError('åˆ›å»ºæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•')
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target
    
    if (name.includes('.')) {
      const [parent, child] = name.split('.')
      setFormData(prev => ({
        ...prev,
        [parent]: {
          ...prev[parent as keyof typeof prev] as any,
          [child]: value,
        },
      }))
    } else {
      setFormData(prev => ({
        ...prev,
        [name]: value,
      }))
    }
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/dashboard/customers"
                className="p-2 text-gray-400 hover:text-gray-500"
              >
                <ArrowLeftIcon className="h-6 w-6" />
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">æ–°å¢å®¢æˆ·</h1>
                <p className="text-sm text-gray-500">åˆ›å»ºæ–°çš„å®¢æˆ·æ¡£æ¡ˆ</p>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          <form onSubmit={handleSubmit} className="space-y-8">
            {error && (
              <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md">
                {error}
              </div>
            )}

            {/* åŸºæœ¬ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">åŸºæœ¬ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">å§“ *</label>
                  <input
                    type="text"
                    name="lastName"
                    required
                    className="form-input"
                    value={formData.lastName}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å *</label>
                  <input
                    type="text"
                    name="firstName"
                    required
                    className="form-input"
                    value={formData.firstName}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">æ‰‹æœºå·ç  *</label>
                  <input
                    type="tel"
                    name="phone"
                    required
                    className="form-input"
                    value={formData.phone}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">é‚®ç®±</label>
                  <input
                    type="email"
                    name="email"
                    className="form-input"
                    value={formData.email}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                  <input
                    type="date"
                    name="dateOfBirth"
                    className="form-input"
                    value={formData.dateOfBirth}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">æ€§åˆ«</label>
                  <select
                    name="gender"
                    className="form-input"
                    value={formData.gender}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                    <option value="other">å…¶ä»–</option>
                  </select>
                </div>
              </div>
            </div>

            {/* å®¢æˆ·åˆ†ç±» */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">å®¢æˆ·åˆ†ç±»</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">å®¢æˆ·ç±»å‹</label>
                  <select
                    name="customerType"
                    className="form-input"
                    value={formData.customerType}
                    onChange={handleChange}
                  >
                    <option value="potential">æ½œåœ¨å®¢æˆ·</option>
                    <option value="new">æ–°å®¢æˆ·</option>
                    <option value="regular">å¸¸è§„å®¢æˆ·</option>
                    <option value="vip">VIPå®¢æˆ·</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">åˆ†é…é”€å”®</label>
                  <select
                    name="salesRep"
                    className="form-input"
                    value={formData.salesRep}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©é”€å”®ä»£è¡¨</option>
                    {salesReps.map((rep) => (
                      <option key={rep._id} value={rep._id}>
                        {rep.name} - {rep.department}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="form-label">ä¸‹æ¬¡è”ç³»æ—¥æœŸ</label>
                  <input
                    type="date"
                    name="followUp.nextContactDate"
                    className="form-input"
                    value={formData.followUp.nextContactDate}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">ä¼˜å…ˆçº§</label>
                  <select
                    name="followUp.priority"
                    className="form-input"
                    value={formData.followUp.priority}
                    onChange={handleChange}
                  >
                    <option value="low">ä½</option>
                    <option value="medium">ä¸­</option>
                    <option value="high">é«˜</option>
                    <option value="urgent">ç´§æ€¥</option>
                  </select>
                </div>
              </div>
            </div>

            {/* å¥åº·æ¡£æ¡ˆ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">å¥åº·æ¡£æ¡ˆ</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">èº«é«˜ (cm)</label>
                  <input
                    type="number"
                    name="healthProfile.height"
                    className="form-input"
                    value={formData.healthProfile.height}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">ä½“é‡ (kg)</label>
                  <input
                    type="number"
                    name="healthProfile.weight"
                    className="form-input"
                    value={formData.healthProfile.weight}
                    onChange={handleChange}
                  />
                </div>
                <div className="sm:col-span-2">
                  <label className="form-label">æ…¢æ€§ç–¾ç—… (ç”¨é€—å·åˆ†éš”)</label>
                  <input
                    type="text"
                    name="healthProfile.chronicConditions"
                    className="form-input"
                    placeholder="å¦‚ï¼šé«˜è¡€å‹, ç³–å°¿ç—…"
                    value={formData.healthProfile.chronicConditions}
                    onChange={handleChange}
                  />
                </div>
                <div className="sm:col-span-2">
                  <label className="form-label">è¿‡æ•å² (ç”¨é€—å·åˆ†éš”)</label>
                  <input
                    type="text"
                    name="healthProfile.allergies"
                    className="form-input"
                    placeholder="å¦‚ï¼šæµ·é²œ, èŠ±ç²‰"
                    value={formData.healthProfile.allergies}
                    onChange={handleChange}
                  />
                </div>
                <div className="sm:col-span-2">
                  <label className="form-label">å¥åº·ç›®æ ‡ (ç”¨é€—å·åˆ†éš”)</label>
                  <input
                    type="text"
                    name="healthProfile.healthGoals"
                    className="form-input"
                    placeholder="å¦‚ï¼šå‡è‚¥, å¢å¼ºå…ç–«åŠ›, æ”¹å–„ç¡çœ "
                    value={formData.healthProfile.healthGoals}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* å…´è¶£å’Œéœ€æ±‚ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">å…´è¶£å’Œéœ€æ±‚</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">é¢„ç®—èŒƒå›´</label>
                  <select
                    name="interests.budgetRange"
                    className="form-input"
                    value={formData.interests.budgetRange}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="under_500">500å…ƒä»¥ä¸‹</option>
                    <option value="500_1000">500-1000å…ƒ</option>
                    <option value="1000_2000">1000-2000å…ƒ</option>
                    <option value="2000_5000">2000-5000å…ƒ</option>
                    <option value="over_5000">5000å…ƒä»¥ä¸Š</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">è´­ä¹°é¢‘ç‡</label>
                  <select
                    name="interests.purchaseFrequency"
                    className="form-input"
                    value={formData.interests.purchaseFrequency}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="monthly">æ¯æœˆ</option>
                    <option value="quarterly">æ¯å­£åº¦</option>
                    <option value="semi_annually">æ¯åŠå¹´</option>
                    <option value="annually">æ¯å¹´</option>
                    <option value="irregular">ä¸å®šæœŸ</option>
                  </select>
                </div>
              </div>
            </div>

            {/* åœ°å€ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">åœ°å€ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div className="sm:col-span-2">
                  <label className="form-label">è¯¦ç»†åœ°å€</label>
                  <input
                    type="text"
                    name="address.street"
                    className="form-input"
                    value={formData.address.street}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">åŸå¸‚</label>
                  <input
                    type="text"
                    name="address.city"
                    className="form-input"
                    value={formData.address.city}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">çœä»½</label>
                  <input
                    type="text"
                    name="address.state"
                    className="form-input"
                    value={formData.address.state}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">é‚®ç¼–</label>
                  <input
                    type="text"
                    name="address.zipCode"
                    className="form-input"
                    value={formData.address.zipCode}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å›½å®¶</label>
                  <input
                    type="text"
                    name="address.country"
                    className="form-input"
                    value={formData.address.country}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* å¤‡æ³¨ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">å¤‡æ³¨</h3>
              <div>
                <label className="form-label">å®¢æˆ·å¤‡æ³¨</label>
                <textarea
                  name="notes"
                  rows={4}
                  className="form-input"
                  placeholder="è®°å½•å®¢æˆ·ç‰¹æ®Šæƒ…å†µã€åå¥½ç­‰..."
                  value={formData.notes}
                  onChange={handleChange}
                />
              </div>
            </div>

            {/* æäº¤æŒ‰é’® */}
            <div className="flex justify-end space-x-3">
              <Link
                href="/dashboard/customers"
                className="btn btn-secondary"
              >
                å–æ¶ˆ
              </Link>
              <button
                type="submit"
                disabled={loading}
                className="btn btn-primary flex items-center space-x-2"
              >
                <UserPlusIcon className="h-5 w-5" />
                <span>{loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºå®¢æˆ·'}</span>
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
  )
}

================
File: src/app/dashboard/customers/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  UserGroupIcon,
  PlusIcon,
  MagnifyingGlassIcon,
  EyeIcon,
  PencilIcon,
  TrashIcon,
  ArrowLeftIcon,
  FunnelIcon,
  ArrowUpIcon,
  ArrowDownIcon,
  ChatBubbleLeftRightIcon,
  ExclamationTriangleIcon,
} from '@heroicons/react/24/outline'

interface Customer {
  _id: string
  customerId: string
  firstName: string
  lastName: string
  email?: string
  phone: string
  dateOfBirth?: string
  gender?: string
  customerType: string
  salesRep?: {
    _id: string
    name: string
  }
  followUp: {
    nextContactDate?: string
    priority: string
    lastContactDate?: string
  }
  productUsage?: Array<{
    productName: string
    effectiveness?: number
    willContinue?: boolean
  }>
  status: string
  isActive: boolean
  createdAt: string
}

export default function CustomersPage() {
  const [customers, setCustomers] = useState<Customer[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [currentPage, setCurrentPage] = useState(1)
  const [totalPages, setTotalPages] = useState(1)
  const [sortField, setSortField] = useState('createdAt')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')
  
  // è¿‡æ»¤å™¨
  const [filterType, setFilterType] = useState('')
  const [filterPriority, setFilterPriority] = useState('')
  const [filterStatus, setFilterStatus] = useState('')
  const [filterSalesRep, setFilterSalesRep] = useState('')
  
  const [salesReps, setSalesReps] = useState<Array<{_id: string, name: string}>>([])
  const [activeTab, setActiveTab] = useState('all')
  
  const router = useRouter()

  const tabs = [
    { id: 'all', name: 'å…¨éƒ¨å®¢æˆ·', count: 0 },
    { id: 'potential', name: 'æ½œåœ¨å®¢æˆ·', count: 0 },
    { id: 'new', name: 'æ–°å®¢æˆ·', count: 0 },
    { id: 'regular', name: 'å¸¸è§„å®¢æˆ·', count: 0 },
    { id: 'vip', name: 'VIPå®¢æˆ·', count: 0 },
    { id: 'followup', name: 'éœ€è¦å›è®¿', count: 0 },
    { id: 'medication', name: 'äº§å“ä¸è¶³', count: 0 },
    { id: 'urgent', name: 'ç´§æ€¥å¤„ç†', count: 0 },
  ]

  useEffect(() => {
    loadCustomers()
    loadSalesReps()
  }, [currentPage, searchTerm, sortField, sortOrder, filterType, filterPriority, filterStatus, filterSalesRep, activeTab])

  const loadCustomers = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/auth/login')
        return
      }

      const queryParams = new URLSearchParams({
        page: currentPage.toString(),
        limit: '10',
        search: searchTerm,
        sortField,
        sortOrder,
        customerType: filterType,
        priority: filterPriority,
        status: filterStatus,
        salesRep: filterSalesRep,
        tab: activeTab,
      })

      const response = await fetch(`/api/customers?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        const data = await response.json()
        setCustomers(data.customers)
        setTotalPages(data.totalPages)
      } else if (response.status === 401) {
        router.push('/auth/login')
      }
    } catch (error) {
      console.error('Error loading customers:', error)
    } finally {
      setLoading(false)
    }
  }

  const loadSalesReps = async () => {
    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/users?role=admin,system_admin', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      
      if (response.ok) {
        const data = await response.json()
        setSalesReps(data.users || [])
      }
    } catch (error) {
      console.error('Error loading sales reps:', error)
    }
  }

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(e.target.value)
    setCurrentPage(1)
  }

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')
    } else {
      setSortField(field)
      setSortOrder('asc')
    }
    setCurrentPage(1)
  }

  const handleDeleteCustomer = async (customerId: string) => {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®¢æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
      return
    }

    try {
      const token = localStorage.getItem('token')
      const response = await fetch(`/api/customers/${customerId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        loadCustomers()
      } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    } catch (error) {
      console.error('Error deleting customer:', error)
      alert('åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯')
    }
  }

  const formatDate = (dateString?: string) => {
    if (!dateString) return '-'
    return new Date(dateString).toLocaleDateString('zh-CN')
  }

  const calculateAge = (dateOfBirth?: string) => {
    if (!dateOfBirth) return '-'
    const today = new Date()
    const birthDate = new Date(dateOfBirth)
    let age = today.getFullYear() - birthDate.getFullYear()
    const monthDiff = today.getMonth() - birthDate.getMonth()
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--
    }
    
    return age
  }

  const getCustomerTypeColor = (type: string) => {
    const colors = {
      potential: 'bg-gray-100 text-gray-800',
      new: 'bg-green-100 text-green-800',
      regular: 'bg-blue-100 text-blue-800',
      vip: 'bg-purple-100 text-purple-800',
      inactive: 'bg-red-100 text-red-800',
    }
    return colors[type as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const getPriorityColor = (priority: string) => {
    const colors = {
      low: 'bg-gray-100 text-gray-800',
      medium: 'bg-yellow-100 text-yellow-800',
      high: 'bg-orange-100 text-orange-800',
      urgent: 'bg-red-100 text-red-800',
    }
    return colors[priority as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const getStatusColor = (status: string) => {
    const colors = {
      active: 'bg-green-100 text-green-800',
      inactive: 'bg-gray-100 text-gray-800',
      blocked: 'bg-red-100 text-red-800',
    }
    return colors[status as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const isFollowUpDue = (date?: string) => {
    if (!date) return false
    const followUpDate = new Date(date)
    const today = new Date()
    return followUpDate <= today
  }

  const isProductLow = (productUsage?: Array<{effectiveness?: number}>) => {
    if (!productUsage) return false
    return productUsage.some(product => product.effectiveness && product.effectiveness <= 2)
  }

  const clearFilters = () => {
    setFilterType('')
    setFilterPriority('')
    setFilterStatus('')
    setFilterSalesRep('')
    setSearchTerm('')
    setCurrentPage(1)
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"></div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/dashboard"
                className="p-2 text-gray-400 hover:text-gray-500"
              >
                <ArrowLeftIcon className="h-6 w-6" />
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">å®¢æˆ·ç®¡ç†</h1>
                <p className="text-sm text-gray-500">ç®¡ç†å®¢æˆ·ä¿¡æ¯å’Œå¥åº·æ¡£æ¡ˆ</p>
              </div>
            </div>
            <Link
              href="/dashboard/customers/new"
              className="btn btn-primary flex items-center space-x-2"
            >
              <PlusIcon className="h-5 w-5" />
              <span>æ·»åŠ å®¢æˆ·</span>
            </Link>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          {/* Tabs */}
          <div className="border-b border-gray-200 mb-6">
            <nav className="-mb-px flex space-x-8 overflow-x-auto">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => {
                    setActiveTab(tab.id)
                    setCurrentPage(1)
                  }}
                  className={`py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${
                    activeTab === tab.id
                      ? 'border-primary-500 text-primary-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  {tab.name}
                </button>
              ))}
            </nav>
          </div>

          {/* Search and Filters */}
          <div className="mb-6 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0 sm:space-x-4">
              <div className="flex-1 max-w-lg">
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <MagnifyingGlassIcon className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    type="text"
                    className="form-input pl-10"
                    placeholder="æœç´¢å®¢æˆ·å§“åã€IDæˆ–ç”µè¯..."
                    value={searchTerm}
                    onChange={handleSearch}
                  />
                </div>
              </div>
              
              <div className="flex items-center space-x-2">
                <button
                  onClick={clearFilters}
                  className="btn btn-secondary text-sm"
                >
                  æ¸…é™¤è¿‡æ»¤
                </button>
              </div>
            </div>

            {/* Advanced Filters */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·ç±»å‹</label>
                <select
                  className="form-input"
                  value={filterType}
                  onChange={(e) => setFilterType(e.target.value)}
                >
                  <option value="">å…¨éƒ¨ç±»å‹</option>
                  <option value="potential">æ½œåœ¨å®¢æˆ·</option>
                  <option value="new">æ–°å®¢æˆ·</option>
                  <option value="regular">å¸¸è§„å®¢æˆ·</option>
                  <option value="vip">VIPå®¢æˆ·</option>
                  <option value="inactive">éæ´»è·ƒ</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
                <select
                  className="form-input"
                  value={filterPriority}
                  onChange={(e) => setFilterPriority(e.target.value)}
                >
                  <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                  <option value="urgent">ç´§æ€¥</option>
                  <option value="high">é«˜</option>
                  <option value="medium">ä¸­</option>
                  <option value="low">ä½</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
                <select
                  className="form-input"
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value)}
                >
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option value="active">æ´»è·ƒ</option>
                  <option value="inactive">éæ´»è·ƒ</option>
                  <option value="blocked">å·²åœç”¨</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">é”€å”®ä»£è¡¨</label>
                <select
                  className="form-input"
                  value={filterSalesRep}
                  onChange={(e) => setFilterSalesRep(e.target.value)}
                >
                  <option value="">å…¨éƒ¨é”€å”®</option>
                  {salesReps.map((rep) => (
                    <option key={rep._id} value={rep._id}>
                      {rep.name}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Customers Table */}
          <div className="bg-white shadow overflow-hidden sm:rounded-md">
            <div className="px-4 py-5 sm:p-6">
              <div className="flex items-center mb-4">
                <UserGroupIcon className="h-6 w-6 text-gray-400 mr-2" />
                <h3 className="text-lg font-medium text-gray-900">
                  å®¢æˆ·åˆ—è¡¨ ({customers.length} äºº)
                </h3>
              </div>

              {customers.length === 0 ? (
                <div className="text-center py-12">
                  <UserGroupIcon className="mx-auto h-12 w-12 text-gray-400" />
                  <h3 className="mt-2 text-sm font-medium text-gray-900">
                    æš‚æ— å®¢æˆ·
                  </h3>
                  <p className="mt-1 text-sm text-gray-500">
                    å¼€å§‹æ·»åŠ å®¢æˆ·æ¥ç®¡ç†ä»–ä»¬çš„ä¿¡æ¯ã€‚
                  </p>
                  <div className="mt-6">
                    <Link
                      href="/dashboard/customers/new"
                      className="btn btn-primary"
                    >
                      <PlusIcon className="h-5 w-5 mr-2" />
                      æ·»åŠ å®¢æˆ·
                    </Link>
                  </div>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('firstName')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>å®¢æˆ·ä¿¡æ¯</span>
                            {sortField === 'firstName' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          è”ç³»æ–¹å¼
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          å¹´é¾„/æ€§åˆ«
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('customerType')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>ç±»å‹/ä¼˜å…ˆçº§</span>
                            {sortField === 'customerType' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('followUp.nextContactDate')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>å›è®¿æ—¥æœŸ</span>
                            {sortField === 'followUp.nextContactDate' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          é”€å”®ä»£è¡¨
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          çŠ¶æ€/æé†’
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          æ“ä½œ
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {customers.map((customer) => (
                        <tr key={customer._id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div>
                              <div className="text-sm font-medium text-gray-900">
                                {customer.firstName} {customer.lastName}
                              </div>
                              <div className="text-sm text-gray-500">
                                ID: {customer.customerId}
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {customer.phone}
                            </div>
                            <div className="text-sm text-gray-500">
                              {customer.email || '-'}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {calculateAge(customer.dateOfBirth)} å²
                            </div>
                            <div className="text-sm text-gray-500">
                              {customer.gender === 'male' ? 'ç”·' : customer.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="space-y-1">
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getCustomerTypeColor(customer.customerType)}`}>
                                {customer.customerType === 'potential' ? 'æ½œåœ¨' : customer.customerType === 'new' ? 'æ–°' : customer.customerType === 'regular' ? 'å¸¸è§„' : customer.customerType === 'vip' ? 'VIP' : 'éæ´»è·ƒ'}
                              </span>
                              <br />
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityColor(customer.followUp.priority)}`}>
                                {customer.followUp.priority === 'low' ? 'ä½' : customer.followUp.priority === 'medium' ? 'ä¸­' : customer.followUp.priority === 'high' ? 'é«˜' : 'ç´§æ€¥'}
                              </span>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {customer.followUp.nextContactDate ? (
                                <div className={`flex items-center space-x-1 ${isFollowUpDue(customer.followUp.nextContactDate) ? 'text-red-600' : ''}`}>
                                  <ChatBubbleLeftRightIcon className="h-4 w-4" />
                                  <span>{formatDate(customer.followUp.nextContactDate)}</span>
                                  {isFollowUpDue(customer.followUp.nextContactDate) && (
                                    <ExclamationTriangleIcon className="h-4 w-4 text-red-500" />
                                  )}
                                </div>
                              ) : (
                                <span className="text-gray-400">æœªå®‰æ’</span>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {customer.salesRep ? (
                                <div>{customer.salesRep.name}</div>
                              ) : (
                                <span className="text-gray-400">æœªæŒ‡å®š</span>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="space-y-1">
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(customer.status)}`}>
                                {customer.status === 'active' ? 'æ´»è·ƒ' : customer.status === 'inactive' ? 'éæ´»è·ƒ' : 'å·²åœç”¨'}
                              </span>
                              {isProductLow(customer.productUsage) && (
                                <div className="flex items-center space-x-1 text-orange-600">
                                  <ExclamationTriangleIcon className="h-4 w-4" />
                                  <span className="text-xs">äº§å“æ•ˆæœå·®</span>
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex items-center space-x-2">
                              <Link
                                href={`/dashboard/customers/${customer._id}`}
                                className="text-primary-600 hover:text-primary-900"
                                title="æŸ¥çœ‹è¯¦æƒ…"
                              >
                                <EyeIcon className="h-5 w-5" />
                              </Link>
                              <Link
                                href={`/dashboard/customers/${customer._id}/edit`}
                                className="text-yellow-600 hover:text-yellow-900"
                                title="ç¼–è¾‘"
                              >
                                <PencilIcon className="h-5 w-5" />
                              </Link>
                              <button
                                onClick={() => handleDeleteCustomer(customer._id)}
                                className="text-red-600 hover:text-red-900"
                                title="åˆ é™¤"
                              >
                                <TrashIcon className="h-5 w-5" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}

              {/* Pagination */}
              {totalPages > 1 && (
                <div className="mt-6 flex items-center justify-between">
                  <div className="flex-1 flex justify-between sm:hidden">
                    <button
                      onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                      disabled={currentPage === 1}
                      className="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸Šä¸€é¡µ
                    </button>
                    <button
                      onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                      disabled={currentPage === totalPages}
                      className="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸‹ä¸€é¡µ
                    </button>
                  </div>
                  <div className="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                      <p className="text-sm text-gray-700">
                        ç¬¬ <span className="font-medium">{currentPage}</span> é¡µï¼Œå…±{' '}
                        <span className="font-medium">{totalPages}</span> é¡µ
                      </p>
                    </div>
                    <div>
                      <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        <button
                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                          disabled={currentPage === 1}
                          className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸Šä¸€é¡µ
                        </button>
                        <button
                          onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                          disabled={currentPage === totalPages}
                          className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸‹ä¸€é¡µ
                        </button>
                      </nav>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>
    </div>
  )
}

================
File: src/app/dashboard/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  UserGroupIcon,
  ShoppingBagIcon,
  ClipboardDocumentListIcon,
  CurrencyDollarIcon,
  ChartBarIcon,
  BellIcon,
  Cog6ToothIcon,
  ArrowRightOnRectangleIcon,
  UsersIcon,
  HeartIcon,
  ChatBubbleLeftRightIcon,
} from '@heroicons/react/24/outline'

interface User {
  id: string
  name: string
  email: string
  role: string
  department: string
}

interface DashboardStats {
  totalCustomers: number
  newCustomers: number
  pendingFollowUps: number
  totalRevenue: number
}

export default function DashboardPage() {
  const [user, setUser] = useState<User | null>(null)
  const [stats, setStats] = useState<DashboardStats>({
    totalCustomers: 0,
    newCustomers: 0,
    pendingFollowUps: 0,
    totalRevenue: 0,
  })
  const [loading, setLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    // Check if user is logged in
    const token = localStorage.getItem('token')
    const userData = localStorage.getItem('user')
    
    if (!token || !userData) {
      router.push('/auth/login')
      return
    }

    try {
      const parsedUser = JSON.parse(userData)
      setUser(parsedUser)
      loadDashboardStats()
    } catch (error) {
      console.error('Error parsing user data:', error)
      router.push('/auth/login')
    }
  }, [router])

  const loadDashboardStats = async () => {
    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/dashboard/stats', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        const data = await response.json()
        setStats(data)
      }
    } catch (error) {
      console.error('Error loading dashboard stats:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleLogout = () => {
    localStorage.removeItem('token')
    localStorage.removeItem('user')
    router.push('/')
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"></div>
      </div>
    )
  }

  const menuItems = [
    {
      name: 'å®¢æˆ·ç®¡ç†',
      href: '/dashboard/customers',
      icon: UserGroupIcon,
      description: 'ç®¡ç†å®¢æˆ·ä¿¡æ¯å’Œå¥åº·æ¡£æ¡ˆ',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'å•†å“ç®¡ç†',
      href: '/dashboard/products',
      icon: ShoppingBagIcon,
      description: 'USANAäº§å“ç®¡ç†',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'æœç”¨è®¡åˆ’',
      href: '/dashboard/plans',
      icon: HeartIcon,
      description: 'å¥åº·è®¡åˆ’æ¨¡æ¿ç®¡ç†',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'è´­ä¹°è®°å½•',
      href: '/dashboard/purchases',
      icon: CurrencyDollarIcon,
      description: 'å®¢æˆ·è´­ä¹°è®°å½•ç®¡ç†',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'å›è®¿è®°å½•',
      href: '/dashboard/follow-ups',
      icon: ChatBubbleLeftRightIcon,
      description: 'å®¢æˆ·å›è®¿å’Œåé¦ˆç®¡ç†',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'ç”¨æˆ·ç®¡ç†',
      href: '/dashboard/users',
      icon: UsersIcon,
      description: 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™',
      roles: ['system_admin'],
    },
    {
      name: 'æ•°æ®åˆ†æ',
      href: '/dashboard/analytics',
      icon: ChartBarIcon,
      description: 'é”€å”®æŠ¥è¡¨å’Œç»Ÿè®¡',
      roles: ['system_admin', 'admin'],
    },
    {
      name: 'ç³»ç»Ÿè®¾ç½®',
      href: '/dashboard/settings',
      icon: Cog6ToothIcon,
      description: 'ç³»ç»Ÿé…ç½®',
      roles: ['system_admin'],
    },
  ]

  const filteredMenuItems = menuItems.filter(item => 
    item.roles.includes(user?.role || '')
  )

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center">
              <Link href="/dashboard" className="text-2xl font-bold text-primary-900">
                Health CRM
              </Link>
            </div>
            <div className="flex items-center space-x-4">
              <button className="p-2 text-gray-400 hover:text-gray-500">
                <BellIcon className="h-6 w-6" />
              </button>
              <div className="flex items-center space-x-3">
                <div className="text-right">
                  <p className="text-sm font-medium text-gray-900">{user?.name}</p>
                  <p className="text-xs text-gray-500">{user?.role}</p>
                </div>
                <button
                  onClick={handleLogout}
                  className="p-2 text-gray-400 hover:text-gray-500"
                  title="é€€å‡ºç™»å½•"
                >
                  <ArrowRightOnRectangleIcon className="h-6 w-6" />
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {/* Welcome Section */}
        <div className="px-4 py-6 sm:px-0">
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900">
              æ¬¢è¿å›æ¥ï¼Œ{user?.name}
            </h1>
            <p className="mt-1 text-gray-600">
              {user?.department} - {user?.role}
            </p>
          </div>

          {/* Stats Cards */}
          <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <UserGroupIcon className="h-6 w-6 text-gray-400" />
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">
                        æ€»å®¢æˆ·æ•°
                      </dt>
                      <dd className="text-lg font-medium text-gray-900">
                        {stats.totalCustomers}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <UserGroupIcon className="h-6 w-6 text-green-400" />
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">
                        æ–°å¢å®¢æˆ·
                      </dt>
                      <dd className="text-lg font-medium text-gray-900">
                        {stats.newCustomers}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <ChatBubbleLeftRightIcon className="h-6 w-6 text-yellow-400" />
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">
                        å¾…å›è®¿å®¢æˆ·
                      </dt>
                      <dd className="text-lg font-medium text-gray-900">
                        {stats.pendingFollowUps}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <ChartBarIcon className="h-6 w-6 text-gray-400" />
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">
                        æœˆé”€å”®é¢
                      </dt>
                      <dd className="text-lg font-medium text-gray-900">
                        Â¥{stats.totalRevenue.toLocaleString()}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {filteredMenuItems.map((item) => (
              <Link
                key={item.name}
                href={item.href}
                className="relative group bg-white p-6 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 rounded-lg shadow hover:shadow-md transition-shadow duration-200"
              >
                <div>
                  <span className="rounded-lg inline-flex p-3 bg-primary-50 text-primary-600 group-hover:bg-primary-100">
                    <item.icon className="h-6 w-6" aria-hidden="true" />
                  </span>
                </div>
                <div className="mt-4">
                  <h3 className="text-lg font-medium text-gray-900">
                    {item.name}
                  </h3>
                  <p className="mt-2 text-sm text-gray-500">
                    {item.description}
                  </p>
                </div>
                <span
                  className="pointer-events-none absolute top-6 right-6 text-gray-300 group-hover:text-gray-400"
                  aria-hidden="true"
                >
                  <svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586l-4.293 4.293z" />
                  </svg>
                </span>
              </Link>
            ))}
          </div>

          {/* Quick Stats for Urgent Items */}
          {(user?.role === 'system_admin' || user?.role === 'admin') && (
            <div className="mt-8 bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-4">éœ€è¦å…³æ³¨çš„äº‹é¡¹</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <ChatBubbleLeftRightIcon className="h-5 w-5 text-red-400" />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-red-800">éœ€è¦å›è®¿</p>
                      <p className="text-sm text-red-600">5 ä½å®¢æˆ·</p>
                    </div>
                  </div>
                </div>
                
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <HeartIcon className="h-5 w-5 text-yellow-400" />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-yellow-800">äº§å“ä½™é‡ä¸è¶³</p>
                      <p className="text-sm text-yellow-600">3 ä½å®¢æˆ·</p>
                    </div>
                  </div>
                </div>
                
                <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <UserGroupIcon className="h-5 w-5 text-orange-400" />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-orange-800">é«˜ä»·å€¼å®¢æˆ·</p>
                      <p className="text-sm text-orange-600">2 ä½å®¢æˆ·</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>
    </div>
  )
}

================
File: src/app/dashboard/patients/new/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  ArrowLeftIcon,
  UserPlusIcon,
} from '@heroicons/react/24/outline'

interface Doctor {
  _id: string
  name: string
  department: string
}

export default function NewPatientPage() {
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    dateOfBirth: '',
    gender: '',
    patientType: 'regular',
    priority: 'medium',
    status: 'active',
    assignedDoctor: '',
    nextFollowUpDate: '',
    notes: '',
    address: {
      street: '',
      city: '',
      state: '',
      zipCode: '',
      country: 'China',
    },
    emergencyContact: {
      name: '',
      relationship: '',
      phone: '',
    },
    insurance: {
      provider: '',
      policyNumber: '',
      groupNumber: '',
    },
  })
  
  const [doctors, setDoctors] = useState<Doctor[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()

  useEffect(() => {
    loadDoctors()
  }, [])

  const loadDoctors = async () => {
    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/users?role=doctor', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      
      if (response.ok) {
        const data = await response.json()
        setDoctors(data.users || [])
      }
    } catch (error) {
      console.error('Error loading doctors:', error)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/patients', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(formData),
      })

      const data = await response.json()

      if (response.ok) {
        router.push('/dashboard/patients')
      } else {
        setError(data.message || 'åˆ›å»ºæ‚£è€…å¤±è´¥')
      }
    } catch (error) {
      console.error('Create patient error:', error)
      setError('åˆ›å»ºæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•')
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target
    
    if (name.includes('.')) {
      const [parent, child] = name.split('.')
      setFormData(prev => ({
        ...prev,
        [parent]: {
          ...prev[parent as keyof typeof prev] as any,
          [child]: value,
        },
      }))
    } else {
      setFormData(prev => ({
        ...prev,
        [name]: value,
      }))
    }
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/dashboard/patients"
                className="p-2 text-gray-400 hover:text-gray-500"
              >
                <ArrowLeftIcon className="h-6 w-6" />
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">æ–°å¢æ‚£è€…</h1>
                <p className="text-sm text-gray-500">åˆ›å»ºæ–°çš„æ‚£è€…æ¡£æ¡ˆ</p>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          <form onSubmit={handleSubmit} className="space-y-8">
            {error && (
              <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md">
                {error}
              </div>
            )}

            {/* åŸºæœ¬ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">åŸºæœ¬ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">å§“ *</label>
                  <input
                    type="text"
                    name="lastName"
                    required
                    className="form-input"
                    value={formData.lastName}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å *</label>
                  <input
                    type="text"
                    name="firstName"
                    required
                    className="form-input"
                    value={formData.firstName}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">æ‰‹æœºå·ç  *</label>
                  <input
                    type="tel"
                    name="phone"
                    required
                    className="form-input"
                    value={formData.phone}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">é‚®ç®±</label>
                  <input
                    type="email"
                    name="email"
                    className="form-input"
                    value={formData.email}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å‡ºç”Ÿæ—¥æœŸ *</label>
                  <input
                    type="date"
                    name="dateOfBirth"
                    required
                    className="form-input"
                    value={formData.dateOfBirth}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">æ€§åˆ« *</label>
                  <select
                    name="gender"
                    required
                    className="form-input"
                    value={formData.gender}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                    <option value="other">å…¶ä»–</option>
                  </select>
                </div>
              </div>
            </div>

            {/* åŒ»ç–—ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">åŒ»ç–—ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label className="form-label">æ‚£è€…ç±»å‹</label>
                  <select
                    name="patientType"
                    className="form-input"
                    value={formData.patientType}
                    onChange={handleChange}
                  >
                    <option value="regular">æ™®é€šæ‚£è€…</option>
                    <option value="vip">VIPæ‚£è€…</option>
                    <option value="emergency">æ€¥è¯Šæ‚£è€…</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">ä¼˜å…ˆçº§</label>
                  <select
                    name="priority"
                    className="form-input"
                    value={formData.priority}
                    onChange={handleChange}
                  >
                    <option value="low">ä½</option>
                    <option value="medium">ä¸­</option>
                    <option value="high">é«˜</option>
                    <option value="urgent">ç´§æ€¥</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">æŒ‡å®šåŒ»ç”Ÿ</label>
                  <select
                    name="assignedDoctor"
                    className="form-input"
                    value={formData.assignedDoctor}
                    onChange={handleChange}
                  >
                    <option value="">è¯·é€‰æ‹©åŒ»ç”Ÿ</option>
                    {doctors.map((doctor) => (
                      <option key={doctor._id} value={doctor._id}>
                        {doctor.name} - {doctor.department}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="form-label">ä¸‹æ¬¡å›è®¿æ—¥æœŸ</label>
                  <input
                    type="date"
                    name="nextFollowUpDate"
                    className="form-input"
                    value={formData.nextFollowUpDate}
                    onChange={handleChange}
                  />
                </div>
                <div className="sm:col-span-2">
                  <label className="form-label">ç‰¹æ®Šå¤‡æ³¨</label>
                  <textarea
                    name="notes"
                    rows={3}
                    className="form-input"
                    value={formData.notes}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* åœ°å€ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">åœ°å€ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div className="sm:col-span-2">
                  <label className="form-label">è¯¦ç»†åœ°å€</label>
                  <input
                    type="text"
                    name="address.street"
                    className="form-input"
                    value={formData.address.street}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">åŸå¸‚</label>
                  <input
                    type="text"
                    name="address.city"
                    className="form-input"
                    value={formData.address.city}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">çœä»½</label>
                  <input
                    type="text"
                    name="address.state"
                    className="form-input"
                    value={formData.address.state}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">é‚®ç¼–</label>
                  <input
                    type="text"
                    name="address.zipCode"
                    className="form-input"
                    value={formData.address.zipCode}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å›½å®¶</label>
                  <input
                    type="text"
                    name="address.country"
                    className="form-input"
                    value={formData.address.country}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* ç´§æ€¥è”ç³»äºº */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">ç´§æ€¥è”ç³»äºº</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                  <label className="form-label">å§“å</label>
                  <input
                    type="text"
                    name="emergencyContact.name"
                    className="form-input"
                    value={formData.emergencyContact.name}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">å…³ç³»</label>
                  <input
                    type="text"
                    name="emergencyContact.relationship"
                    className="form-input"
                    value={formData.emergencyContact.relationship}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">ç”µè¯</label>
                  <input
                    type="tel"
                    name="emergencyContact.phone"
                    className="form-input"
                    value={formData.emergencyContact.phone}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* ä¿é™©ä¿¡æ¯ */}
            <div className="bg-white shadow rounded-lg p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">ä¿é™©ä¿¡æ¯</h3>
              <div className="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                  <label className="form-label">ä¿é™©å…¬å¸</label>
                  <input
                    type="text"
                    name="insurance.provider"
                    className="form-input"
                    value={formData.insurance.provider}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">ä¿å•å·</label>
                  <input
                    type="text"
                    name="insurance.policyNumber"
                    className="form-input"
                    value={formData.insurance.policyNumber}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label className="form-label">ç¾¤ç»„å·</label>
                  <input
                    type="text"
                    name="insurance.groupNumber"
                    className="form-input"
                    value={formData.insurance.groupNumber}
                    onChange={handleChange}
                  />
                </div>
              </div>
            </div>

            {/* æäº¤æŒ‰é’® */}
            <div className="flex justify-end space-x-3">
              <Link
                href="/dashboard/patients"
                className="btn btn-secondary"
              >
                å–æ¶ˆ
              </Link>
              <button
                type="submit"
                disabled={loading}
                className="btn btn-primary flex items-center space-x-2"
              >
                <UserPlusIcon className="h-5 w-5" />
                <span>{loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºæ‚£è€…'}</span>
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
  )
}

================
File: src/app/dashboard/patients/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  UserGroupIcon,
  PlusIcon,
  MagnifyingGlassIcon,
  EyeIcon,
  PencilIcon,
  TrashIcon,
  ArrowLeftIcon,
  FunnelIcon,
  ArrowUpIcon,
  ArrowDownIcon,
  CalendarIcon,
  ExclamationTriangleIcon,
} from '@heroicons/react/24/outline'

interface Patient {
  _id: string
  patientId: string
  firstName: string
  lastName: string
  email: string
  phone: string
  dateOfBirth: string
  gender: string
  patientType: string
  priority: string
  status: string
  lastVisitDate?: string
  nextFollowUpDate?: string
  assignedDoctor?: {
    _id: string
    name: string
    department: string
  }
  medications?: Array<{
    name: string
    remainingDays?: number
  }>
  address: {
    street?: string
    city?: string
    state?: string
    zipCode?: string
    country?: string
  }
  isActive: boolean
  createdAt: string
}

export default function PatientsPage() {
  const [patients, setPatients] = useState<Patient[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [currentPage, setCurrentPage] = useState(1)
  const [totalPages, setTotalPages] = useState(1)
  const [sortField, setSortField] = useState('createdAt')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')
  
  // è¿‡æ»¤å™¨
  const [filterType, setFilterType] = useState('')
  const [filterPriority, setFilterPriority] = useState('')
  const [filterStatus, setFilterStatus] = useState('')
  const [filterDoctor, setFilterDoctor] = useState('')
  
  const [doctors, setDoctors] = useState<Array<{_id: string, name: string}>>([])
  const [activeTab, setActiveTab] = useState('all')
  
  const router = useRouter()

  const tabs = [
    { id: 'all', name: 'å…¨éƒ¨æ‚£è€…', count: 0 },
    { id: 'followup', name: 'éœ€è¦å›è®¿', count: 0 },
    { id: 'medication', name: 'è¯ç‰©ä¸è¶³', count: 0 },
    { id: 'urgent', name: 'ç´§æ€¥å¤„ç†', count: 0 },
  ]

  useEffect(() => {
    loadPatients()
    loadDoctors()
  }, [currentPage, searchTerm, sortField, sortOrder, filterType, filterPriority, filterStatus, filterDoctor, activeTab])

  const loadPatients = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/auth/login')
        return
      }

      const queryParams = new URLSearchParams({
        page: currentPage.toString(),
        limit: '10',
        search: searchTerm,
        sortField,
        sortOrder,
        type: filterType,
        priority: filterPriority,
        status: filterStatus,
        doctor: filterDoctor,
        tab: activeTab,
      })

      const response = await fetch(`/api/patients?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        const data = await response.json()
        setPatients(data.patients)
        setTotalPages(data.totalPages)
      } else if (response.status === 401) {
        router.push('/auth/login')
      }
    } catch (error) {
      console.error('Error loading patients:', error)
    } finally {
      setLoading(false)
    }
  }

  const loadDoctors = async () => {
    try {
      const token = localStorage.getItem('token')
      const response = await fetch('/api/users?role=doctor', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })
      
      if (response.ok) {
        const data = await response.json()
        setDoctors(data.users || [])
      }
    } catch (error) {
      console.error('Error loading doctors:', error)
    }
  }

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(e.target.value)
    setCurrentPage(1)
  }

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')
    } else {
      setSortField(field)
      setSortOrder('asc')
    }
    setCurrentPage(1)
  }

  const handleDeletePatient = async (patientId: string) => {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ‚£è€…å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
      return
    }

    try {
      const token = localStorage.getItem('token')
      const response = await fetch(`/api/patients/${patientId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        loadPatients()
      } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    } catch (error) {
      console.error('Error deleting patient:', error)
      alert('åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯')
    }
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('zh-CN')
  }

  const calculateAge = (dateOfBirth: string) => {
    const today = new Date()
    const birthDate = new Date(dateOfBirth)
    let age = today.getFullYear() - birthDate.getFullYear()
    const monthDiff = today.getMonth() - birthDate.getMonth()
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--
    }
    
    return age
  }

  const getPatientTypeColor = (type: string) => {
    const colors = {
      regular: 'bg-blue-100 text-blue-800',
      vip: 'bg-purple-100 text-purple-800',
      emergency: 'bg-red-100 text-red-800',
    }
    return colors[type as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const getPriorityColor = (priority: string) => {
    const colors = {
      low: 'bg-gray-100 text-gray-800',
      medium: 'bg-yellow-100 text-yellow-800',
      high: 'bg-orange-100 text-orange-800',
      urgent: 'bg-red-100 text-red-800',
    }
    return colors[priority as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const getStatusColor = (status: string) => {
    const colors = {
      active: 'bg-green-100 text-green-800',
      inactive: 'bg-gray-100 text-gray-800',
      discharged: 'bg-blue-100 text-blue-800',
      deceased: 'bg-red-100 text-red-800',
    }
    return colors[status as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const isFollowUpDue = (date?: string) => {
    if (!date) return false
    const followUpDate = new Date(date)
    const today = new Date()
    return followUpDate <= today
  }

  const isMedicationLow = (medications?: Array<{remainingDays?: number}>) => {
    if (!medications) return false
    return medications.some(med => med.remainingDays && med.remainingDays <= 7)
  }

  const clearFilters = () => {
    setFilterType('')
    setFilterPriority('')
    setFilterStatus('')
    setFilterDoctor('')
    setSearchTerm('')
    setCurrentPage(1)
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"></div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/dashboard"
                className="p-2 text-gray-400 hover:text-gray-500"
              >
                <ArrowLeftIcon className="h-6 w-6" />
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">æ‚£è€…ç®¡ç†</h1>
                <p className="text-sm text-gray-500">ç®¡ç†æ‚£è€…ä¿¡æ¯å’Œæ¡£æ¡ˆ</p>
              </div>
            </div>
            <Link
              href="/dashboard/patients/new"
              className="btn btn-primary flex items-center space-x-2"
            >
              <PlusIcon className="h-5 w-5" />
              <span>æ·»åŠ æ‚£è€…</span>
            </Link>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          {/* Tabs */}
          <div className="border-b border-gray-200 mb-6">
            <nav className="-mb-px flex space-x-8">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => {
                    setActiveTab(tab.id)
                    setCurrentPage(1)
                  }}
                  className={`py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${
                    activeTab === tab.id
                      ? 'border-primary-500 text-primary-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  {tab.name}
                </button>
              ))}
            </nav>
          </div>

          {/* Search and Filters */}
          <div className="mb-6 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0 sm:space-x-4">
              <div className="flex-1 max-w-lg">
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <MagnifyingGlassIcon className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    type="text"
                    className="form-input pl-10"
                    placeholder="æœç´¢æ‚£è€…å§“åã€IDæˆ–ç”µè¯..."
                    value={searchTerm}
                    onChange={handleSearch}
                  />
                </div>
              </div>
              
              <div className="flex items-center space-x-2">
                <button
                  onClick={clearFilters}
                  className="btn btn-secondary text-sm"
                >
                  æ¸…é™¤è¿‡æ»¤
                </button>
              </div>
            </div>

            {/* Advanced Filters */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æ‚£è€…ç±»å‹</label>
                <select
                  className="form-input"
                  value={filterType}
                  onChange={(e) => setFilterType(e.target.value)}
                >
                  <option value="">å…¨éƒ¨ç±»å‹</option>
                  <option value="regular">æ™®é€šæ‚£è€…</option>
                  <option value="vip">VIPæ‚£è€…</option>
                  <option value="emergency">æ€¥è¯Šæ‚£è€…</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
                <select
                  className="form-input"
                  value={filterPriority}
                  onChange={(e) => setFilterPriority(e.target.value)}
                >
                  <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                  <option value="urgent">ç´§æ€¥</option>
                  <option value="high">é«˜</option>
                  <option value="medium">ä¸­</option>
                  <option value="low">ä½</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
                <select
                  className="form-input"
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value)}
                >
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option value="active">æ´»è·ƒ</option>
                  <option value="inactive">éæ´»è·ƒ</option>
                  <option value="discharged">å·²å‡ºé™¢</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æŒ‡å®šåŒ»ç”Ÿ</label>
                <select
                  className="form-input"
                  value={filterDoctor}
                  onChange={(e) => setFilterDoctor(e.target.value)}
                >
                  <option value="">å…¨éƒ¨åŒ»ç”Ÿ</option>
                  {doctors.map((doctor) => (
                    <option key={doctor._id} value={doctor._id}>
                      {doctor.name}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Patients Table */}
          <div className="bg-white shadow overflow-hidden sm:rounded-md">
            <div className="px-4 py-5 sm:p-6">
              <div className="flex items-center mb-4">
                <UserGroupIcon className="h-6 w-6 text-gray-400 mr-2" />
                <h3 className="text-lg font-medium text-gray-900">
                  æ‚£è€…åˆ—è¡¨ ({patients.length} äºº)
                </h3>
              </div>

              {patients.length === 0 ? (
                <div className="text-center py-12">
                  <UserGroupIcon className="mx-auto h-12 w-12 text-gray-400" />
                  <h3 className="mt-2 text-sm font-medium text-gray-900">
                    æš‚æ— æ‚£è€…
                  </h3>
                  <p className="mt-1 text-sm text-gray-500">
                    å¼€å§‹æ·»åŠ æ‚£è€…æ¥ç®¡ç†ä»–ä»¬çš„ä¿¡æ¯ã€‚
                  </p>
                  <div className="mt-6">
                    <Link
                      href="/dashboard/patients/new"
                      className="btn btn-primary"
                    >
                      <PlusIcon className="h-5 w-5 mr-2" />
                      æ·»åŠ æ‚£è€…
                    </Link>
                  </div>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('firstName')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>æ‚£è€…ä¿¡æ¯</span>
                            {sortField === 'firstName' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          è”ç³»æ–¹å¼
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          å¹´é¾„/æ€§åˆ«
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('patientType')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>ç±»å‹/ä¼˜å…ˆçº§</span>
                            {sortField === 'patientType' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('nextFollowUpDate')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>å›è®¿æ—¥æœŸ</span>
                            {sortField === 'nextFollowUpDate' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          æŒ‡å®šåŒ»ç”Ÿ
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          çŠ¶æ€/æé†’
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          æ“ä½œ
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {patients.map((patient) => (
                        <tr key={patient._id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div>
                              <div className="text-sm font-medium text-gray-900">
                                {patient.firstName} {patient.lastName}
                              </div>
                              <div className="text-sm text-gray-500">
                                ID: {patient.patientId}
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {patient.phone}
                            </div>
                            <div className="text-sm text-gray-500">
                              {patient.email}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {calculateAge(patient.dateOfBirth)} å²
                            </div>
                            <div className="text-sm text-gray-500">
                              {patient.gender === 'male' ? 'ç”·' : patient.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="space-y-1">
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPatientTypeColor(patient.patientType)}`}>
                                {patient.patientType === 'regular' ? 'æ™®é€š' : patient.patientType === 'vip' ? 'VIP' : 'æ€¥è¯Š'}
                              </span>
                              <br />
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityColor(patient.priority)}`}>
                                {patient.priority === 'low' ? 'ä½' : patient.priority === 'medium' ? 'ä¸­' : patient.priority === 'high' ? 'é«˜' : 'ç´§æ€¥'}
                              </span>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {patient.nextFollowUpDate ? (
                                <div className={`flex items-center space-x-1 ${isFollowUpDue(patient.nextFollowUpDate) ? 'text-red-600' : ''}`}>
                                  <CalendarIcon className="h-4 w-4" />
                                  <span>{formatDate(patient.nextFollowUpDate)}</span>
                                  {isFollowUpDue(patient.nextFollowUpDate) && (
                                    <ExclamationTriangleIcon className="h-4 w-4 text-red-500" />
                                  )}
                                </div>
                              ) : (
                                <span className="text-gray-400">æœªå®‰æ’</span>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {patient.assignedDoctor ? (
                                <div>
                                  <div>{patient.assignedDoctor.name}</div>
                                  <div className="text-xs text-gray-500">{patient.assignedDoctor.department}</div>
                                </div>
                              ) : (
                                <span className="text-gray-400">æœªæŒ‡å®š</span>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="space-y-1">
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(patient.status)}`}>
                                {patient.status === 'active' ? 'æ´»è·ƒ' : patient.status === 'inactive' ? 'éæ´»è·ƒ' : 'å·²å‡ºé™¢'}
                              </span>
                              {isMedicationLow(patient.medications) && (
                                <div className="flex items-center space-x-1 text-orange-600">
                                  <ExclamationTriangleIcon className="h-4 w-4" />
                                  <span className="text-xs">è¯ç‰©ä¸è¶³</span>
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex items-center space-x-2">
                              <Link
                                href={`/dashboard/patients/${patient._id}`}
                                className="text-primary-600 hover:text-primary-900"
                                title="æŸ¥çœ‹è¯¦æƒ…"
                              >
                                <EyeIcon className="h-5 w-5" />
                              </Link>
                              <Link
                                href={`/dashboard/patients/${patient._id}/edit`}
                                className="text-yellow-600 hover:text-yellow-900"
                                title="ç¼–è¾‘"
                              >
                                <PencilIcon className="h-5 w-5" />
                              </Link>
                              <button
                                onClick={() => handleDeletePatient(patient._id)}
                                className="text-red-600 hover:text-red-900"
                                title="åˆ é™¤"
                              >
                                <TrashIcon className="h-5 w-5" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}

              {/* Pagination */}
              {totalPages > 1 && (
                <div className="mt-6 flex items-center justify-between">
                  <div className="flex-1 flex justify-between sm:hidden">
                    <button
                      onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                      disabled={currentPage === 1}
                      className="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸Šä¸€é¡µ
                    </button>
                    <button
                      onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                      disabled={currentPage === totalPages}
                      className="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸‹ä¸€é¡µ
                    </button>
                  </div>
                  <div className="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                      <p className="text-sm text-gray-700">
                        ç¬¬ <span className="font-medium">{currentPage}</span> é¡µï¼Œå…±{' '}
                        <span className="font-medium">{totalPages}</span> é¡µ
                      </p>
                    </div>
                    <div>
                      <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        <button
                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                          disabled={currentPage === 1}
                          className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸Šä¸€é¡µ
                        </button>
                        <button
                          onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                          disabled={currentPage === totalPages}
                          className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸‹ä¸€é¡µ
                        </button>
                      </nav>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>
    </div>
  )
}

================
File: src/app/dashboard/users/page.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import {
  UserGroupIcon,
  PlusIcon,
  MagnifyingGlassIcon,
  EyeIcon,
  PencilIcon,
  TrashIcon,
  ArrowLeftIcon,
  FunnelIcon,
  ArrowUpIcon,
  ArrowDownIcon,
} from '@heroicons/react/24/outline'

interface User {
  _id: string
  name: string
  email: string
  role: string
  phone: string
  department: string
  isActive: boolean
  createdAt: string
  updatedAt: string
}

interface CurrentUser {
  role: string
}

export default function UsersPage() {
  const [users, setUsers] = useState<User[]>([])
  const [currentUser, setCurrentUser] = useState<CurrentUser | null>(null)
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [currentPage, setCurrentPage] = useState(1)
  const [totalPages, setTotalPages] = useState(1)
  const [activeTab, setActiveTab] = useState('all')
  const [sortField, setSortField] = useState('createdAt')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')
  const [filterDepartment, setFilterDepartment] = useState('')
  const router = useRouter()

  const tabs = [
    { id: 'all', name: 'å…¨éƒ¨ç”¨æˆ·', count: 0 },
    { id: 'admins', name: 'ç®¡ç†å‘˜', count: 0 },
    { id: 'customer', name: 'å®¢æˆ·', count: 0 },
  ]

  useEffect(() => {
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    const userData = localStorage.getItem('user')
    if (userData) {
      setCurrentUser(JSON.parse(userData))
    }
    loadUsers()
  }, [currentPage, searchTerm, activeTab, sortField, sortOrder, filterDepartment])

  const loadUsers = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/auth/login')
        return
      }

      let roleFilter = ''
      if (activeTab === 'admins') {
        roleFilter = 'system_admin,admin'
      } else if (activeTab === 'customer') {
        roleFilter = 'customer'
      }

      const queryParams = new URLSearchParams({
        page: currentPage.toString(),
        limit: '10',
        search: searchTerm,
        role: roleFilter,
        sortField,
        sortOrder,
        department: filterDepartment,
      })

      const response = await fetch(`/api/users?${queryParams}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        const data = await response.json()
        setUsers(data.users)
        setTotalPages(data.totalPages)
      } else if (response.status === 401) {
        router.push('/auth/login')
      }
    } catch (error) {
      console.error('Error loading users:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(e.target.value)
    setCurrentPage(1)
  }

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')
    } else {
      setSortField(field)
      setSortOrder('asc')
    }
    setCurrentPage(1)
  }

  const handleDeleteUser = async (userId: string) => {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
      return
    }

    try {
      const token = localStorage.getItem('token')
      const response = await fetch(`/api/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      if (response.ok) {
        loadUsers()
      } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    } catch (error) {
      console.error('Error deleting user:', error)
      alert('åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯')
    }
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('zh-CN')
  }

  const getRoleColor = (role: string) => {
    const colors = {
      system_admin: 'bg-red-100 text-red-800',
      admin: 'bg-blue-100 text-blue-800',
      customer: 'bg-green-100 text-green-800',
    }
    return colors[role as keyof typeof colors] || 'bg-gray-100 text-gray-800'
  }

  const getRoleName = (role: string) => {
    const names = {
      system_admin: 'ç³»ç»Ÿç®¡ç†å‘˜',
      admin: 'ç®¡ç†å‘˜',
      customer: 'å®¢æˆ·',
    }
    return names[role as keyof typeof names] || role
  }

  const canEditUser = (user: User) => {
    if (!currentUser) return false
    // ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘æ‰€æœ‰ç”¨æˆ·ï¼Œç®¡ç†å‘˜åªèƒ½ç¼–è¾‘å®¢æˆ·
    if (currentUser.role === 'system_admin') return true
    if (currentUser.role === 'admin' && user.role === 'customer') return true
    return false
  }

  const canDeleteUser = (user: User) => {
    if (!currentUser) return false
    // ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ é™¤éç³»ç»Ÿç®¡ç†å‘˜çš„ç”¨æˆ·ï¼Œç®¡ç†å‘˜åªèƒ½åˆ é™¤å®¢æˆ·
    if (currentUser.role === 'system_admin' && user.role !== 'system_admin') return true
    if (currentUser.role === 'admin' && user.role === 'customer') return true
    return false
  }

  const departments = [...new Set(users.map(user => user.department).filter(Boolean))]

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"></div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/dashboard"
                className="p-2 text-gray-400 hover:text-gray-500"
              >
                <ArrowLeftIcon className="h-6 w-6" />
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">ç”¨æˆ·ç®¡ç†</h1>
                <p className="text-sm text-gray-500">ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™</p>
              </div>
            </div>
            {currentUser?.role === 'system_admin' && (
              <Link
                href="/dashboard/users/new"
                className="btn btn-primary flex items-center space-x-2"
              >
                <PlusIcon className="h-5 w-5" />
                <span>æ·»åŠ ç”¨æˆ·</span>
              </Link>
            )}
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          {/* Tabs */}
          <div className="border-b border-gray-200 mb-6">
            <nav className="-mb-px flex space-x-8">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => {
                    setActiveTab(tab.id)
                    setCurrentPage(1)
                  }}
                  className={`py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${
                    activeTab === tab.id
                      ? 'border-primary-500 text-primary-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  {tab.name}
                </button>
              ))}
            </nav>
          </div>

          {/* Search and Filters */}
          <div className="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            <div className="flex-1 max-w-lg">
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <MagnifyingGlassIcon className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  className="form-input pl-10"
                  placeholder="æœç´¢ç”¨æˆ·å§“åã€é‚®ç®±æˆ–ç”µè¯..."
                  value={searchTerm}
                  onChange={handleSearch}
                />
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-2">
                <FunnelIcon className="h-5 w-5 text-gray-400" />
                <select
                  className="form-input py-2"
                  value={filterDepartment}
                  onChange={(e) => setFilterDepartment(e.target.value)}
                >
                  <option value="">æ‰€æœ‰éƒ¨é—¨</option>
                  {departments.map((dept) => (
                    <option key={dept} value={dept}>{dept}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Users Table */}
          <div className="bg-white shadow overflow-hidden sm:rounded-md">
            <div className="px-4 py-5 sm:p-6">
              <div className="flex items-center mb-4">
                <UserGroupIcon className="h-6 w-6 text-gray-400 mr-2" />
                <h3 className="text-lg font-medium text-gray-900">
                  ç”¨æˆ·åˆ—è¡¨ ({users.length} äºº)
                </h3>
              </div>

              {users.length === 0 ? (
                <div className="text-center py-12">
                  <UserGroupIcon className="mx-auto h-12 w-12 text-gray-400" />
                  <h3 className="mt-2 text-sm font-medium text-gray-900">
                    æš‚æ— ç”¨æˆ·
                  </h3>
                  <p className="mt-1 text-sm text-gray-500">
                    å¼€å§‹æ·»åŠ ç”¨æˆ·æ¥ç®¡ç†ç³»ç»Ÿæƒé™ã€‚
                  </p>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('name')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>ç”¨æˆ·ä¿¡æ¯</span>
                            {sortField === 'name' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('role')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>è§’è‰²/éƒ¨é—¨</span>
                            {sortField === 'role' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          è”ç³»æ–¹å¼
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          çŠ¶æ€
                        </th>
                        <th 
                          className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                          onClick={() => handleSort('createdAt')}
                        >
                          <div className="flex items-center space-x-1">
                            <span>åˆ›å»ºæ—¶é—´</span>
                            {sortField === 'createdAt' && (
                              sortOrder === 'asc' ? <ArrowUpIcon className="h-4 w-4" /> : <ArrowDownIcon className="h-4 w-4" />
                            )}
                          </div>
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          æ“ä½œ
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {users.map((user) => (
                        <tr key={user._id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div>
                              <div className="text-sm font-medium text-gray-900">
                                {user.name}
                              </div>
                              <div className="text-sm text-gray-500">
                                {user.email}
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div>
                              <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleColor(user.role)}`}>
                                {getRoleName(user.role)}
                              </span>
                              <div className="text-sm text-gray-500 mt-1">
                                {user.department}
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="text-sm text-gray-900">
                              {user.phone}
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                              user.isActive 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                            }`}>
                              {user.isActive ? 'æ´»è·ƒ' : 'åœç”¨'}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {formatDate(user.createdAt)}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex items-center space-x-2">
                              <Link
                                href={`/dashboard/users/${user._id}`}
                                className="text-primary-600 hover:text-primary-900"
                                title="æŸ¥çœ‹è¯¦æƒ…"
                              >
                                <EyeIcon className="h-5 w-5" />
                              </Link>
                              {canEditUser(user) && (
                                <Link
                                  href={`/dashboard/users/${user._id}/edit`}
                                  className="text-yellow-600 hover:text-yellow-900"
                                  title="ç¼–è¾‘"
                                >
                                  <PencilIcon className="h-5 w-5" />
                                </Link>
                              )}
                              {canDeleteUser(user) && (
                                <button
                                  onClick={() => handleDeleteUser(user._id)}
                                  className="text-red-600 hover:text-red-900"
                                  title="åˆ é™¤"
                                >
                                  <TrashIcon className="h-5 w-5" />
                                </button>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}

              {/* Pagination */}
              {totalPages > 1 && (
                <div className="mt-6 flex items-center justify-between">
                  <div className="flex-1 flex justify-between sm:hidden">
                    <button
                      onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                      disabled={currentPage === 1}
                      className="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸Šä¸€é¡µ
                    </button>
                    <button
                      onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                      disabled={currentPage === totalPages}
                      className="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
                    >
                      ä¸‹ä¸€é¡µ
                    </button>
                  </div>
                  <div className="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                      <p className="text-sm text-gray-700">
                        ç¬¬ <span className="font-medium">{currentPage}</span> é¡µï¼Œå…±{' '}
                        <span className="font-medium">{totalPages}</span> é¡µ
                      </p>
                    </div>
                    <div>
                      <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        <button
                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                          disabled={currentPage === 1}
                          className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸Šä¸€é¡µ
                        </button>
                        <button
                          onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                          disabled={currentPage === totalPages}
                          className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                        >
                          ä¸‹ä¸€é¡µ
                        </button>
                      </nav>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>
    </div>
  )
}

================
File: src/app/globals.css
================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    font-family: system-ui, sans-serif;
  }
}

@layer components {
  .btn {
    @apply px-4 py-2 rounded-lg font-medium transition-colors duration-200;
  }
  
  .btn-primary {
    @apply bg-primary-600 text-white hover:bg-primary-700 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2;
  }
  
  .btn-secondary {
    @apply bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2;
  }
  
  .btn-danger {
    @apply bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
  }
  
  .form-input {
    @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500;
  }
  
  .form-label {
    @apply block text-sm font-medium text-gray-700 mb-1;
  }
  
  .card {
    @apply bg-white rounded-lg shadow-md border border-gray-200;
  }
  
  .card-header {
    @apply px-6 py-4 border-b border-gray-200;
  }
  
  .card-body {
    @apply px-6 py-4;
  }
}

================
File: src/app/layout.tsx
================
import './globals.css'
import { Inter } from 'next/font/google'

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'Health CRM',
  description: 'Healthcare Customer Relationship Management System',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <div className="min-h-screen bg-gray-50">
          {children}
        </div>
      </body>
    </html>
  )
}

================
File: src/app/page.tsx
================
import Link from 'next/link'
import { 
  UserGroupIcon, 
  ShoppingBagIcon,
  HeartIcon,
  CurrencyDollarIcon,
  ChartBarIcon,
  Cog6ToothIcon,
  ChatBubbleLeftRightIcon
} from '@heroicons/react/24/outline'

export default function Home() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-primary-50 to-blue-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center">
              <h1 className="text-3xl font-bold text-primary-900">Health CRM</h1>
            </div>
            <div className="flex items-center space-x-4">
              <Link
                href="/auth/login"
                className="btn btn-secondary"
              >
                ç™»å½•
              </Link>
              <Link
                href="/auth/register"
                className="btn btn-primary"
              >
                æ³¨å†Œ
              </Link>
            </div>
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div className="text-center">
          <h2 className="text-4xl font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
            USANAä¿å¥å“
            <span className="text-primary-600">å®¢æˆ·å…³ç³»ç®¡ç†</span>
          </h2>
          <p className="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
            ä¸“ä¸ºUSANAä¿å¥å“é”€å”®äººå‘˜æ‰“é€ çš„å®¢æˆ·å¥åº·ä¸æ¶ˆè´¹ç®¡ç†ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ
          </p>
          <div className="mt-5 max-w-md mx-auto sm:flex sm:justify-center md:mt-8">
            <div className="rounded-md shadow">
              <Link
                href="/dashboard"
                className="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 md:py-4 md:text-lg md:px-10"
              >
                è¿›å…¥ç³»ç»Ÿ
              </Link>
            </div>
          </div>
        </div>

        {/* Features Grid */}
        <div className="mt-16">
          <div className="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {/* Customer Management */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <UserGroupIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">å®¢æˆ·ç®¡ç†</h3>
                <p className="mt-2 text-base text-gray-500">
                  å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯ç®¡ç†ï¼ŒåŒ…æ‹¬å¥åº·æ¡£æ¡ˆã€æ¶ˆè´¹è®°å½•ç­‰
                </p>
              </div>
            </div>

            {/* Product Management */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <ShoppingBagIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">å•†å“ç®¡ç†</h3>
                <p className="mt-2 text-base text-gray-500">
                  USANAä¿å¥å“ä¿¡æ¯ç®¡ç†ï¼Œæ”¯æŒåˆ†ç±»å’Œæœç´¢åŠŸèƒ½
                </p>
              </div>
            </div>

            {/* Health Plans */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <HeartIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">æœç”¨è®¡åˆ’</h3>
                <p className="mt-2 text-base text-gray-500">
                  é’ˆå¯¹å®¢æˆ·å¥åº·çŠ¶å†µåˆ¶å®šä¸ªæ€§åŒ–çš„ä¿å¥å“æœç”¨è®¡åˆ’
                </p>
              </div>
            </div>

            {/* Purchase Records */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <CurrencyDollarIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">è´­ä¹°è®°å½•</h3>
                <p className="mt-2 text-base text-gray-500">
                  å®¢æˆ·è´­ä¹°å†å²è®°å½•ï¼Œæ”¯æŒæ¶ˆè´¹æ½œåŠ›åˆ†æå’Œè·Ÿè¸ª
                </p>
              </div>
            </div>

            {/* Follow-up Records */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <ChatBubbleLeftRightIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">å›è®¿è®°å½•</h3>
                <p className="mt-2 text-base text-gray-500">
                  å®¢æˆ·å›è®¿å’Œåé¦ˆç®¡ç†ï¼Œè·Ÿè¸ªäº§å“ä½¿ç”¨æ•ˆæœ
                </p>
              </div>
            </div>

            {/* Analytics */}
            <div className="card">
              <div className="card-body text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-md bg-primary-500 text-white">
                  <ChartBarIcon className="h-6 w-6" />
                </div>
                <h3 className="mt-4 text-lg font-medium text-gray-900">æ•°æ®åˆ†æ</h3>
                <p className="mt-2 text-base text-gray-500">
                  é”€å”®æ•°æ®æŠ¥è¡¨å’Œåˆ†æï¼Œå¸®åŠ©ä¼˜åŒ–é”€å”®ç­–ç•¥
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Stats Section */}
        <div className="mt-16">
          <div className="bg-white rounded-lg shadow-md p-8">
            <div className="text-center">
              <h3 className="text-2xl font-bold text-gray-900">ç³»ç»Ÿæ¦‚è§ˆ</h3>
              <p className="mt-2 text-gray-600">ä¸€ä½“åŒ–åŒ»ç–—ç®¡ç†è§£å†³æ–¹æ¡ˆ</p>
            </div>
            <div className="mt-8 grid grid-cols-2 gap-8 md:grid-cols-4">
              <div className="text-center">
                <div className="text-3xl font-bold text-primary-600">500+</div>
                <div className="text-sm text-gray-500">æ´»è·ƒæ‚£è€…</div>
              </div>
              <div className="text-center">
                <div className="text-3xl font-bold text-primary-600">1200+</div>
                <div className="text-sm text-gray-500">é¢„çº¦è®°å½•</div>
              </div>
              <div className="text-center">
                <div className="text-3xl font-bold text-primary-600">50+</div>
                <div className="text-sm text-gray-500">åŒ»æŠ¤äººå‘˜</div>
              </div>
              <div className="text-center">
                <div className="text-3xl font-bold text-primary-600">98%</div>
                <div className="text-sm text-gray-500">å®¢æˆ·æ»¡æ„åº¦</div>
              </div>
            </div>
          </div>
        </div>
      </main>

      {/* Footer */}
      <footer className="bg-white">
        <div className="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
          <div className="text-center">
            <p className="text-base text-gray-500">
              Â© 2024 Health CRM. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚
            </p>
          </div>
        </div>
      </footer>
    </div>
  )
}

================
File: src/lib/auth.ts
================
import jwt from 'jsonwebtoken'
import { NextRequest } from 'next/server'

export interface JWTPayload {
  userId: string
  email: string
  role: string
  iat: number
  exp: number
}

export function verifyToken(request: NextRequest): JWTPayload | null {
  try {
    const authHeader = request.headers.get('authorization')
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return null
    }

    const token = authHeader.substring(7)
    const decoded = jwt.verify(
      token, 
      process.env.NEXTAUTH_SECRET || 'health-crm-secret-key-2024'
    ) as JWTPayload

    return decoded
  } catch (error) {
    console.error('Token verification error:', error)
    return null
  }
}

export function requireAuth(request: NextRequest) {
  const decoded = verifyToken(request)
  
  if (!decoded) {
    throw new Error('Unauthorized')
  }
  
  return decoded
}

export function requireRole(request: NextRequest, allowedRoles: string[]) {
  const decoded = requireAuth(request)
  
  if (!allowedRoles.includes(decoded.role)) {
    throw new Error('Forbidden')
  }
  
  return decoded
}

================
File: src/lib/mongodb.ts
================
import mongoose from 'mongoose';

const MONGODB_URI = process.env.MONGODB_URI!;
const DB_NAME = process.env.DB_NAME!;

if (!MONGODB_URI) {
  throw new Error('Please define the MONGODB_URI environment variable inside .env.local');
}

let cached = global.mongoose;

if (!cached) {
  cached = global.mongoose = { conn: null, promise: null };
}

async function connectDB() {
  if (cached.conn) {
    return cached.conn;
  }

  if (!cached.promise) {
    const opts = {
      bufferCommands: false,
      dbName: DB_NAME,
    };

    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {
      return mongoose;
    });
  }

  try {
    cached.conn = await cached.promise;
  } catch (e) {
    cached.promise = null;
    throw e;
  }

  return cached.conn;
}

export default connectDB;

================
File: src/lib/types.ts
================
// Global types for the application
declare global {
  var mongoose: any
}

export interface User {
  _id: string
  name: string
  email: string
  role: 'admin' | 'doctor' | 'nurse' | 'receptionist'
  phone?: string
  department?: string
  isActive: boolean
  createdAt: string
  updatedAt: string
}

export interface Patient {
  _id: string
  patientId: string
  firstName: string
  lastName: string
  email?: string
  phone: string
  dateOfBirth: string
  gender: 'male' | 'female' | 'other'
  address: {
    street?: string
    city?: string
    state?: string
    zipCode?: string
    country?: string
  }
  emergencyContact?: {
    name?: string
    relationship?: string
    phone?: string
  }
  insurance?: {
    provider?: string
    policyNumber?: string
    groupNumber?: string
  }
  medicalHistory?: Array<{
    condition: string
    diagnosedDate: string
    notes?: string
  }>
  allergies?: Array<{
    allergen: string
    severity: 'mild' | 'moderate' | 'severe'
    notes?: string
  }>
  medications?: Array<{
    name: string
    dosage: string
    frequency: string
    startDate: string
    endDate?: string
    prescribedBy: string
  }>
  isActive: boolean
  createdAt: string
  updatedAt: string
}

export interface Appointment {
  _id: string
  appointmentId: string
  patient: string | Patient
  doctor: string | User
  appointmentDate: string
  startTime: string
  endTime: string
  type: 'consultation' | 'follow-up' | 'checkup' | 'emergency' | 'procedure'
  status: 'scheduled' | 'confirmed' | 'in-progress' | 'completed' | 'cancelled' | 'no-show'
  department?: string
  room?: string
  notes?: string
  symptoms?: string[]
  reasonForVisit?: string
  cancellationReason?: string
  isRecurring: boolean
  recurringPattern?: {
    frequency: 'daily' | 'weekly' | 'monthly'
    interval: number
    endDate?: string
  }
  createdAt: string
  updatedAt: string
}

export interface MedicalRecord {
  _id: string
  recordId: string
  patient: string | Patient
  appointment?: string | Appointment
  doctor: string | User
  visitDate: string
  chiefComplaint?: string
  presentIllness?: string
  vitalSigns?: {
    temperature?: number
    bloodPressure?: {
      systolic?: number
      diastolic?: number
    }
    heartRate?: number
    respiratoryRate?: number
    weight?: number
    height?: number
    bmi?: number
  }
  physicalExamination?: string
  diagnosis?: Array<{
    primary: boolean
    code?: string
    description: string
    notes?: string
  }>
  treatment?: {
    medications?: Array<{
      name: string
      dosage: string
      frequency: string
      duration: string
      instructions: string
    }>
    procedures?: Array<{
      name: string
      description: string
      performedBy: string
      date: string
    }>
    recommendations?: string[]
  }
  labResults?: Array<{
    testName: string
    result: string
    normalRange: string
    unit: string
    date: string
    notes?: string
  }>
  followUp?: {
    required: boolean
    date?: string
    instructions?: string
  }
  notes?: string
  createdAt: string
  updatedAt: string
}

export interface Billing {
  _id: string
  invoiceId: string
  patient: string | Patient
  appointment?: string | Appointment
  medicalRecord?: string | MedicalRecord
  serviceDate: string
  services: Array<{
    code?: string
    description: string
    quantity: number
    unitPrice: number
    total: number
  }>
  subtotal: number
  tax: number
  discount: number
  totalAmount: number
  insurance?: {
    provider?: string
    claimNumber?: string
    coverage?: number
    approvedAmount?: number
    deductible?: number
    copay?: number
  }
  patientPayment?: {
    amount?: number
    method?: 'cash' | 'card' | 'check' | 'bank-transfer' | 'insurance'
    transactionId?: string
    date?: string
  }
  status: 'pending' | 'partial' | 'paid' | 'overdue' | 'cancelled'
  dueDate?: string
  notes?: string
  createdAt: string
  updatedAt: string
}

export interface DashboardStats {
  totalPatients: number
  todayAppointments: number
  pendingBills: number
  totalRevenue: number
}

export interface ApiResponse<T> {
  message: string
  data?: T
  error?: string
}

export interface PaginatedResponse<T> {
  items: T[]
  currentPage: number
  totalPages: number
  totalCount: number
  hasNext: boolean
  hasPrev: boolean
}

================
File: src/models/Appointment.ts
================
import mongoose from 'mongoose';

const appointmentSchema = new mongoose.Schema({
  appointmentId: {
    type: String,
    unique: true,
    required: true,
  },
  patient: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Patient',
    required: true,
  },
  doctor: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
  },
  appointmentDate: {
    type: Date,
    required: true,
  },
  startTime: {
    type: String,
    required: true,
  },
  endTime: {
    type: String,
    required: true,
  },
  type: {
    type: String,
    enum: ['consultation', 'follow-up', 'checkup', 'emergency', 'procedure'],
    required: true,
  },
  status: {
    type: String,
    enum: ['scheduled', 'confirmed', 'in-progress', 'completed', 'cancelled', 'no-show'],
    default: 'scheduled',
  },
  department: String,
  room: String,
  notes: String,
  symptoms: [String],
  reasonForVisit: String,
  cancellationReason: String,
  isRecurring: {
    type: Boolean,
    default: false,
  },
  recurringPattern: {
    frequency: {
      type: String,
      enum: ['daily', 'weekly', 'monthly'],
    },
    interval: Number,
    endDate: Date,
  },
}, {
  timestamps: true,
});

export default mongoose.models.Appointment || mongoose.model('Appointment', appointmentSchema);

================
File: src/models/Billing.ts
================
import mongoose from 'mongoose';

const billingSchema = new mongoose.Schema({
  invoiceId: {
    type: String,
    unique: true,
    required: true,
  },
  patient: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Patient',
    required: true,
  },
  appointment: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Appointment',
  },
  medicalRecord: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'MedicalRecord',
  },
  serviceDate: {
    type: Date,
    required: true,
  },
  services: [{
    code: String, // CPT code
    description: String,
    quantity: {
      type: Number,
      default: 1,
    },
    unitPrice: Number,
    total: Number,
  }],
  subtotal: {
    type: Number,
    required: true,
  },
  tax: {
    type: Number,
    default: 0,
  },
  discount: {
    type: Number,
    default: 0,
  },
  totalAmount: {
    type: Number,
    required: true,
  },
  insurance: {
    provider: String,
    claimNumber: String,
    coverage: Number, // percentage
    approvedAmount: Number,
    deductible: Number,
    copay: Number,
  },
  patientPayment: {
    amount: Number,
    method: {
      type: String,
      enum: ['cash', 'card', 'check', 'bank-transfer', 'insurance'],
    },
    transactionId: String,
    date: Date,
  },
  status: {
    type: String,
    enum: ['pending', 'partial', 'paid', 'overdue', 'cancelled'],
    default: 'pending',
  },
  dueDate: Date,
  notes: String,
}, {
  timestamps: true,
});

export default mongoose.models.Billing || mongoose.model('Billing', billingSchema);

================
File: src/models/Customer.ts
================
import mongoose from 'mongoose';

const customerSchema = new mongoose.Schema({
  customerId: {
    type: String,
    unique: true,
    required: true,
  },
  // åŸºæœ¬ä¿¡æ¯
  firstName: {
    type: String,
    required: true,
  },
  lastName: {
    type: String,
    required: true,
  },
  email: String,
  phone: {
    type: String,
    required: true,
  },
  dateOfBirth: Date,
  gender: {
    type: String,
    enum: ['male', 'female', 'other'],
  },
  
  // å®¢æˆ·åˆ†ç±»
  customerType: {
    type: String,
    enum: ['potential', 'new', 'regular', 'vip', 'inactive'],
    default: 'potential',
  },
  
  // é”€å”®ç›¸å…³
  salesRep: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User', // åˆ†é…çš„é”€å”®ä»£è¡¨
  },
  referredBy: String, // æ¨èäºº
  leadSource: {
    type: String,
    enum: ['website', 'referral', 'social_media', 'event', 'cold_call', 'advertisement', 'other'],
    default: 'other',
  },
  
  // å¥åº·æ¡£æ¡ˆ
  healthProfile: {
    height: Number, // cm
    weight: Number, // kg
    bmi: Number,
    bloodType: String,
    chronicConditions: [String], // æ…¢æ€§ç–¾ç—…
    allergies: [String], // è¿‡æ•å²
    currentMedications: [String], // å½“å‰ç”¨è¯
    healthGoals: [String], // å¥åº·ç›®æ ‡
    dietaryRestrictions: [String], // é¥®é£Ÿé™åˆ¶
  },
  
  // USANAäº§å“ä½¿ç”¨æƒ…å†µ
  productUsage: [{
    productName: String,
    productCode: String,
    startDate: Date,
    endDate: Date,
    dosage: String,
    frequency: String,
    purpose: String, // ä½¿ç”¨ç›®çš„
    effectiveness: {
      type: Number,
      min: 1,
      max: 5, // 1-5åˆ†æ•ˆæœè¯„ä»·
    },
    sideEffects: String,
    willContinue: Boolean,
    notes: String,
  }],
  
  // è´­ä¹°å†å²
  purchaseHistory: [{
    orderDate: Date,
    products: [{
      productName: String,
      productCode: String,
      quantity: Number,
      unitPrice: Number,
      totalPrice: Number,
    }],
    totalAmount: Number,
    paymentMethod: String,
    orderStatus: {
      type: String,
      enum: ['pending', 'paid', 'shipped', 'delivered', 'cancelled'],
      default: 'pending',
    },
  }],
  
  // æ²Ÿé€šè®°å½•
  communicationHistory: [{
    date: Date,
    type: {
      type: String,
      enum: ['phone', 'email', 'meeting', 'message', 'visit'],
    },
    purpose: {
      type: String,
      enum: ['consultation', 'follow_up', 'sales', 'support', 'complaint'],
    },
    content: String,
    outcome: String,
    nextAction: String,
    contactedBy: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
    },
  }],
  
  // è·Ÿè¿›ç®¡ç†
  followUp: {
    nextContactDate: Date,
    frequency: {
      type: String,
      enum: ['weekly', 'biweekly', 'monthly', 'quarterly', 'as_needed'],
      default: 'monthly',
    },
    priority: {
      type: String,
      enum: ['low', 'medium', 'high', 'urgent'],
      default: 'medium',
    },
    notes: String,
    lastContactDate: Date,
  },
  
  // å…´è¶£å’Œéœ€æ±‚
  interests: {
    productCategories: [String], // æ„Ÿå…´è¶£çš„äº§å“ç±»åˆ«
    healthConcerns: [String], // å¥åº·å…³æ³¨ç‚¹
    budgetRange: {
      type: String,
      enum: ['under_500', '500_1000', '1000_2000', '2000_5000', 'over_5000'],
    },
    purchaseFrequency: {
      type: String,
      enum: ['monthly', 'quarterly', 'semi_annually', 'annually', 'irregular'],
    },
  },
  
  // åœ°å€ä¿¡æ¯
  address: {
    street: String,
    city: String,
    state: String,
    zipCode: String,
    country: String,
  },
  
  // çŠ¶æ€ç®¡ç†
  status: {
    type: String,
    enum: ['active', 'inactive', 'blocked'],
    default: 'active',
  },
  
  // è¯„åˆ†å’Œæ ‡ç­¾
  customerValue: {
    type: Number,
    min: 1,
    max: 5, // å®¢æˆ·ä»·å€¼è¯„åˆ†
    default: 3,
  },
  tags: [String], // è‡ªå®šä¹‰æ ‡ç­¾
  notes: String, // å¤‡æ³¨
  
  isActive: {
    type: Boolean,
    default: true,
  },
}, {
  timestamps: true,
});

// æ·»åŠ ç´¢å¼•
customerSchema.index({ customerId: 1 });
customerSchema.index({ email: 1 });
customerSchema.index({ phone: 1 });
customerSchema.index({ salesRep: 1 });
customerSchema.index({ customerType: 1 });
customerSchema.index({ 'followUp.nextContactDate': 1 });
customerSchema.index({ 'followUp.priority': 1 });

export default mongoose.models.Customer || mongoose.model('Customer', customerSchema);

================
File: src/models/MedicalRecord.ts
================
import mongoose from 'mongoose';

const medicalRecordSchema = new mongoose.Schema({
  recordId: {
    type: String,
    unique: true,
    required: true,
  },
  patient: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Patient',
    required: true,
  },
  appointment: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Appointment',
  },
  doctor: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
  },
  visitDate: {
    type: Date,
    required: true,
  },
  chiefComplaint: String,
  presentIllness: String,
  vitalSigns: {
    temperature: Number,
    bloodPressure: {
      systolic: Number,
      diastolic: Number,
    },
    heartRate: Number,
    respiratoryRate: Number,
    weight: Number,
    height: Number,
    bmi: Number,
  },
  physicalExamination: String,
  diagnosis: [{
    primary: Boolean,
    code: String, // ICD-10 code
    description: String,
    notes: String,
  }],
  treatment: {
    medications: [{
      name: String,
      dosage: String,
      frequency: String,
      duration: String,
      instructions: String,
    }],
    procedures: [{
      name: String,
      description: String,
      performedBy: String,
      date: Date,
    }],
    recommendations: [String],
  },
  labResults: [{
    testName: String,
    result: String,
    normalRange: String,
    unit: String,
    date: Date,
    notes: String,
  }],
  followUp: {
    required: Boolean,
    date: Date,
    instructions: String,
  },
  notes: String,
}, {
  timestamps: true,
});

export default mongoose.models.MedicalRecord || mongoose.model('MedicalRecord', medicalRecordSchema);

================
File: src/models/Patient.ts
================
import mongoose from 'mongoose';

const patientSchema = new mongoose.Schema({
  patientId: {
    type: String,
    unique: true,
    required: true,
  },
  firstName: {
    type: String,
    required: true,
  },
  lastName: {
    type: String,
    required: true,
  },
  email: String,
  phone: {
    type: String,
    required: true,
  },
  dateOfBirth: {
    type: Date,
    required: true,
  },
  gender: {
    type: String,
    enum: ['male', 'female', 'other'],
    required: true,
  },
  address: {
    street: String,
    city: String,
    state: String,
    zipCode: String,
    country: String,
  },
  emergencyContact: {
    name: String,
    relationship: String,
    phone: String,
  },
  insurance: {
    provider: String,
    policyNumber: String,
    groupNumber: String,
  },
  medicalHistory: [{
    condition: String,
    diagnosedDate: Date,
    notes: String,
  }],
  allergies: [{
    allergen: String,
    severity: {
      type: String,
      enum: ['mild', 'moderate', 'severe'],
    },
    notes: String,
  }],
  medications: [{
    name: String,
    dosage: String,
    frequency: String,
    startDate: Date,
    endDate: Date,
    prescribedBy: String,
    remainingDays: Number, // å‰©ä½™ç”¨è¯å¤©æ•°
  }],
  // æ–°å¢å­—æ®µ
  patientType: {
    type: String,
    enum: ['regular', 'vip', 'emergency'],
    default: 'regular',
  },
  lastVisitDate: Date,
  nextFollowUpDate: Date, // ä¸‹æ¬¡å›è®¿æ—¥æœŸ
  assignedDoctor: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
  },
  notes: String, // ç‰¹æ®Šå¤‡æ³¨
  priority: {
    type: String,
    enum: ['low', 'medium', 'high', 'urgent'],
    default: 'medium',
  },
  status: {
    type: String,
    enum: ['active', 'inactive', 'discharged', 'deceased'],
    default: 'active',
  },
  isActive: {
    type: Boolean,
    default: true,
  },
}, {
  timestamps: true,
});

// æ·»åŠ ç´¢å¼•
patientSchema.index({ patientId: 1 });
patientSchema.index({ email: 1 });
patientSchema.index({ phone: 1 });
patientSchema.index({ nextFollowUpDate: 1 });
patientSchema.index({ lastVisitDate: 1 });
patientSchema.index({ assignedDoctor: 1 });

export default mongoose.models.Patient || mongoose.model('Patient', patientSchema);

================
File: src/models/Product.ts
================
import mongoose from 'mongoose';

const productSchema = new mongoose.Schema({
  productCode: {
    type: String,
    unique: true,
    required: true,
  },
  productName: {
    type: String,
    required: true,
  },
  category: {
    type: String,
    enum: [
      'vitamins', // ç»´ç”Ÿç´ 
      'minerals', // çŸ¿ç‰©è´¨
      'antioxidants', // æŠ—æ°§åŒ–å‰‚
      'omega', // æ¬§ç±³ä¼½
      'probiotics', // ç›Šç”ŸèŒ
      'protein', // è›‹ç™½è´¨
      'weight_management', // ä½“é‡ç®¡ç†
      'skincare', // æŠ¤è‚¤å“
      'energy_metabolism', // èƒ½é‡ä»£è°¢
      'immune_support', // å…ç–«æ”¯æŒ
      'heart_health', // å¿ƒè„å¥åº·
      'bone_joint', // éª¨éª¼å…³èŠ‚
      'digestive_health', // æ¶ˆåŒ–å¥åº·
      'brain_cognitive', // å¤§è„‘è®¤çŸ¥
      'womens_health', // å¥³æ€§å¥åº·
      'mens_health', // ç”·æ€§å¥åº·
      'childrens_health', // å„¿ç«¥å¥åº·
    ],
    required: true,
  },
  
  // äº§å“è¯¦æƒ…
  description: String,
  ingredients: [String], // æˆåˆ†åˆ—è¡¨
  servingSize: String, // æœç”¨å‰‚é‡
  servingsPerContainer: Number, // æ¯ç“¶ä»½æ•°
  
  // é€‚ç”¨äººç¾¤
  targetAudience: {
    ageGroups: [String], // å¹´é¾„ç»„
    genders: [String], // æ€§åˆ«
    healthGoals: [String], // å¥åº·ç›®æ ‡
    lifestyles: [String], // ç”Ÿæ´»æ–¹å¼
  },
  
  // åŠŸæ•ˆå’Œå¥½å¤„
  benefits: [String],
  healthConcerns: [String], // é’ˆå¯¹çš„å¥åº·é—®é¢˜
  
  // ä½¿ç”¨æŒ‡å¯¼
  recommendedDosage: String,
  usageInstructions: String,
  precautions: [String], // æ³¨æ„äº‹é¡¹
  contraindications: [String], // ç¦å¿Œç—‡
  
  // ä»·æ ¼ä¿¡æ¯
  retailPrice: Number,
  wholesalePrice: Number,
  preferredCustomerPrice: Number,
  points: Number, // ç§¯åˆ†å€¼
  
  // åº“å­˜çŠ¶æ€
  stockStatus: {
    type: String,
    enum: ['in_stock', 'low_stock', 'out_of_stock', 'discontinued'],
    default: 'in_stock',
  },
  
  // æ¨èæ­é…
  recommendedCombinations: [{
    productCode: String,
    productName: String,
    reason: String, // æ­é…ç†ç”±
  }],
  
  // é”€å”®æ•°æ®
  popularity: {
    type: Number,
    default: 0, // å—æ¬¢è¿ç¨‹åº¦è¯„åˆ†
  },
  
  isActive: {
    type: Boolean,
    default: true,
  },
}, {
  timestamps: true,
});

// æ·»åŠ ç´¢å¼•
productSchema.index({ productCode: 1 });
productSchema.index({ category: 1 });
productSchema.index({ stockStatus: 1 });
productSchema.index({ popularity: -1 });

export default mongoose.models.Product || mongoose.model('Product', productSchema);

================
File: src/models/User.ts
================
import mongoose from 'mongoose';

const userSchema = new mongoose.Schema({
  employeeId: {
    type: String,
    unique: true,
  },
  name: {
    type: String,
    required: true,
  },
  email: {
    type: String,
    required: true,
    unique: true,
  },
  password: {
    type: String,
    required: true,
  },
  role: {
    type: String,
    enum: ['system_admin', 'admin', 'customer'],
    default: 'customer',
  },
  phone: String,
  
  // é”€å”®ç›¸å…³ä¿¡æ¯
  salesInfo: {
    territory: String, // é”€å”®åŒºåŸŸ
    teamLead: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
    },
    commissionRate: Number, // ä½£é‡‘æ¯”ä¾‹
    salesGoal: {
      monthly: Number,
      quarterly: Number,
      annual: Number,
    },
    certification: {
      level: String, // è®¤è¯çº§åˆ«
      expiryDate: Date,
    },
  },
  
  // ä¸šç»©ç»Ÿè®¡
  performance: {
    currentMonth: {
      sales: Number,
      customers: Number,
      orders: Number,
    },
    currentQuarter: {
      sales: Number,
      customers: Number,
      orders: Number,
    },
    currentYear: {
      sales: Number,
      customers: Number,
      orders: Number,
    },
  },
  
  // å®¢æˆ·ç®¡ç†æƒé™
  customerAccess: {
    canViewAll: Boolean,
    assignedTerritories: [String],
    customerLimit: Number,
  },
  
  avatar: String,
  isActive: {
    type: Boolean,
    default: true,
  },
  lastLogin: Date,
}, {
  timestamps: true,
});

// ç”Ÿæˆå‘˜å·¥ID
userSchema.pre('save', async function(next) {
  if (!this.employeeId) {
    const lastUser = await this.constructor.findOne({}, {}, { sort: { 'createdAt': -1 } });
    let employeeNumber = 1;
    
    if (lastUser && lastUser.employeeId) {
      const lastNumber = parseInt(lastUser.employeeId.replace('EMP', ''));
      employeeNumber = lastNumber + 1;
    }
    
    this.employeeId = `EMP${employeeNumber.toString().padStart(3, '0')}`;
  }
  next();
});

export default mongoose.models.User || mongoose.model('User', userSchema);

================
File: start.bat
================
@echo off
echo ğŸ¥ Health CRM å¯åŠ¨è„šæœ¬
echo =======================

echo.
echo ğŸ”¥ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...
echo ğŸŒ æ­£åœ¨è®¿é—®: http://localhost:3000
echo.
echo ğŸ‘¤ æµ‹è¯•è´¦æˆ·ä¿¡æ¯:
echo --------------------------------
echo ç®¡ç†å‘˜: admin@healthcrm.com / admin123
echo åŒ»ç”Ÿ: dr.johnson@healthcrm.com / doctor123  
echo æŠ¤å£«: nurse.wong@healthcrm.com / nurse123
echo å‰å°: receptionist@healthcrm.com / reception123
echo --------------------------------
echo.
echo ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
echo.

call npm run dev

================
File: tailwind.config.js
================
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
        },
      },
    },
  },
  plugins: [require('@tailwindcss/forms')],
}

================
File: test-guide.bat
================
@echo off
echo ğŸ§ª Health CRM åŠŸèƒ½æµ‹è¯•æŒ‡å—
echo =====================================

echo.
echo ğŸ” ç™»å½•æµ‹è¯•è´¦æˆ·:
echo ç®¡ç†å‘˜: admin@healthcrm.com / 123456
echo åŒ»ç”Ÿ: dr.johnson@healthcrm.com / 123456
echo.
echo ğŸ¯ åŠŸèƒ½æµ‹è¯•æ¸…å•:
echo.
echo ã€æ‚£è€…ç®¡ç†ã€‘
echo âœ“ æŸ¥çœ‹æ‚£è€…åˆ—è¡¨ (æ”¯æŒåˆ†é¡µã€æœç´¢ã€æ’åº)
echo âœ“ é«˜çº§è¿‡æ»¤ (ç±»å‹ã€ä¼˜å…ˆçº§ã€çŠ¶æ€ã€åŒ»ç”Ÿ)
echo âœ“ åˆ†ç±»æŸ¥çœ‹ (å…¨éƒ¨ã€éœ€å›è®¿ã€è¯ç‰©ä¸è¶³ã€ç´§æ€¥)
echo âœ“ æ–°å¢æ‚£è€… (å®Œæ•´è¡¨å•éªŒè¯)
echo âœ“ ç¼–è¾‘æ‚£è€…ä¿¡æ¯
echo âœ“ åˆ é™¤æ‚£è€… (æƒé™æ§åˆ¶)
echo.
echo ã€ç”¨æˆ·ç®¡ç†ã€‘(ä»…ç®¡ç†å‘˜å¯è§)
echo âœ“ æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ (åˆ†è§’è‰²tabæŸ¥çœ‹)
echo âœ“ æŒ‰éƒ¨é—¨è¿‡æ»¤
echo âœ“ æ’åºåŠŸèƒ½
echo âœ“ æƒé™æ§åˆ¶ (ç®¡ç†å‘˜å¯¹ç³»ç»Ÿç®¡ç†å‘˜åªè¯»)
echo.
echo ã€é‡è¦æé†’åŠŸèƒ½ã€‘
echo âœ“ å›è®¿æ—¥æœŸæé†’ (çº¢è‰²è­¦å‘Šå›¾æ ‡)
echo âœ“ è¯ç‰©ä¸è¶³æé†’ (æ©™è‰²è­¦å‘Š)
echo âœ“ ç´§æ€¥æ‚£è€…æ ‡è¯†
echo.
echo ã€æ•°æ®åº“æµ‹è¯•æ•°æ®ã€‘
echo âœ“ 5ä¸ªç”¨æˆ· (ä¸åŒè§’è‰²)
echo âœ“ 5ä¸ªæ‚£è€… (åŒ…å«ä¸­æ–‡å§“å)
echo âœ“ åŒ…å«å„ç§ä¼˜å…ˆçº§å’ŒçŠ¶æ€
echo âœ“ æ¨¡æ‹ŸçœŸå®çš„åŒ»ç–—åœºæ™¯
echo.
echo ğŸš€ å¼€å§‹æµ‹è¯•: npm run dev
echo ğŸŒ è®¿é—®åœ°å€: http://localhost:3000
echo.
pause

================
File: tsconfig.json
================
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
